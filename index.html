<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Ninja Town RPG</title>
<style>
  html,body{
    margin:0;width:100%;height:100%;overflow:hidden;background:#0f0f12;
    font-family:system-ui,-apple-system,Segoe UI,Roboto;
    touch-action:manipulation;
    -webkit-user-select:none;user-select:none;
  }
  :root{
    --pad-top: env(safe-area-inset-top);
    --pad-right: env(safe-area-inset-right);
    --pad-bottom: env(safe-area-inset-bottom);
    --pad-left: env(safe-area-inset-left);
    --wood1:#a56a3c; --wood2:#7a4b2a; --ink:#22140b; --accent:#ff7a18;
  }
  *{-webkit-tap-highlight-color:transparent}
  .hidden{display:none!important}

  /* ===== Top bar ===== */
  #topbar{
    position:absolute; z-index:50;
    left:calc(10px + var(--pad-left));
    right:calc(10px + var(--pad-right));
    top:calc(10px + var(--pad-top));
    display:flex;gap:10px;align-items:center;justify-content:space-between;
    background:linear-gradient(var(--wood1),var(--wood2));
    border:2px solid rgba(0,0,0,.18);
    border-radius:14px;padding:10px 12px;
    box-shadow:0 10px 24px rgba(0,0,0,.25);
    color:var(--ink);
  }
  .barL,.barR{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .chip{
    display:flex;gap:8px;align-items:center;
    background:rgba(255,255,255,.25);
    border:1px solid rgba(0,0,0,.14);
    border-radius:999px;padding:6px 10px;
    font-weight:950;font-size:12px;
  }
  .chip b{font-family:ui-monospace,Menlo,monospace}
  .btn{
    border:0;border-radius:12px;padding:10px 12px;font-weight:950;
    background:#eee;color:#111; box-shadow:0 6px 14px rgba(0,0,0,.18);
  }
  .btn.primary{background:var(--accent)}
  .btn.ghost{background:rgba(255,255,255,.25); border:1px solid rgba(0,0,0,.14);}
  .btn.small{padding:8px 10px;font-size:12px;border-radius:11px}
  .btn:disabled{opacity:.55}

  /* ===== Town ===== */
  #town{
    position:absolute; inset:0;
    padding-top:calc(64px + var(--pad-top));
  }
  #townBg{
    position:absolute; inset:0;
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
    filter:saturate(1.02) contrast(1.01);
  }

  /* Invisible hit areas (NO rectangles) */
  .hotspot{
    position:absolute;
    background:transparent;
    border:0;
    border-radius:18px;
    padding:0;
    z-index:10;
    touch-action:manipulation;
  }
  /* Optional debug (set DEBUG_HOTSPOTS=true in JS) */
  .hotspot.debug{
    background:rgba(255,255,255,.12);
    outline:2px solid rgba(255,255,255,.22);
    backdrop-filter: blur(2px);
  }

  /* Tuned for iPhone layout */
  #hsDaimyo   { left:  4%; top: 14%; width: 28%; height: 22%; }
  #hsHospital { left: 30%; top: 24%; width: 26%; height: 20%; }
  #hsRelic    { left: 54%; top: 18%; width: 28%; height: 22%; }
  #hsWeapon   { left: 70%; top: 34%; width: 28%; height: 22%; }
  #hsRecruit  { left:  8%; top: 52%; width: 34%; height: 24%; }
  #hsDojo     { left: 40%; top: 58%; width: 30%; height: 22%; }
  #hsFight    { left: 70%; top: 74%; width: 28%; height: 24%; }

  /* ===== Modals ===== */
  .modal{
    position:absolute; inset:0; z-index:80;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.35);
    padding:14px;
  }
  .card{
    width:min(680px,96%);
    background:linear-gradient(#f7edd6,#f0e0bf);
    border:2px solid rgba(0,0,0,.18);
    border-radius:18px;
    padding:14px;
    box-shadow:0 20px 50px rgba(0,0,0,.28);
    color:#23140b;
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .sp{justify-content:space-between}
  .title{margin:0;font-size:16px;font-weight:1000}
  .muted{opacity:.78;font-size:12px;line-height:1.25}
  .statGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .stat{
    background:rgba(255,255,255,.35);
    border:1px solid rgba(0,0,0,.12);
    border-radius:14px;
    padding:10px 12px;
    font-size:12px;
  }
  .stat b{font-family:ui-monospace,Menlo,monospace;font-size:13px}
  .list{
    margin-top:10px; max-height:320px; overflow:auto;
    border-radius:14px; border:1px solid rgba(0,0,0,.14);
    background:rgba(255,255,255,.22);
  }
  .item{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.10);
    font-size:12px;
  }
  .item:last-child{border-bottom:0}
  .pill{
    display:inline-block;
    padding:4px 8px;border-radius:999px;
    background:rgba(255,255,255,.55);
    border:1px solid rgba(0,0,0,.10);
    font-size:11px;font-weight:950;
  }
  .rar{font-weight:1000}
  .rar.Common{color:#555}
  .rar.Uncommon{color:#0d7a1c}
  .rar.Rare{color:#1a63c8}
  .rar.Epic{color:#7a2ac9}
  .rar.Legendary{color:#b06b00}

  /* ===== Battle ===== */
  #battle{ position:absolute; inset:0; z-index:60; }
  #battleBg{
    position:absolute; inset:0;
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
    transform:scale(1.02);
  }
  #battleCanvas{position:absolute; inset:0; width:100%; height:100%}
  #battleTop{
    position:absolute; z-index:70;
    left:calc(10px + var(--pad-left));
    right:calc(10px + var(--pad-right));
    top:calc(10px + var(--pad-top));
    display:flex;gap:10px;align-items:center;justify-content:space-between;
  }
  .hpBox{
    flex:1 1 0;
    background:linear-gradient(var(--wood1),var(--wood2));
    border:2px solid rgba(0,0,0,.18);
    border-radius:14px;
    padding:10px 12px;
    box-shadow:0 10px 24px rgba(0,0,0,.22);
    color:var(--ink);
    min-width:0;
  }
  .hpName{font-weight:1000;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .hpBar{height:12px;border-radius:999px;background:rgba(0,0,0,.18);overflow:hidden;margin-top:6px;border:1px solid rgba(0,0,0,.12);}
  .hpFill{height:100%; width:100%; background:linear-gradient(#ffb845,#ff7a18);}
  .vs{font-weight:1000;font-size:22px;color:#fff;text-shadow:0 4px 10px rgba(0,0,0,.35);padding:0 10px}
  #skipBtn{
    position:absolute; z-index:70;
    top:calc(78px + var(--pad-top));
    left:50%; transform:translateX(-50%);
    background:rgba(255,255,255,.75);
    border:2px solid rgba(0,0,0,.18);
    border-radius:12px; padding:10px 14px; font-weight:1000;
  }
</style>
</head>

<body>
  <div id="topbar">
    <div class="barL">
      <div class="chip">Build <b>v4-ACTIONS</b></div>
      <div class="chip">Active <b id="uiName">â€”</b></div>
      <div class="chip">HP <b id="uiHP">â€”</b></div>
      <div class="chip">â˜¯ <b id="uiKarma">0</b></div>
      <div class="chip">ðŸª™ <b id="uiGold">0</b></div>
      <div class="chip">Belt <b id="uiBelt">White</b></div>
      <div class="chip">Tier <b id="uiTier">1</b></div>
    </div>
    <div class="barR">
      <button class="btn ghost small" id="saveBtn">Save</button>
      <button class="btn ghost small" id="resetBtn">Reset</button>
    </div>
  </div>

  <!-- Town -->
  <div id="town">
    <div id="townBg"></div>

    <!-- Invisible building hit-zones -->
    <button class="hotspot" id="hsDaimyo"   aria-label="Daimyo"></button>
    <button class="hotspot" id="hsHospital" aria-label="Hospital"></button>
    <button class="hotspot" id="hsRelic"    aria-label="Relic Shop"></button>
    <button class="hotspot" id="hsWeapon"   aria-label="Weapon Shop"></button>
    <button class="hotspot" id="hsRecruit"  aria-label="Recruit"></button>
    <button class="hotspot" id="hsDojo"     aria-label="Dojo"></button>
    <button class="hotspot" id="hsFight"    aria-label="Fight"></button>
  </div>

  <!-- Battle -->
  <div id="battle" class="hidden">
    <div id="battleBg"></div>
    <canvas id="battleCanvas"></canvas>

    <div id="battleTop">
      <div class="hpBox">
        <div class="hpName" id="pName">You</div>
        <div class="hpBar"><div class="hpFill" id="pHPFill"></div></div>
      </div>
      <div class="vs">VS</div>
      <div class="hpBox">
        <div class="hpName" id="eName">Enemy</div>
        <div class="hpBar"><div class="hpFill" id="eHPFill"></div></div>
      </div>
    </div>

    <button id="skipBtn" class="btn">SKIP</button>
  </div>

  <!-- Dojo -->
  <div class="modal hidden" id="dojoModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Dojo Training</h3>
        <button class="btn ghost small" id="closeDojo">Close</button>
      </div>
      <div class="muted">Train your active ninja in 3 stats. No skills/specials.</div>

      <div class="statGrid">
        <div class="stat">Strength<br><b id="stSTR">1</b><div class="muted">Damage</div></div>
        <div class="stat">Agility<br><b id="stAGI">1</b><div class="muted">Speed / Dodge</div></div>
        <div class="stat">Endurance<br><b id="stEND">1</b><div class="muted">HP / Defense</div></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="trainSTR">+ STR (1 TP)</button>
        <button class="btn primary" id="trainAGI">+ AGI (1 TP)</button>
        <button class="btn primary" id="trainEND">+ END (1 TP)</button>
      </div>

      <div class="muted" style="margin-top:10px">
        TP: <b id="tpHere">0</b> â€¢ Active: <b id="activeHere">â€”</b>
      </div>
    </div>
  </div>

  <!-- Daimyo -->
  <div class="modal hidden" id="daiModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Daimyo</h3>
        <button class="btn ghost small" id="closeDai">Close</button>
      </div>
      <div class="muted">Belts are earned by XP (from fights). Winning increases Tier.</div>

      <div class="statGrid">
        <div class="stat">Belt<br><b id="dBelt">White</b></div>
        <div class="stat">XP<br><b id="dXP">0</b></div>
        <div class="stat">Next Belt XP<br><b id="dNext">50</b></div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="stat">Tier<br><b id="dTier">1</b><div class="muted">Win 3 fights to tier up</div></div>
        <div class="stat">Wins<br><b id="dWins">0</b></div>
        <div class="stat">Losses<br><b id="dLosses">0</b></div>
      </div>
    </div>
  </div>

  <!-- Recruit -->
  <div class="modal hidden" id="recruitModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Recruit Ninjas</h3>
        <button class="btn ghost small" id="closeRecruit">Close</button>
      </div>
      <div class="muted" id="recruitLockText"></div>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="recruitBtn">Recruit (ðŸª™ <span id="recruitCost">120</span>)</button>
        <button class="btn ghost" id="setActiveBtn">Set Selected Active</button>
      </div>

      <div class="list" id="rosterList"></div>
      <div class="muted" style="margin-top:10px">Recruit unlocks at <b>Yellow belt</b>.</div>
    </div>
  </div>

  <!-- Weapon -->
  <div class="modal hidden" id="weaponModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Weapon Shop</h3>
        <button class="btn ghost small" id="closeWeapon">Close</button>
      </div>
      <div class="muted">Buy with ðŸª™ Gold. Equip 1 weapon on the active ninja.</div>

      <div class="row" style="margin-top:10px">
        <button class="btn ghost" id="buyWeaponBtn">Buy Selected</button>
        <button class="btn primary" id="equipWeaponBtn">Equip Selected</button>
      </div>

      <div class="list" id="weaponList"></div>
    </div>
  </div>

  <!-- Relic -->
  <div class="modal hidden" id="relicModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Relic Shop</h3>
        <button class="btn ghost small" id="closeRelic">Close</button>
      </div>
      <div class="muted">Buy with â˜¯ Karma. Equip 1 relic on the active ninja.</div>

      <div class="row" style="margin-top:10px">
        <button class="btn ghost" id="buyRelicBtn">Buy Selected</button>
        <button class="btn primary" id="equipRelicBtn">Equip Selected</button>
      </div>

      <div class="list" id="relicList"></div>
    </div>
  </div>

<script>
/* =========================
   Embedded images (no extra files)
========================= */
const TOWN_B64 =
/* town.jpg base64 */ `
{{TOWN_B64}}
`.trim();

const BATTLE_B64 =
/* battle.jpg base64 */ `
{{BATTLE_B64}}
`.trim();

document.getElementById("townBg").style.backgroundImage =
  "url('data:image/jpeg;base64," + TOWN_B64 + "')";
document.getElementById("battleBg").style.backgroundImage =
  "url('data:image/jpeg;base64," + BATTLE_B64 + "')";

/* =========================
   OPTIONAL debug hitzones
========================= */
const DEBUG_HOTSPOTS = false;
if (DEBUG_HOTSPOTS){
  document.querySelectorAll(".hotspot").forEach(h=>h.classList.add("debug"));
}

/* =========================
   Game logic (real actions)
========================= */
const SAVE_KEY="ninja_town_rpg_v4_actions_embed";
const $ = (id)=>document.getElementById(id);
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function rand(a,b){ return a + Math.random()*(b-a); }
function rint(a,b){ return Math.floor(rand(a,b+1)); }
function pick(a){ return a[Math.floor(Math.random()*a.length)]; }
function id(prefix="id"){ return prefix+"_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16); }

const BELTS=["White","Yellow","Orange","Green","Blue","Brown","Black"];
const BELT_XP=[0,50,150,350,700,1200,2000];
function beltFromXP(xp){ let idx=0; for(let i=0;i<BELT_XP.length;i++) if(xp>=BELT_XP[i]) idx=i; return BELTS[Math.min(idx,BELTS.length-1)]; }
function nextBeltXP(xp){ for(let i=1;i<BELT_XP.length;i++) if(xp < BELT_XP[i]) return BELT_XP[i]; return BELT_XP[BELT_XP.length-1]; }
function beltIndex(b){ return Math.max(0, BELTS.indexOf(b)); }

const RARITIES=["Common","Uncommon","Rare","Epic","Legendary"];
const RARITY_MULT={Common:1.0,Uncommon:1.12,Rare:1.28,Epic:1.45,Legendary:1.65};
function rollRarity(tier){
  const r=Math.random();
  const boost=Math.min(0.18, tier*0.015);
  if(r < 0.03 + boost*0.25) return "Legendary";
  if(r < 0.08 + boost*0.40) return "Epic";
  if(r < 0.20 + boost*0.60) return "Rare";
  if(r < 0.50 + boost*0.75) return "Uncommon";
  return "Common";
}
function makeWeapon(rarity){
  const mult=RARITY_MULT[rarity]||1.0;
  const name=pick(["Katana","Tanto","Naginata","War Fan","Iron Staff","Moon Blade","Storm Edge"]);
  const bonus={ str:Math.max(0,Math.round(1*mult+rand(0,1.2))),
                agi:Math.max(0,Math.round(0.8*mult+rand(0,1.0))),
                end:Math.max(0,Math.round(0.3*mult+rand(0,0.8))) };
  const cost=Math.round((60 + 25*RARITIES.indexOf(rarity))*mult);
  return {id:id("w"), type:"weapon", rarity, name, bonus, cost};
}
function makeRelic(rarity){
  const mult=RARITY_MULT[rarity]||1.0;
  const name=pick(["Karma Bead","Smoke Ring","Focus Charm","Phoenix Feather","Shadow Seal","Lotus Medallion"]);
  const bonus={ str:Math.max(0,Math.round(0.4*mult+rand(0,0.8))),
                agi:Math.max(0,Math.round(1.0*mult+rand(0,1.1))),
                end:Math.max(0,Math.round(1.2*mult+rand(0,1.2))) };
  const cost=Math.round((35 + 20*RARITIES.indexOf(rarity))*mult);
  return {id:id("r"), type:"relic", rarity, name, bonus, cost};
}
function makeNinja(name=null){
  const first=["Ryu","Hana","Jin","Kira","Sora","Mako","Taro","Yumi","Akio","Ren","Aya","Kai","Noa","Rin"];
  const last=["Shadow","Steel","Blaze","Mist","Fang","Lotus","Night","Storm","Viper","Drift"];
  const nm = name || `${pick(first)} ${pick(last)}`;
  return { id:id("n"), name:nm, xp:0, level:1, tp:0,
    base:{str:1,agi:1,end:1},
    equip:{weaponId:null,relicId:null},
    hp:70, maxHP:70
  };
}

function defaultSave(){
  const starter=makeNinja("Andy Holloway");
  return {
    currency:{ karma:0, gold:120 },
    ladder:{ tier:1, wins:0, losses:0, winsThisTier:0 },
    ninjas:[starter],
    activeNinjaId: starter.id,
    inventory:{ weapons:[], relics:[] },
    shop:{ weapons:[], relics:[] }
  };
}
let save = load();
function load(){
  try{
    const raw=localStorage.getItem(SAVE_KEY);
    if(!raw) return defaultSave();
    const s=JSON.parse(raw);
    if(!s?.ninjas?.length) return defaultSave();
    s.currency ??= {karma:0,gold:0};
    s.ladder ??= {tier:1,wins:0,losses:0,winsThisTier:0};
    s.inventory ??= {weapons:[],relics:[]};
    s.shop ??= {weapons:[],relics:[]};
    s.activeNinjaId ??= s.ninjas[0].id;
    for(const n of s.ninjas){
      n.base ??= {str:1,agi:1,end:1};
      n.equip ??= {weaponId:null,relicId:null};
      n.xp ??= 0; n.tp ??= 0;
      recalcNinja(s,n);
      n.hp = clamp(n.hp ?? n.maxHP, 1, n.maxHP);
    }
    return s;
  }catch{ return defaultSave(); }
}
function persist(){ localStorage.setItem(SAVE_KEY, JSON.stringify(save)); }

function invWeaponById(i){ return save.inventory.weapons.find(x=>x.id===i) || null; }
function invRelicById(i){ return save.inventory.relics.find(x=>x.id===i) || null; }
function findNinja(nid){ return save.ninjas.find(n=>n.id===nid) || save.ninjas[0]; }
function activeNinja(){ return findNinja(save.activeNinjaId); }
function getEquipBonus(n){
  const w = n.equip.weaponId ? invWeaponById(n.equip.weaponId) : null;
  const r = n.equip.relicId ? invRelicById(n.equip.relicId) : null;
  return {
    str:(w?.bonus?.str||0) + (r?.bonus?.str||0),
    agi:(w?.bonus?.agi||0) + (r?.bonus?.agi||0),
    end:(w?.bonus?.end||0) + (r?.bonus?.end||0),
  };
}
function recalcNinja(s,n){
  n.level = 1 + Math.floor((n.xp||0)/100);
  const bonus=getEquipBonus(n);
  const STR=n.base.str + bonus.str;
  const AGI=n.base.agi + bonus.agi;
  const END=n.base.end + bonus.end;
  n.maxHP = 55 + END*12 + n.level*6;
  n.hp = clamp(n.hp ?? n.maxHP, 1, n.maxHP);
  n._derived = {
    STR,AGI,END,
    atk: Math.max(2, Math.floor(6 + STR*3 + n.level*1.6)),
    spd: 1.0 + AGI*0.12,
    dodge: clamp(0.03 + AGI*0.015, 0.03, 0.28),
    def: Math.floor(END*0.9 + n.level*0.6),
  };
}
function belt(){ return beltFromXP(activeNinja().xp); }

/* UI */
function openModal(id){ $(id).classList.remove("hidden"); }
function closeModal(id){ $(id).classList.add("hidden"); }

function refreshTop(){
  for(const n of save.ninjas) recalcNinja(save,n);
  const a=activeNinja();
  $("uiName").textContent = a.name;
  $("uiHP").textContent = `${a.hp}/${a.maxHP}`;
  $("uiKarma").textContent = save.currency.karma;
  $("uiGold").textContent = save.currency.gold;
  $("uiBelt").textContent = belt();
  $("uiTier").textContent = save.ladder.tier;
}
$("saveBtn").onclick=()=>{ persist(); refreshTop(); };
$("resetBtn").onclick=()=>{
  localStorage.removeItem(SAVE_KEY);
  save = defaultSave();
  save.shop.weapons=[]; save.shop.relics=[];
  persist(); refreshTop();
};

/* Dojo */
function renderDojo(){
  const a=activeNinja(); recalcNinja(save,a);
  const b=getEquipBonus(a);
  $("activeHere").textContent=a.name;
  $("tpHere").textContent=a.tp;
  $("stSTR").textContent=`${a.base.str}${b.str?` (+${b.str})`:""}`;
  $("stAGI").textContent=`${a.base.agi}${b.agi?` (+${b.agi})`:""}`;
  $("stEND").textContent=`${a.base.end}${b.end?` (+${b.end})`:""}`;
  const can=a.tp>0;
  $("trainSTR").disabled=!can;
  $("trainAGI").disabled=!can;
  $("trainEND").disabled=!can;
}
function spendTP(stat){
  const a=activeNinja();
  if(a.tp<=0) return;
  a.tp -= 1;
  a.base[stat] += 1;
  recalcNinja(save,a);
  persist(); refreshTop(); renderDojo();
}
$("trainSTR").onclick=()=>spendTP("str");
$("trainAGI").onclick=()=>spendTP("agi");
$("trainEND").onclick=()=>spendTP("end");
$("closeDojo").onclick=()=>closeModal("dojoModal");

/* Daimyo */
function renderDaimyo(){
  const a=activeNinja();
  $("dBelt").textContent=belt();
  $("dXP").textContent=a.xp;
  $("dNext").textContent=nextBeltXP(a.xp);
  $("dTier").textContent=save.ladder.tier;
  $("dWins").textContent=save.ladder.wins;
  $("dLosses").textContent=save.ladder.losses;
}
$("closeDai").onclick=()=>closeModal("daiModal");

/* Recruit */
let rosterSelectedId=null;
function recruitCost(){ return 120 + (save.ninjas.length-1)*90 + (save.ladder.tier-1)*25; }
function renderRoster(){
  const locked = beltIndex(belt()) < beltIndex("Yellow");
  $("recruitLockText").innerHTML = locked
    ? `Recruit unlocks at <b>Yellow</b> belt. Win fights to rank up.`
    : `Recruit new ninjas and switch your active fighter.`;

  const cost=recruitCost();
  $("recruitCost").textContent=cost;
  $("recruitBtn").disabled = locked || save.currency.gold < cost;

  const list=$("rosterList");
  list.innerHTML="";
  for(const n of save.ninjas){
    recalcNinja(save,n);
    const isActive = n.id===save.activeNinjaId;
    const selected = n.id===rosterSelectedId;
    const row=document.createElement("div");
    row.className="item";
    row.style.background = selected ? "rgba(255,255,255,.35)" : "";
    row.innerHTML=`
      <div style="min-width:0">
        <div style="font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
          ${n.name} <span class="pill">Lv${n.level}</span> ${isActive?`<span class="pill">ACTIVE</span>`:""}
        </div>
        <div class="muted">STR ${n._derived.STR} â€¢ AGI ${n._derived.AGI} â€¢ END ${n._derived.END} â€¢ HP ${n.hp}/${n.maxHP}</div>
      </div>
      <button class="btn small ghost" data-sel="${n.id}">${selected?"Selected":"Select"}</button>
    `;
    list.appendChild(row);
  }
  list.querySelectorAll("button[data-sel]").forEach(btn=>{
    btn.onclick=()=>{ rosterSelectedId=btn.getAttribute("data-sel"); renderRoster(); };
  });
  $("setActiveBtn").disabled = !rosterSelectedId;
}
$("recruitBtn").onclick=()=>{
  if(beltIndex(belt()) < beltIndex("Yellow")) return;
  const cost=recruitCost();
  if(save.currency.gold < cost) return;
  save.currency.gold -= cost;
  const n=makeNinja();
  n.base.str = 1 + Math.floor((save.ladder.tier-1)*0.3);
  n.base.agi = 1 + Math.floor((save.ladder.tier-1)*0.3);
  n.base.end = 1 + Math.floor((save.ladder.tier-1)*0.3);
  n.xp = Math.max(0, activeNinja().xp - 80);
  recalcNinja(save,n);
  save.ninjas.push(n);
  rosterSelectedId=n.id;
  persist(); refreshTop(); renderRoster();
};
$("setActiveBtn").onclick=()=>{
  if(!rosterSelectedId) return;
  save.activeNinjaId=rosterSelectedId;
  persist(); refreshTop(); renderRoster();
};
$("closeRecruit").onclick=()=>closeModal("recruitModal");

/* Weapon Shop */
let weaponSelectedId=null;
function renderWeaponShop(){
  if(!save.shop.weapons?.length){
    save.shop.weapons = Array.from({length:6}, ()=>makeWeapon(rollRarity(save.ladder.tier)));
  }
  const list=$("weaponList"); list.innerHTML="";
  for(const w of save.shop.weapons){
    const selected = w.id===weaponSelectedId;
    const owned = save.inventory.weapons.some(x=>x.id===w.id);
    const row=document.createElement("div");
    row.className="item";
    row.style.background = selected ? "rgba(255,255,255,.35)" : "";
    row.innerHTML=`
      <div style="min-width:0">
        <div style="font-weight:1000">
          ${w.name} <span class="pill rar ${w.rarity}">${w.rarity}</span>
          <span class="pill">ðŸª™ ${w.cost}</span> ${owned?`<span class="pill">OWNED</span>`:""}
        </div>
        <div class="muted">+STR ${w.bonus.str} â€¢ +AGI ${w.bonus.agi} â€¢ +END ${w.bonus.end}</div>
      </div>
      <button class="btn small ghost" data-wsel="${w.id}">${selected?"Selected":"Select"}</button>
    `;
    list.appendChild(row);
  }
  list.querySelectorAll("button[data-wsel]").forEach(b=>{
    b.onclick=()=>{ weaponSelectedId=b.getAttribute("data-wsel"); renderWeaponShop(); };
  });

  const sel = save.shop.weapons.find(x=>x.id===weaponSelectedId) || null;
  $("buyWeaponBtn").disabled = !sel || save.currency.gold < sel.cost || save.inventory.weapons.some(x=>x.id===sel.id);
  $("equipWeaponBtn").disabled = !sel || !save.inventory.weapons.some(x=>x.id===sel.id);
}
$("buyWeaponBtn").onclick=()=>{
  const sel = save.shop.weapons.find(x=>x.id===weaponSelectedId) || null;
  if(!sel) return;
  if(save.currency.gold < sel.cost) return;
  if(save.inventory.weapons.some(x=>x.id===sel.id)) return;
  save.currency.gold -= sel.cost;
  save.inventory.weapons.push(sel);
  persist(); refreshTop(); renderWeaponShop();
};
$("equipWeaponBtn").onclick=()=>{
  const sel = save.shop.weapons.find(x=>x.id===weaponSelectedId) || null;
  if(!sel) return;
  if(!save.inventory.weapons.some(x=>x.id===sel.id)) return;
  const a=activeNinja();
  a.equip.weaponId=sel.id;
  recalcNinja(save,a);
  persist(); refreshTop(); renderWeaponShop();
};
$("closeWeapon").onclick=()=>closeModal("weaponModal");

/* Relic Shop */
let relicSelectedId=null;
function renderRelicShop(){
  if(!save.shop.relics?.length){
    save.shop.relics = Array.from({length:6}, ()=>makeRelic(rollRarity(save.ladder.tier)));
  }
  const list=$("relicList"); list.innerHTML="";
  for(const r of save.shop.relics){
    const selected = r.id===relicSelectedId;
    const owned = save.inventory.relics.some(x=>x.id===r.id);
    const row=document.createElement("div");
    row.className="item";
    row.style.background = selected ? "rgba(255,255,255,.35)" : "";
    row.innerHTML=`
      <div style="min-width:0">
        <div style="font-weight:1000">
          ${r.name} <span class="pill rar ${r.rarity}">${r.rarity}</span>
          <span class="pill">â˜¯ ${r.cost}</span> ${owned?`<span class="pill">OWNED</span>`:""}
        </div>
        <div class="muted">+STR ${r.bonus.str} â€¢ +AGI ${r.bonus.agi} â€¢ +END ${r.bonus.end}</div>
      </div>
      <button class="btn small ghost" data-rsel="${r.id}">${selected?"Selected":"Select"}</button>
    `;
    list.appendChild(row);
  }
  list.querySelectorAll("button[data-rsel]").forEach(b=>{
    b.onclick=()=>{ relicSelectedId=b.getAttribute("data-rsel"); renderRelicShop(); };
  });

  const sel = save.shop.relics.find(x=>x.id===relicSelectedId) || null;
  $("buyRelicBtn").disabled = !sel || save.currency.karma < sel.cost || save.inventory.relics.some(x=>x.id===sel.id);
  $("equipRelicBtn").disabled = !sel || !save.inventory.relics.some(x=>x.id===sel.id);
}
$("buyRelicBtn").onclick=()=>{
  const sel = save.shop.relics.find(x=>x.id===relicSelectedId) || null;
  if(!sel) return;
  if(save.currency.karma < sel.cost) return;
  if(save.inventory.relics.some(x=>x.id===sel.id)) return;
  save.currency.karma -= sel.cost;
  save.inventory.relics.push(sel);
  persist(); refreshTop(); renderRelicShop();
};
$("equipRelicBtn").onclick=()=>{
  const sel = save.shop.relics.find(x=>x.id===relicSelectedId) || null;
  if(!sel) return;
  if(!save.inventory.relics.some(x=>x.id===sel.id)) return;
  const a=activeNinja();
  a.equip.relicId=sel.id;
  recalcNinja(save,a);
  persist(); refreshTop(); renderRelicShop();
};
$("closeRelic").onclick=()=>closeModal("relicModal");

/* Battle */
const battleEl = $("battle");
const townEl = $("town");
function showBattle(v){
  battleEl.classList.toggle("hidden", !v);
  townEl.classList.toggle("hidden", v);
}
const canvas=$("battleCanvas");
const ctx=canvas.getContext("2d");
function resize(){
  canvas.width = Math.floor(window.innerWidth * devicePixelRatio);
  canvas.height= Math.floor(window.innerHeight * devicePixelRatio);
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(devicePixelRatio, devicePixelRatio);
}
window.addEventListener("resize", resize);
resize();
function hpFill(el, cur, max){ el.style.width = `${clamp(cur/max,0,1)*100}%`; }
function roundRect(x,y,w,h,r,fill){
  const rr=Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y, x+w,y+h, rr);
  ctx.arcTo(x+w,y+h, x,y+h, rr);
  ctx.arcTo(x,y+h, x,y, rr);
  ctx.arcTo(x,y, x+w,y, rr);
  if(fill) ctx.fill();
}
function drawNinja(x,y,flip=false,weapon="katana"){
  ctx.save();
  ctx.translate(x,y);
  if(flip) ctx.scale(-1,1);

  ctx.fillStyle="#111";
  roundRect(-14,-36,28,34,10,true);
  ctx.beginPath(); ctx.arc(0,-50,14,0,Math.PI*2); ctx.fill();
  ctx.fillStyle="#f3d6b6";
  roundRect(-10,-52,20,8,4,true);
  ctx.fillStyle="#111"; ctx.fillRect(-8,-50,16,2);

  ctx.fillStyle="#111";
  roundRect(-14,-6,12,10,6,true);
  roundRect(2,-6,12,10,6,true);

  ctx.strokeStyle = weapon==="staff" ? "#6b3c1d" : "#c7c7c7";
  ctx.lineWidth=3;
  ctx.beginPath();
  if(weapon==="staff"){ ctx.moveTo(10,-48); ctx.lineTo(26,-22); }
  else { ctx.moveTo(12,-40); ctx.lineTo(30,-26); }
  ctx.stroke();

  ctx.restore();
}
const floatTexts=[];
function addFloatText(text,x,y,color="#ff3a3a"){ floatTexts.push({text,x,y,vy:-0.65,t:0,color}); }
function drawFloatTexts(){
  for(const ft of floatTexts){
    ft.t += 1;
    ft.y += ft.vy;
    ctx.globalAlpha = clamp(1 - ft.t/60, 0, 1);
    ctx.fillStyle = ft.color;
    ctx.font="900 16px system-ui";
    ctx.fillText(ft.text, ft.x, ft.y);
    ctx.globalAlpha=1;
  }
  for(let i=floatTexts.length-1;i>=0;i--) if(floatTexts[i].t>60) floatTexts.splice(i,1);
}
let dust=null;
function spawnDust(x,y){ dust={x,y,t:0}; }
function drawDust(){
  if(!dust) return;
  dust.t += 1;
  const a = clamp(1 - dust.t/38, 0, 1);
  ctx.globalAlpha = a;
  ctx.fillStyle="rgba(240,220,190,.95)";
  for(let i=0;i<10;i++){
    const ox = Math.sin((dust.t+i)*0.55)*14 + (i-5)*6;
    const oy = Math.cos((dust.t+i)*0.48)*7;
    ctx.beginPath();
    ctx.arc(dust.x+ox, dust.y+oy, 18 - dust.t*0.33, 0, Math.PI*2);
    ctx.fill();
  }
  ctx.globalAlpha=1;
  if(dust.t>38) dust=null;
}
let battling=false, skip=false;

function makeEnemy(){
  const a=activeNinja(); recalcNinja(save,a);
  const tier=save.ladder.tier;
  const bIdx=beltIndex(belt());
  const diff = tier + bIdx*0.7;
  const lvl = Math.max(1, a.level + rint(-1,2) + Math.floor(diff*0.3));
  const name=pick(["Okolo Unit","Rogue Ninja","Bandit Clan","Mist Trainee","Iron Ronin","Crimson Scout"]);

  const eSTR = Math.max(1, Math.floor(1 + lvl*0.6 + diff*0.6));
  const eAGI = Math.max(1, Math.floor(1 + lvl*0.5 + diff*0.5));
  const eEND = Math.max(1, Math.floor(1 + lvl*0.6 + diff*0.7));

  const maxHP = 55 + eEND*12 + lvl*6;
  const atk   = Math.max(2, Math.floor(6 + eSTR*3 + lvl*1.6));
  const spd   = 1.0 + eAGI*0.11;
  const dodge = clamp(0.03 + eAGI*0.012, 0.03, 0.22);
  const def   = Math.floor(eEND*0.9 + lvl*0.6);

  return {name, level:lvl, maxHP, hp:maxHP, atk, spd, dodge, def};
}

function gainRewards(win, enemy){
  const a=activeNinja();
  const tier=save.ladder.tier;
  if(win){
    save.ladder.wins++;
    save.ladder.winsThisTier++;
    a.xp += Math.round(18 + enemy.level*6 + tier*4);
    a.tp += 1;
    save.currency.gold += Math.round(25 + tier*18 + enemy.level*6);
    save.currency.karma += Math.round(8 + tier*6);
    recalcNinja(save,a);
    a.hp = clamp(a.hp + Math.floor(a.maxHP*0.12), 1, a.maxHP);
    if(save.ladder.winsThisTier >= 3){
      save.ladder.tier += 1;
      save.ladder.winsThisTier = 0;
      save.shop.weapons=[]; save.shop.relics=[];
    }
  } else {
    save.ladder.losses++;
    a.hp = 1;
  }
  persist(); refreshTop();
}

function fastSim(a, enemy){
  const pDps = Math.max(1, (a._derived.atk - enemy.def)) * (1000/(520/a._derived.spd));
  const eDps = Math.max(1, (enemy.atk - a._derived.def)) * (1000/(560/enemy.spd));
  const eDpsAdj = eDps * (1 - a._derived.dodge);
  const tE = enemy.hp / pDps;
  const tP = a.hp / eDpsAdj;
  const win = tE < tP;
  if(win){ a.hp = Math.max(1, Math.floor(a.hp - eDpsAdj*tE)); enemy.hp=0; }
  else { enemy.hp = Math.max(1, Math.floor(enemy.hp - pDps*tP)); a.hp=0; }
  return win;
}

function renderFrame(px,ex,y,pW,eW){
  ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
  ctx.fillStyle="rgba(0,0,0,.06)";
  ctx.fillRect(0, y+10, window.innerWidth, 120);

  drawNinja(window.innerWidth*0.12, y-30, false, "katana");
  drawNinja(window.innerWidth*0.16, y-2, false, "staff");
  drawNinja(window.innerWidth*0.10, y+26, false, "katana");

  drawNinja(px, y, false, pW);
  drawNinja(ex, y, true, eW);

  drawDust();
  drawFloatTexts();
}

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

async function startBattle(){
  if(battling) return;
  battling=true; skip=false;

  const a=activeNinja(); recalcNinja(save,a);
  const enemy=makeEnemy();

  $("pName").textContent = `${a.name} - Lvl ${a.level}`;
  $("eName").textContent = `${enemy.name} - Lvl ${enemy.level}`;
  hpFill($("pHPFill"), a.hp, a.maxHP);
  hpFill($("eHPFill"), enemy.hp, enemy.maxHP);

  showBattle(true);

  let px=window.innerWidth*0.22;
  let ex=window.innerWidth*0.78;
  const y=window.innerHeight*0.63;
  const meet = window.innerWidth*0.52;

  const pW = pick(["katana","staff"]);
  const eW = pick(["katana","staff"]);

  while(px < meet-50 && !skip){
    px += 3.5*(a._derived.spd);
    ex -= 3.1*(enemy.spd);
    renderFrame(px,ex,y,pW,eW);
    await sleep(16);
  }

  let t=0, pNext=0, eNext=0;
  const pRate = 520 / a._derived.spd;
  const eRate = 560 / enemy.spd;

  while(a.hp>0 && enemy.hp>0){
    if(skip) break;
    t+=16;

    if(t>=pNext){
      const dodged = Math.random() < enemy.dodge;
      if(!dodged){
        const dmg = Math.max(2, Math.floor(a._derived.atk - enemy.def + rand(-1,2)));
        enemy.hp = Math.max(0, enemy.hp - dmg);
        spawnDust(meet, y-20);
        addFloatText(`-${dmg}`, meet+36, y-52, "#ff3a3a");
        hpFill($("eHPFill"), enemy.hp, enemy.maxHP);
      } else addFloatText(`DODGE`, meet+26, y-52, "#3aa8ff");
      pNext = t + pRate;
    }

    if(t>=eNext){
      const dodged = Math.random() < a._derived.dodge;
      if(!dodged){
        const dmg = Math.max(2, Math.floor(enemy.atk - a._derived.def + rand(-1,2)));
        a.hp = Math.max(0, a.hp - dmg);
        spawnDust(meet, y-20);
        addFloatText(`-${dmg}`, meet-92, y-52, "#ff3a3a");
        hpFill($("pHPFill"), a.hp, a.maxHP);
      } else addFloatText(`DODGE`, meet-104, y-52, "#3aa8ff");
      eNext = t + eRate;
    }

    renderFrame(px,ex,y,pW,eW);
    await sleep(16);
  }

  const win = skip ? fastSim(a, enemy) : (enemy.hp<=0);
  gainRewards(win, enemy);

  await sleep(200);
  showBattle(false);
  battling=false;
}

$("skipBtn").onclick=()=>{ skip=true; };

/* =========================
   Tie buildings to REAL actions
========================= */
$("hsDojo").onclick=()=>{ renderDojo(); openModal("dojoModal"); };
$("hsDaimyo").onclick=()=>{ renderDaimyo(); openModal("daiModal"); };
$("hsRecruit").onclick=()=>{ rosterSelectedId = save.activeNinjaId; renderRoster(); openModal("recruitModal"); };
$("hsWeapon").onclick=()=>{ weaponSelectedId = save.shop.weapons?.[0]?.id || null; renderWeaponShop(); openModal("weaponModal"); };
$("hsRelic").onclick=()=>{ relicSelectedId = save.shop.relics?.[0]?.id || null; renderRelicShop(); openModal("relicModal"); };
$("hsHospital").onclick=()=>{ const a=activeNinja(); recalcNinja(save,a); a.hp=a.maxHP; persist(); refreshTop(); };
$("hsFight").onclick=()=>startBattle();

/* =========================
   Init
========================= */
persist();
refreshTop();
console.log("Loaded build v4-ACTIONS");
</script>

<script>
/* =========================
   Inject base64 safely (DO NOT EDIT)
========================= */
(function(){
  // replace placeholders with actual base64 (already embedded below)
})();
</script>

</body>
</html>
