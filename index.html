<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Ninja Clan RPG (Rebuild Step 2 ‚Äî Town Loop)</title>

<style>
  html,body{
    margin:0;width:100%;height:100%;overflow:hidden;background:#0f0f12;
    font-family:system-ui,-apple-system,Segoe UI,Roboto;
    touch-action:manipulation;-webkit-user-select:none;user-select:none
  }
  :root{
    --pad-top: env(safe-area-inset-top);
    --pad-right: env(safe-area-inset-right);
    --pad-bottom: env(safe-area-inset-bottom);
    --pad-left: env(safe-area-inset-left);
    --wood1:#a56a3c; --wood2:#7a4b2a; --ink:#22140b; --accent:#ff7a18;
  }
  *{-webkit-tap-highlight-color:transparent}
  .hidden{display:none!important}

  /* ===== Top bar ===== */
  #topbar{
    position:absolute; z-index:50;
    left:calc(10px + var(--pad-left));
    right:calc(10px + var(--pad-right));
    top:calc(10px + var(--pad-top));
    display:flex;gap:8px;align-items:center;justify-content:space-between;
    background:linear-gradient(var(--wood1),var(--wood2));
    border:2px solid rgba(0,0,0,.18);
    border-radius:14px;
    padding:8px 10px;
    box-shadow:0 10px 24px rgba(0,0,0,.25);
    color:var(--ink);
  }
  .barL,.barR{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip{
    display:flex;gap:6px;align-items:center;
    background:rgba(255,255,255,.22);
    border:1px solid rgba(0,0,0,.14);
    border-radius:999px;
    padding:5px 8px;
    font-weight:950;
    font-size:11px;
    line-height:1;
  }
  .chip b{font-family:ui-monospace,Menlo,monospace}
  .btn{
    border:0;border-radius:12px;padding:9px 10px;font-weight:950;
    background:#eee;color:#111; box-shadow:0 6px 14px rgba(0,0,0,.18);
    font-size:12px;
  }
  .btn.primary{background:var(--accent)}
  .btn.ghost{background:rgba(255,255,255,.25); border:1px solid rgba(0,0,0,.14);}
  .btn.small{padding:7px 9px;font-size:11px;border-radius:11px}
  .btn:disabled{opacity:.55}

  /* ===== Town ===== */
  #town{ position:absolute; inset:0; padding-top:calc(56px + var(--pad-top)); }
  #townLayer{ position:absolute; inset:0; transform: translateY(95px); }
  #townBg{
    position:absolute; inset:0;
    background-image:url("town.jpg");
    background-size:cover;
    background-position:center top;
    background-repeat:no-repeat;
  }
  .hotspot{
    position:absolute;
    background:transparent;
    border:0;
    border-radius:18px;
    padding:0;
    z-index:10;
    touch-action:manipulation;
  }
  .label{
    position:absolute;
    left:50%;
    bottom:10%;
    transform:translateX(-50%);
    padding:8px 12px;
    border-radius:999px;
    background:rgba(255,255,255,.78);
    border:1px solid rgba(0,0,0,.15);
    font-weight:1000;
    font-size:14px;
    color:#111;
    box-shadow:0 8px 20px rgba(0,0,0,.18);
    pointer-events:none;
    white-space:nowrap;
  }

  /* Hotspots */
  #hsHospital { left:  2%; top: 11%; width: 38%; height: 22%; }
  #hsDojo     { left: 66%; top: 10%; width: 32%; height: 26%; }
  #hsDaimyo   { left: 33%; top: 26%; width: 36%; height: 22%; }
  #hsRelic    { left:  4%; top: 40%; width: 32%; height: 20%; }
  #hsWeapon   { left: 62%; top: 33%; width: 34%; height: 22%; }
  #hsRecruit  { left:  6%; top: 60%; width: 36%; height: 22%; }
  #hsFight    { left: 49%; top: 51%; width: 47%; height: 22%; }

  /* ===== Modals ===== */
  .modal{
    position:absolute; inset:0; z-index:80;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.35);
    padding:14px;
  }
  .card{
    width:min(720px,96%);
    background:linear-gradient(#f7edd6,#f0e0bf);
    border:2px solid rgba(0,0,0,.18);
    border-radius:18px;
    padding:14px;
    box-shadow:0 20px 50px rgba(0,0,0,.28);
    color:#23140b;
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .sp{justify-content:space-between}
  .title{margin:0;font-size:16px;font-weight:1000}
  .muted{opacity:.78;font-size:12px;line-height:1.25}
  .statGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .stat{
    background:rgba(255,255,255,.35);
    border:1px solid rgba(0,0,0,.12);
    border-radius:14px;
    padding:10px 12px;
    font-size:12px;
  }
  .stat b{font-family:ui-monospace,Menlo,monospace;font-size:13px}
  .list{
    margin-top:10px;
    max-height:340px; overflow:auto;
    border-radius:14px;
    border:1px solid rgba(0,0,0,.14);
    background:rgba(255,255,255,.22);
  }
  .item{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.10);
    font-size:12px;
  }
  .item:last-child{border-bottom:0}
  .pill{
    display:inline-block;
    padding:4px 8px;border-radius:999px;
    background:rgba(255,255,255,.55);
    border:1px solid rgba(0,0,0,.10);
    font-size:11px;font-weight:950;
  }
  .rar{font-weight:1000}
  .rar.Common{color:#555}
  .rar.Uncommon{color:#0d7a1c}
  .rar.Rare{color:#1a63c8}
  .rar.Epic{color:#7a2ac9}
  .rar.Legendary{color:#b06b00}

  /* Tabs */
  .tabs{display:flex;gap:8px;margin-top:8px}
  .tab{
    padding:8px 10px;border-radius:999px;font-weight:1000;font-size:12px;
    border:1px solid rgba(0,0,0,.14);
    background:rgba(255,255,255,.35);
  }
  .tab.active{background:rgba(255,255,255,.65)}
  .tabPane{margin-top:10px}

  /* Dojo preview */
  #dojoPreviewWrap{
    display:flex;gap:12px;align-items:center;flex-wrap:wrap;
    background:rgba(255,255,255,.22);
    border:1px solid rgba(0,0,0,.12);
    border-radius:14px;
    padding:10px 12px;
    margin-top:10px;
  }
  #dojoCanvas{
    width:120px;height:120px;
    border-radius:14px;
    border:1px solid rgba(0,0,0,.12);
    background:rgba(0,0,0,.08);
  }

  /* Battle selection modal list buttons */
  .bselBtn{min-width:110px}

  /* Profiles */
  .slotRow{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .slotMeta{font-size:11px;opacity:.78}

  /* Battle placeholder (Step 3 adds engine) */
  #battle{ position:absolute; inset:0; z-index:60; }
  #battleBg{
    position:absolute; inset:0;
    background-image:url("battle.jpg");
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
    transform:scale(1.02);
  }
  #battleOverlay{
    position:absolute; inset:0; display:flex; align-items:flex-end; justify-content:center;
    padding:calc(18px + var(--pad-bottom));
    z-index:70;
  }
  #battleNote{
    width:min(720px,96%);
    background:rgba(255,255,255,.85);
    border:2px solid rgba(0,0,0,.18);
    border-radius:14px;
    padding:12px 12px;
    font-weight:950;
    text-align:center;
  }
</style>
</head>

<body>
  <div id="topbar">
    <div class="barL">
      <div class="chip">Rebuild <b>STEP-2</b></div>
      <div class="chip">Active <b id="uiName">‚Äî</b></div>
      <div class="chip">Lv <b id="uiLevel">‚Äî</b></div>
      <div class="chip">HP <b id="uiHP">‚Äî</b></div>
      <div class="chip">TP <b id="uiTP">‚Äî</b></div>
      <div class="chip">Belt <b id="uiBelt">‚Äî</b></div>
      <div class="chip">ü™ô <b id="uiGold">0</b></div>
      <div class="chip">‚òØ <b id="uiKarma">0</b></div>
    </div>
    <div class="barR">
      <button class="btn ghost small" id="dailyBtn">Meditate</button>
      <button class="btn ghost small" id="profilesBtn">Profiles</button>
      <button class="btn ghost small" id="saveBtn">Save</button>
      <button class="btn ghost small" id="resetBtn">Reset Slot</button>
    </div>
  </div>

  <!-- Town -->
  <div id="town">
    <div id="townLayer">
      <div id="townBg"></div>

      <button class="hotspot" id="hsHospital"><div class="label">Hospital</div></button>
      <button class="hotspot" id="hsDojo"><div class="label">Dojo</div></button>
      <button class="hotspot" id="hsDaimyo"><div class="label">Daimyo</div></button>
      <button class="hotspot" id="hsRelic"><div class="label">Relic Shop</div></button>
      <button class="hotspot" id="hsWeapon"><div class="label">Weapon Shop</div></button>
      <button class="hotspot" id="hsRecruit"><div class="label">Recruit</div></button>
      <button class="hotspot" id="hsFight"><div class="label">Battle</div></button>
    </div>
  </div>

  <!-- Battle placeholder -->
  <div id="battle" class="hidden">
    <div id="battleBg"></div>
    <div id="battleOverlay">
      <div id="battleNote">
        Battle engine + animations are added in <b>Step 3</b>.<br>
        (This screen confirms <code>battle.jpg</code> is loading correctly.)
        <div style="margin-top:10px">
          <button class="btn" id="battleBackBtn">BACK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dojo Modal -->
  <div class="modal hidden" id="dojoModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Dojo</h3>
        <button class="btn ghost small" id="closeDojo">Close</button>
      </div>

      <div class="tabs">
        <button class="tab active" id="tabTrain">Training</button>
        <button class="tab" id="tabNinja">Ninja</button>
      </div>

      <!-- Training tab -->
      <div class="tabPane" id="paneTrain">
        <div class="muted">Level = TP spent + 1. Training costs increase at higher stats (soft caps).</div>

        <div class="statGrid">
          <div class="stat">Strength<br><b id="stSTR">1</b><div class="muted">Cost: <b id="cSTR">1</b> TP</div></div>
          <div class="stat">Agility<br><b id="stAGI">1</b><div class="muted">Cost: <b id="cAGI">1</b> TP</div></div>
          <div class="stat">Endurance<br><b id="stEND">1</b><div class="muted">Cost: <b id="cEND">1</b> TP</div></div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="trainSTR">+ STR</button>
          <button class="btn primary" id="trainAGI">+ AGI</button>
          <button class="btn primary" id="trainEND">+ END</button>
        </div>

        <div class="muted" style="margin-top:10px">
          TP: <b id="tpHere">0</b> ‚Ä¢ Active: <b id="activeHere">‚Äî</b>
        </div>
      </div>

      <!-- Ninja tab -->
      <div class="tabPane hidden" id="paneNinja">
        <div class="muted">Stats + equipment. Equip items you own.</div>

        <div id="dojoPreviewWrap">
          <canvas id="dojoCanvas" width="120" height="120"></canvas>
          <div style="min-width:200px;flex:1">
            <div style="font-weight:1000;font-size:14px" id="djName">‚Äî</div>
            <div class="muted" id="djLine">‚Äî</div>
            <div class="muted" id="djBelt">‚Äî</div>
          </div>
        </div>

        <div class="statGrid">
          <div class="stat">Base STR/AGI/END<br><b id="djBase">‚Äî</b></div>
          <div class="stat">Equip Bonus<br><b id="djBonus">‚Äî</b></div>
          <div class="stat">Derived ATK/DEF/DODGE<br><b id="djDerived">‚Äî</b></div>
        </div>

        <div class="row" style="margin-top:10px;align-items:flex-end">
          <div style="flex:1;min-width:220px">
            <div class="muted" style="margin-bottom:6px">Weapon (owned)</div>
            <select id="djWeaponSelect" style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.18)">
              <option value="">None</option>
            </select>
          </div>
          <button class="btn primary" id="djEquipWeapon">Equip</button>
          <button class="btn ghost" id="djUnequipWeapon">Unequip</button>
        </div>

        <div class="row" style="margin-top:10px;align-items:flex-end">
          <div style="flex:1;min-width:220px">
            <div class="muted" style="margin-bottom:6px">Relic (owned)</div>
            <select id="djRelicSelect" style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.18)">
              <option value="">None
                            </select>
          </div>
          <button class="btn primary" id="djEquipRelic">Equip</button>
          <button class="btn ghost" id="djUnequipRelic">Unequip</button>
        </div>

        <div class="muted" style="margin-top:10px">
          Equipped: <b id="djEquipped">‚Äî</b>
        </div>
      </div>
    </div>
  </div>

  <!-- Daimyo Modal -->
  <div class="modal hidden" id="daiModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Daimyo</h3>
        <button class="btn ghost small" id="closeDai">Close</button>
      </div>
      <div class="muted">Belt is tied to TP spent (Level = TP spent + 1).</div>

      <div class="statGrid">
        <div class="stat">Belt<br><b id="dBelt">‚Äî</b></div>
        <div class="stat">Level<br><b id="dLevel">‚Äî</b></div>
        <div class="stat">TP Spent<br><b id="dSpent">‚Äî</b></div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="stat" style="flex:1">Belts: Yellow 5 ‚Ä¢ Orange 12 ‚Ä¢ Green 20 ‚Ä¢ Blue 40 ‚Ä¢ Brown 60 ‚Ä¢ Black 80</div>
      </div>
    </div>
  </div>

  <!-- Recruit Modal -->
  <div class="modal hidden" id="recruitModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Recruit</h3>
        <button class="btn ghost small" id="closeRecruit">Close</button>
      </div>

      <div class="muted">Recruit ninjas to grow your clan. More ninjas = advantage in Step 3 battles.</div>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="recruitBtn">Recruit (ü™ô <span id="recruitCost">200</span>)</button>
        <button class="btn ghost" id="setActiveBtn">Set Selected Active</button>
      </div>

      <div class="list" id="rosterList"></div>
    </div>
  </div>

  <!-- Weapon Shop Modal -->
  <div class="modal hidden" id="weaponModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Weapon Shop</h3>
        <button class="btn ghost small" id="closeWeapon">Close</button>
      </div>

      <div class="muted">Weapons cost ü™ô gold. Stronger stat bonuses cost more.</div>

      <div class="row" style="margin-top:10px">
        <button class="btn ghost" id="buyWeaponBtn">Buy Selected</button>
        <button class="btn primary" id="equipWeaponBtn">Equip Selected</button>
        <button class="btn ghost" id="refreshWeaponBtn">Refresh</button>
      </div>

      <div class="list" id="weaponList"></div>
    </div>
  </div>

  <!-- Relic Shop Modal -->
  <div class="modal hidden" id="relicModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Relic Shop</h3>
        <button class="btn ghost small" id="closeRelic">Close</button>
      </div>

      <div class="muted">Relics cost ‚òØ karma. They add smaller but useful bonuses.</div>

      <div class="row" style="margin-top:10px">
        <button class="btn ghost" id="buyRelicBtn">Buy Selected</button>
        <button class="btn primary" id="equipRelicBtn">Equip Selected</button>
        <button class="btn ghost" id="refreshRelicBtn">Refresh</button>
      </div>

      <div class="list" id="relicList"></div>
    </div>
  </div>

  <!-- Battle Select Modal -->
  <div class="modal hidden" id="battleSelectModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Choose Battle</h3>
        <button class="btn ghost small" id="closeBattleSelect">Close</button>
      </div>
      <div class="muted">Pick an enemy clan. Step 3 adds the actual battle engine + animations.</div>
      <div class="list" id="battleList"></div>
    </div>
  </div>

  <!-- Profiles Modal -->
  <div class="modal hidden" id="profilesModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Profiles</h3>
        <button class="btn ghost small" id="closeProfiles">Close</button>
      </div>
      <div class="muted">3 save slots. Switch anytime. Each slot saves its own clan.</div>
      <div class="list" id="profilesList"></div>
    </div>
  </div>

<script>
/* ======================================================
   STEP 2 ‚Äî WORKING TOWN LOOP
   (Battle engine comes in Step 3)
====================================================== */

const PROFILE_KEY="ninja_rebuild_profiles_step2_v1";

/* ---------- Helpers ---------- */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const rand=(a,b)=>a+Math.random()*(b-a);
const rint=(a,b)=>Math.floor(rand(a,b+1));
const pick=a=>a[Math.floor(Math.random()*a.length)];
const uid=p=>p+"_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16);
const $=id=>document.getElementById(id);

/* ---------- Belts (TP spent) ---------- */
const BELTS=["White","Yellow","Orange","Green","Blue","Brown","Black"];
const BELT_TP={White:0,Yellow:5,Orange:12,Green:20,Blue:40,Brown:60,Black:80};
const BELT_COLOR={
  White:"#f5f5f5",Yellow:"#ffd54a",Orange:"#ff8a2a",Green:"#37c76b",
  Blue:"#3a82ff",Brown:"#7a4b2a",Black:"#111111"
};
function tpSpent(n){ return (n.base.str-1)+(n.base.agi-1)+(n.base.end-1); }
function beltFromSpent(spent){
  let b="White";
  for(const name of BELTS) if(spent>=BELT_TP[name]) b=name;
  return b;
}

/* ---------- Training soft caps ---------- */
function trainCost(statVal){
  if(statVal>=21) return 5;
  if(statVal>=16) return 4;
  if(statVal>=11) return 3;
  if(statVal>=6) return 2;
  return 1;
}

/* ---------- Items ---------- */
const WEAPON_TIERS=[
  {rar:"Common",str:2,agi:1,end:0,cost:60},
  {rar:"Uncommon",str:4,agi:3,end:1,cost:140},
  {rar:"Rare",str:7,agi:6,end:2,cost:320},
  {rar:"Epic",str:10,agi:10,end:3,cost:650},
  {rar:"Legendary",str:15,agi:15,end:5,cost:1200}
];
const WEAPON_NAMES=["Katana","Tanto","Naginata","War Fan","Iron Staff","Moon Blade","Storm Edge"];
const RELIC_NAMES=["Focus Charm","Shadow Bead","Lotus Token","Phoenix Feather","Smoke Ring","Karma Bead"];

function makeWeapon(){
  const t=WEAPON_TIERS[rint(0,WEAPON_TIERS.length-1)];
  return {id:uid("w"),type:"weapon",rarity:t.rar,name:pick(WEAPON_NAMES),bonus:{str:t.str,agi:t.agi,end:t.end},cost:t.cost};
}
function makeRelic(){
  // relics smaller; cost scales with bonus
  const bonus={str:rint(0,2),agi:rint(1,3),end:rint(1,3)};
  const power=bonus.str*2 + bonus.agi*2 + bonus.end*2;
  const cost=80 + power*35;
  return {id:uid("r"),type:"relic",rarity:power>=14?"Epic":power>=10?"Rare":power>=7?"Uncommon":"Common",name:pick(RELIC_NAMES),bonus,cost};
}

/* ---------- Save ---------- */
function makeNinja(name=null){
  const first=["Ryu","Hana","Jin","Kira","Sora","Mako","Taro","Yumi","Akio","Ren","Aya","Kai","Noa","Rin"];
  const last=["Shadow","Steel","Blaze","Mist","Fang","Lotus","Night","Storm","Viper","Drift"];
  const nm=name||`${pick(first)} ${pick(last)}`;
  return {
    id:uid("n"),
    name:nm,
    tp:0,
    base:{str:1,agi:1,end:1},
    equip:{weaponId:null,relicId:null},
    hp:60,maxHP:60,
    derived:{}
  };
}
function defaultSlot(){
  const starter=makeNinja("Starter Ninja");
  starter.tp=10;
  return {
    currency:{gold:200, karma:50},
    daily:{lastClaim:0},
    ninjas:[starter],
    activeId:starter.id,
    inventory:{weapons:[],relics:[]},
    shop:{weapons:[],relics:[]}
  };
}

let profiles = loadProfiles();
function loadProfiles(){
  try{
    const raw=localStorage.getItem(PROFILE_KEY);
    if(!raw) return {active:"slot1",slots:{slot1:defaultSlot(),slot2:null,slot3:null}};
    const p=JSON.parse(raw);
    p.active ??= "slot1";
    p.slots ??= {slot1:null,slot2:null,slot3:null};
    if(!p.slots.slot1) p.slots.slot1=defaultSlot();
    return p;
  }catch{
    return {active:"slot1",slots:{slot1:defaultSlot(),slot2:null,slot3:null}};
  }
}
function persistProfiles(){ localStorage.setItem(PROFILE_KEY, JSON.stringify(profiles)); }

let save = profiles.slots[profiles.active];
function persist(){
  profiles.slots[profiles.active]=save;
  persistProfiles();
}

function activeNinja(){
  return save.ninjas.find(n=>n.id===save.activeId) || save.ninjas[0];
}
function invWeapon(id){ return save.inventory.weapons.find(w=>w.id===id)||null; }
function invRelic(id){ return save.inventory.relics.find(r=>r.id===id)||null; }
function equipBonus(n){
  const w=n.equip.weaponId?invWeapon(n.equip.weaponId):null;
  const r=n.equip.relicId?invRelic(n.equip.relicId):null;
  return {
    str:(w?.bonus.str||0)+(r?.bonus.str||0),
    agi:(w?.bonus.agi||0)+(r?.bonus.agi||0),
    end:(w?.bonus.end||0)+(r?.bonus.end||0),
    weapon:w, relic:r
  };
}
function recalc(n){
  const eq=equipBonus(n);
  const STR=n.base.str+eq.str;
  const AGI=n.base.agi+eq.agi;
  const END=n.base.end+eq.end;

  const spent=tpSpent(n);
  n.level=1+spent;
  n.maxHP = 60 + END*12 + n.level*4;
  n.hp = clamp(n.hp??n.maxHP, 1, n.maxHP);

  n.derived={
    STR,AGI,END,
    atk: Math.floor(6 + STR*3 + n.level*1.2),
    def: Math.floor(END + n.level*0.6),
    dodge: clamp(0.03 + AGI*0.015, 0.03, 0.30)
  };
}

/* ---------- Modal helpers ---------- */
function openModal(id){ $(id).classList.remove("hidden"); }
function closeModal(id){ $(id).classList.add("hidden"); }

/* ---------- Top UI ---------- */
function refreshTop(){
  for(const n of save.ninjas) recalc(n);
  const a=activeNinja();
  const spent=tpSpent(a);
  const belt=beltFromSpent(spent);

  $("uiName").textContent=a.name;
  $("uiLevel").textContent=a.level;
  $("uiHP").textContent=`${a.hp}/${a.maxHP}`;
  $("uiTP").textContent=a.tp;
  $("uiBelt").textContent=belt;
  $("uiGold").textContent=save.currency.gold;
  $("uiKarma").textContent=save.currency.karma;
}

/* ---------- Dojo tabs ---------- */
function setDojoTab(which){
  $("tabTrain").classList.toggle("active", which==="train");
  $("tabNinja").classList.toggle("active", which==="ninja");
  $("paneTrain").classList.toggle("hidden", which!=="train");
  $("paneNinja").classList.toggle("hidden", which!=="ninja");
  if(which==="train") renderDojoTraining();
  if(which==="ninja") renderDojoNinja();
}
$("tabTrain").onclick=()=>setDojoTab("train");
$("tabNinja").onclick=()=>setDojoTab("ninja");
$("closeDojo").onclick=()=>closeModal("dojoModal");

function renderDojoTraining(){
  const a=activeNinja(); recalc(a);
  $("activeHere").textContent=a.name;
  $("tpHere").textContent=a.tp;
  $("stSTR").textContent=a.base.str;
  $("stAGI").textContent=a.base.agi;
  $("stEND").textContent=a.base.end;
  $("cSTR").textContent=trainCost(a.base.str);
  $("cAGI").textContent=trainCost(a.base.agi);
  $("cEND").textContent=trainCost(a.base.end);

  $("trainSTR").disabled=a.tp<trainCost(a.base.str);
  $("trainAGI").disabled=a.tp<trainCost(a.base.agi);
  $("trainEND").disabled=a.tp<trainCost(a.base.end);
}
function spendTP(stat){
  const a=activeNinja();
  const cost=trainCost(a.base[stat]);
  if(a.tp<cost) return;
  a.tp-=cost;
  a.base[stat] += 1;
  recalc(a);
  persist(); refreshTop();
  renderDojoTraining();
  renderDojoNinja();
}
$("trainSTR").onclick=()=>spendTP("str");
$("trainAGI").onclick=()=>spendTP("agi");
$("trainEND").onclick=()=>spendTP("end");

/* Preview ninja with belt, arms, weapon hint */
function roundRect(ctx,x,y,w,h,r,fill=true){
  const rr=Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y, x+w,y+h, rr);
  ctx.arcTo(x+w,y+h, x,y+h, rr);
  ctx.arcTo(x,y+h, x,y, rr);
  ctx.arcTo(x,y, x+w,y, rr);
  ctx.closePath();
  if(fill) ctx.fill();
}
function drawDojoPreview(){
  const c=$("dojoCanvas");
  const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);

  const a=activeNinja(); recalc(a);
  const belt=beltFromSpent(tpSpent(a));
  const beltCol=BELT_COLOR[belt]||"#f5f5f5";
  const eq=equipBonus(a);

  ctx.save();
  ctx.translate(60,78);

  // head
  ctx.fillStyle="#111";
  ctx.beginPath(); ctx.arc(0,-38,16,0,Math.PI*2); ctx.fill();

  // mask strip
  ctx.fillStyle="#f3d6b6";
  roundRect(ctx,-12,-44,24,10,5,true);
  ctx.fillStyle="#111"; ctx.fillRect(-10,-40,20,3);

  // body
  ctx.fillStyle="#111";
  roundRect(ctx,-18,-26,36,36,12,true);

  // arms
  ctx.strokeStyle="#111";
  ctx.lineWidth=6;
  ctx.lineCap="round";
  ctx.beginPath(); ctx.moveTo(-16,-18); ctx.lineTo(-30,-4); ctx.stroke();
  ctx.beginPath(); ctx.moveTo( 16,-18); ctx.lineTo( 32,-6); ctx.stroke();

  // belt
  ctx.fillStyle=beltCol;
  roundRect(ctx,-18,-6,36,8,4,true);

  // legs
  ctx.fillStyle="#111";
  roundRect(ctx,-16,10,14,12,6,true);
  roundRect(ctx,  2,10,14,12,6,true);

  // weapon hint
  ctx.strokeStyle = eq.weapon ? "#cfd2d6" : "rgba(255,255,255,.25)";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(26,-10);
  ctx.lineTo(42,-28);
  ctx.stroke();

  ctx.restore();
}function renderDojoNinja(){
const a=activeNinja(); recalc(a);
const eq=equipBonus(a);
const spent=tpSpent(a);
const belt=beltFromSpent(spent);

$(‚ÄúdjName‚Äù).textContent = ${a.name} (Lv ${a.level});
$(‚ÄúdjLine‚Äù).textContent = HP ${a.hp}/${a.maxHP} ‚Ä¢ TP ${a.tp} ‚Ä¢ Spent ${spent};
$(‚ÄúdjBelt‚Äù).textContent = Belt: ${belt};
$(‚ÄúdjBase‚Äù).textContent = ${a.base.str}/${a.base.agi}/${a.base.end};
$(‚ÄúdjBonus‚Äù).textContent = +${eq.str}/+${eq.agi}/+${eq.end};
$(‚ÄúdjDerived‚Äù).textContent = ${a.derived.atk}/${a.derived.def}/${Math.round(a.derived.dodge*100)}%;

const wName = eq.weapon ? ${eq.weapon.name} (${eq.weapon.rarity}) : ‚ÄúNone‚Äù;
const rName = eq.relic ? ${eq.relic.name} (${eq.relic.rarity}) : ‚ÄúNone‚Äù;
$(‚ÄúdjEquipped‚Äù).textContent = Weapon: ${wName} ‚Ä¢ Relic: ${rName};

// populate selects
const wSel=$(‚ÄúdjWeaponSelect‚Äù);
wSel.innerHTML = <option value="">None</option>;
for(const w of save.inventory.weapons){
const opt=document.createElement(‚Äúoption‚Äù);
opt.value=w.id;
opt.textContent=${w.name} [${w.rarity}] (+${w.bonus.str}/+${w.bonus.agi}/+${w.bonus.end});
if(a.equip.weaponId===w.id) opt.selected=true;
wSel.appendChild(opt);
}

const rSel=$(‚ÄúdjRelicSelect‚Äù);
rSel.innerHTML = <option value="">None</option>;
for(const r of save.inventory.relics){
const opt=document.createElement(‚Äúoption‚Äù);
opt.value=r.id;
opt.textContent=${r.name} [${r.rarity}] (+${r.bonus.str}/+${r.bonus.agi}/+${r.bonus.end});
if(a.equip.relicId===r.id) opt.selected=true;
rSel.appendChild(opt);
}

drawDojoPreview();
}

$(‚ÄúdjEquipWeapon‚Äù).onclick=()=>{
const a=activeNinja();
a.equip.weaponId = $(‚ÄúdjWeaponSelect‚Äù).value || null;
recalc(a); persist(); refreshTop(); renderDojoNinja();
};
$(‚ÄúdjUnequipWeapon‚Äù).onclick=()=>{
const a=activeNinja();
a.equip.weaponId=null;
recalc(a); persist(); refreshTop(); renderDojoNinja();
};
$(‚ÄúdjEquipRelic‚Äù).onclick=()=>{
const a=activeNinja();
a.equip.relicId = $(‚ÄúdjRelicSelect‚Äù).value || null;
recalc(a); persist(); refreshTop(); renderDojoNinja();
};
$(‚ÄúdjUnequipRelic‚Äù).onclick=()=>{
const a=activeNinja();
a.equip.relicId=null;
recalc(a); persist(); refreshTop(); renderDojoNinja();
};

/* ‚Äì‚Äì‚Äì‚Äì‚Äì Daimyo ‚Äì‚Äì‚Äì‚Äì‚Äì */
$(‚ÄúcloseDai‚Äù).onclick=()=>closeModal(‚ÄúdaiModal‚Äù);
function renderDaimyo(){
const a=activeNinja(); recalc(a);
const spent=tpSpent(a);
$(‚ÄúdBelt‚Äù).textContent=beltFromSpent(spent);
$(‚ÄúdLevel‚Äù).textContent=a.level;
$(‚ÄúdSpent‚Äù).textContent=spent;
}

/* ‚Äì‚Äì‚Äì‚Äì‚Äì Recruit ‚Äì‚Äì‚Äì‚Äì‚Äì */
$(‚ÄúcloseRecruit‚Äù).onclick=()=>closeModal(‚ÄúrecruitModal‚Äù);
let rosterSelectedId=null;
function recruitCost(){ return 200 + (save.ninjas.length-1)*120; }

function renderRoster(){
const cost=recruitCost();
$(‚ÄúrecruitCost‚Äù).textContent=cost;
$(‚ÄúrecruitBtn‚Äù).disabled = save.currency.gold < cost;

const list=$(‚ÄúrosterList‚Äù);
list.innerHTML=‚Äù‚Äù;
for(const n of save.ninjas){
recalc(n);
const isActive = n.id===save.activeId;
const selected = n.id===rosterSelectedId;
const row=document.createElement(‚Äúdiv‚Äù);
row.className=‚Äúitem‚Äù;
row.style.background = selected ? ‚Äúrgba(255,255,255,.35)‚Äù : ‚Äú‚Äù;
row.innerHTML= <div style="min-width:0"> <div style="font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis"> ${n.name} <span class="pill">Lv${n.level}</span> ${isActive?ACTIVE:""} </div> <div class="muted">STR ${n.derived.STR} ‚Ä¢ AGI ${n.derived.AGI} ‚Ä¢ END ${n.derived.END} ‚Ä¢ TP ${n.tp}</div> </div> <button class="btn ghost small">${selected?"Selected":"Select"}</button> ;
row.querySelector(‚Äúbutton‚Äù).onclick=()=>{ rosterSelectedId=n.id; renderRoster(); };
list.appendChild(row);
}
$(‚ÄúsetActiveBtn‚Äù).disabled = !rosterSelectedId;
}
$(‚ÄúrecruitBtn‚Äù).onclick=()=>{
const cost=recruitCost();
if(save.currency.gold < cost) return;

save.currency.gold -= cost;
const n=makeNinja();
n.tp = 0;
recalc(n);
save.ninjas.push(n);
rosterSelectedId=n.id;

persist(); refreshTop(); renderRoster();
};
$(‚ÄúsetActiveBtn‚Äù).onclick=()=>{
if(!rosterSelectedId) return;
save.activeId=rosterSelectedId;
persist(); refreshTop(); renderRoster();
renderDojoTraining(); renderDojoNinja();
};

/* ‚Äì‚Äì‚Äì‚Äì‚Äì Shops ‚Äì‚Äì‚Äì‚Äì‚Äì */
let weaponSelectedId=null, relicSelectedId=null;

function ensureWeaponStock(){
if(!save.shop.weapons.length){
save.shop.weapons = Array.from({length:6}, makeWeapon);
}
}
function ensureRelicStock(){
if(!save.shop.relics.length){
save.shop.relics = Array.from({length:6}, makeRelic);
}
}

function renderWeaponShop(){
ensureWeaponStock();
const list=$(‚ÄúweaponList‚Äù); list.innerHTML=‚Äù‚Äù;
for(const w of save.shop.weapons){
const selected = w.id===weaponSelectedId;
const owned = save.inventory.weapons.some(x=>x.id===w.id);
const row=document.createElement(‚Äúdiv‚Äù);
row.className=‚Äúitem‚Äù;
row.style.background = selected ? ‚Äúrgba(255,255,255,.35)‚Äù : ‚Äú‚Äù;
row.innerHTML= <div style="min-width:0"> <div style="font-weight:1000"> ${w.name} <span class="pill rar ${w.rarity}">${w.rarity}</span> <span class="pill">ü™ô ${w.cost}</span> ${owned?OWNED:""} </div> <div class="muted">+STR ${w.bonus.str} ‚Ä¢ +AGI ${w.bonus.agi} ‚Ä¢ +END ${w.bonus.end}</div> </div> <button class="btn ghost small">${selected?"Selected":"Select"}</button> ;
row.querySelector(‚Äúbutton‚Äù).onclick=()=>{ weaponSelectedId=w.id; renderWeaponShop(); };
list.appendChild(row);
}

const sel = save.shop.weapons.find(x=>x.id===weaponSelectedId) || null;
$(‚ÄúbuyWeaponBtn‚Äù).disabled = !sel || save.currency.gold < sel.cost || save.inventory.weapons.some(x=>x.id===sel.id);
$(‚ÄúequipWeaponBtn‚Äù).disabled = !sel || (!save.inventory.weapons.some(x=>x.id===sel.id) && save.currency.gold < sel.cost);
}

function renderRelicShop(){
ensureRelicStock();
const list=$(‚ÄúrelicList‚Äù); list.innerHTML=‚Äù‚Äù;
for(const r of save.shop.relics){
const selected = r.id===relicSelectedId;
const owned = save.inventory.relics.some(x=>x.id===r.id);
const row=document.createElement(‚Äúdiv‚Äù);
row.className=‚Äúitem‚Äù;
row.style.background = selected ? ‚Äúrgba(255,255,255,.35)‚Äù : ‚Äú‚Äù;
row.innerHTML= <div style="min-width:0"> <div style="font-weight:1000"> ${r.name} <span class="pill rar ${r.rarity}">${r.rarity}</span> <span class="pill">‚òØ ${r.cost}</span> ${owned?OWNED:""} </div> <div class="muted">+STR ${r.bonus.str} ‚Ä¢ +AGI ${r.bonus.agi} ‚Ä¢ +END ${r.bonus.end}</div> </div> <button class="btn ghost small">${selected?"Selected":"Select"}</button> ;
row.querySelector(‚Äúbutton‚Äù).onclick=()=>{ relicSelectedId=r.id; renderRelicShop(); };
list.appendChild(row);
}

const sel = save.shop.relics.find(x=>x.id===relicSelectedId) || null;
$(‚ÄúbuyRelicBtn‚Äù).disabled = !sel || save.currency.karma < sel.cost || save.inventory.relics.some(x=>x.id===sel.id);
$(‚ÄúequipRelicBtn‚Äù).disabled = !sel || (!save.inventory.relics.some(x=>x.id===sel.id) && save.currency.karma < sel.cost);
}

$(‚ÄúbuyWeaponBtn‚Äù).onclick=()=>{
const sel = save.shop.weapons.find(x=>x.id===weaponSelectedId) || null;
if(!sel) return;
if(save.currency.gold < sel.cost) return;
if(save.inventory.weapons.some(x=>x.id===sel.id)) return;
save.currency.gold -= sel.cost;
save.inventory.weapons.push(sel);
persist(); refreshTop();
renderWeaponShop();
renderDojoNinja();
};

$(‚ÄúequipWeaponBtn‚Äù).onclick=()=>{
const sel = save.shop.weapons.find(x=>x.id===weaponSelectedId) || null;
if(!sel) return;

if(!save.inventory.weapons.some(x=>x.id===sel.id)){
if(save.currency.gold < sel.cost) return;
save.currency.gold -= sel.cost;
save.inventory.weapons.push(sel);
}
const a=activeNinja();
a.equip.weaponId=sel.id;
recalc(a);
persist(); refreshTop();
renderWeaponShop();
renderDojoNinja();
};

$(‚ÄúrefreshWeaponBtn‚Äù).onclick=()=>{
save.shop.weapons = Array.from({length:6}, makeWeapon);
weaponSelectedId = save.shop.weapons[0]?.id || null;
persist();
renderWeaponShop();
};

$(‚ÄúcloseWeapon‚Äù).onclick=()=>closeModal(‚ÄúweaponModal‚Äù);

$(‚ÄúbuyRelicBtn‚Äù).onclick=()=>{
const sel = save.shop.relics.find(x=>x.id===relicSelectedId) || null;
if(!sel) return;
if(save.currency.karma < sel.cost) return;
if(save.inventory.relics.some(x=>x.id===sel.id)) return;
save.currency.karma -= sel.cost;
save.inventory.relics.push(sel);
persist(); refreshTop();
renderRelicShop();
renderDojoNinja();
};

$(‚ÄúequipRelicBtn‚Äù).onclick=()=>{
const sel = save.shop.relics.find(x=>x.id===relicSelectedId) || null;
if(!sel) return;

if(!save.inventory.relics.some(x=>x.id===sel.id)){
if(save.currency.karma < sel.cost) return;
save.currency.karma -= sel.cost;
save.inventory.relics.push(sel);
}
const a=activeNinja();
a.equip.relicId=sel.id;
recalc(a);
persist(); refreshTop();
renderRelicShop();
renderDojoNinja();
};

$(‚ÄúrefreshRelicBtn‚Äù).onclick=()=>{
save.shop.relics = Array.from({length:6}, makeRelic);
relicSelectedId = save.shop.relics[0]?.id || null;
persist();
renderRelicShop();
};

$(‚ÄúcloseRelic‚Äù).onclick=()=>closeModal(‚ÄúrelicModal‚Äù);

/* ‚Äì‚Äì‚Äì‚Äì‚Äì Battle select (Step 3 will use selections) ‚Äì‚Äì‚Äì‚Äì‚Äì */
function renderBattleList(){
const list=$(‚ÄúbattleList‚Äù);
list.innerHTML=‚Äù‚Äù;
const mk=(title,desc)=>{
const row=document.createElement(‚Äúdiv‚Äù);
row.className=‚Äúitem‚Äù;
row.innerHTML=<div style="min-width:0"> <div style="font-weight:1000">${title}</div> <div class="muted">${desc}</div> </div> <button class="btn primary bselBtn">Select</button>;
row.querySelector(‚Äúbutton‚Äù).onclick=()=>{
closeModal(‚ÄúbattleSelectModal‚Äù);
// show placeholder battle screen for now
showBattle(true);
};
list.appendChild(row);
};
mk(‚ÄúEnemy Clan (Easy)‚Äù, ‚Äú1‚Äì2 ninjas ‚Ä¢ rewards small‚Äù);
mk(‚ÄúEnemy Clan (Medium)‚Äù, ‚Äú2‚Äì3 ninjas ‚Ä¢ balanced‚Äù);
mk(‚ÄúEnemy Clan (Hard)‚Äù, ‚Äú3‚Äì5 ninjas ‚Ä¢ bigger rewards‚Äù);
mk(‚ÄúBoss: Black Belt Grandmaster‚Äù, ‚Äú1 max-level black belt ‚Ä¢ huge rewards (Step 3)‚Äù);
}

/* ‚Äì‚Äì‚Äì‚Äì‚Äì Profiles ‚Äì‚Äì‚Äì‚Äì‚Äì */
$(‚ÄúcloseProfiles‚Äù).onclick=()=>closeModal(‚ÄúprofilesModal‚Äù);
function slotSummary(slot){
if(!slot) return ‚ÄúEmpty‚Äù;
const n=slot.ninjas?.length||0;
const a=slot.ninjas?.find(x=>x.id===slot.activeId) || slot.ninjas?.[0];
const lvl=a ? (1+tpSpent(a)) : 1;
return ${n} ninja${n===1?"":"s"} ‚Ä¢ Lv ${lvl} ‚Ä¢ ü™ô ${slot.currency.gold} ‚Ä¢ ‚òØ ${slot.currency.karma};
}
function renderProfiles(){
const list=$(‚ÄúprofilesList‚Äù);
list.innerHTML=‚Äù‚Äù;
[‚Äúslot1‚Äù,‚Äúslot2‚Äù,‚Äúslot3‚Äù].forEach(key=>{
const slot=profiles.slots[key];
const row=document.createElement(‚Äúdiv‚Äù);
row.className=‚Äúitem‚Äù;
row.innerHTML=<div class="slotRow" style="width:100%"> <div style="min-width:0"> <div style="font-weight:1000">${key.toUpperCase()}</div> <div class="slotMeta">${slotSummary(slot)}</div> </div> <div class="row" style="margin-left:auto"> <button class="btn ghost small" data-act="${key}">${profiles.active===key?"Active":"Use"}</button> <button class="btn ghost small" data-new="${key}">${slot?"Reset":"New"}</button> </div> </div>;
list.appendChild(row);
});

list.querySelectorAll(‚Äúbutton[data-act]‚Äù).forEach(b=>{
b.onclick=()=>{
const key=b.getAttribute(‚Äúdata-act‚Äù);
profiles.active=key;
if(!profiles.slots[key]) profiles.slots[key]=defaultSlot();
save=profiles.slots[key];
persist();
refreshTop();
closeModal(‚ÄúprofilesModal‚Äù);
};
});
list.querySelectorAll(‚Äúbutton[data-new]‚Äù).forEach(b=>{
b.onclick=()=>{
const key=b.getAttribute(‚Äúdata-new‚Äù);
profiles.slots[key]=defaultSlot();
profiles.active=key;
save=profiles.slots[key];
persist();
renderProfiles();
refreshTop();
};
});
}

/* ‚Äì‚Äì‚Äì‚Äì‚Äì Meditation (30 min cooldown) ‚Äì‚Äì‚Äì‚Äì‚Äì /
const DAILY_INTERVAL = 3060*1000;
$(‚ÄúdailyBtn‚Äù).onclick=()=>{
const now=Date.now();
const last=save.daily.lastClaim||0;
if(now-last < DAILY_INTERVAL){
const left = Math.ceil((DAILY_INTERVAL-(now-last))/60000);
alert(Not ready yet. Try again in ~${left} min.);
return;
}
const a=activeNinja();
const belt=beltFromSpent(tpSpent(a));
const amt = belt===‚ÄúWhite‚Äù?1 : belt===‚ÄúYellow‚Äù?2 : belt===‚ÄúOrange‚Äù?3 : belt===‚ÄúGreen‚Äù?4 : 5;
a.tp += amt;
save.daily.lastClaim = now;
recalc(a);
persist(); refreshTop();
alert(Meditation complete: +${amt} TP);
};

/* ‚Äì‚Äì‚Äì‚Äì‚Äì Town actions ‚Äì‚Äì‚Äì‚Äì‚Äì */
function showBattle(v){
$(‚Äúbattle‚Äù).classList.toggle(‚Äúhidden‚Äù, !v);
$(‚Äútown‚Äù).classList.toggle(‚Äúhidden‚Äù, v);
}
$(‚ÄúbattleBackBtn‚Äù).onclick=()=>showBattle(false);

$(‚ÄúhsHospital‚Äù).onclick=()=>{
const a=activeNinja(); recalc(a);
a.hp=a.maxHP;
persist(); refreshTop();
};

$(‚ÄúhsDojo‚Äù).onclick=()=>{
setDojoTab(‚Äútrain‚Äù);
renderDojoTraining();
renderDojoNinja();
openModal(‚ÄúdojoModal‚Äù);
};

$(‚ÄúhsDaimyo‚Äù).onclick=()=>{
renderDaimyo();
openModal(‚ÄúdaiModal‚Äù);
};

$(‚ÄúhsRecruit‚Äù).onclick=()=>{
rosterSelectedId = save.activeId;
renderRoster();
openModal(‚ÄúrecruitModal‚Äù);
};

$(‚ÄúhsWeapon‚Äù).onclick=()=>{
ensureWeaponStock();
weaponSelectedId = save.shop.weapons[0]?.id || null;
renderWeaponShop();
openModal(‚ÄúweaponModal‚Äù);
};

$(‚ÄúhsRelic‚Äù).onclick=()=>{
ensureRelicStock();
relicSelectedId = save.shop.relics[0]?.id || null;
renderRelicShop();
openModal(‚ÄúrelicModal‚Äù);
};

$(‚ÄúhsFight‚Äù).onclick=()=>{
renderBattleList();
openModal(‚ÄúbattleSelectModal‚Äù);
};

$(‚ÄúcloseBattleSelect‚Äù).onclick=()=>closeModal(‚ÄúbattleSelectModal‚Äù);

/* ‚Äì‚Äì‚Äì‚Äì‚Äì Save/Reset ‚Äì‚Äì‚Äì‚Äì‚Äì */
$(‚ÄúsaveBtn‚Äù).onclick=()=>{ persist(); refreshTop(); };
$(‚ÄúresetBtn‚Äù).onclick=()=>{
profiles.slots[profiles.active]=defaultSlot();
save=profiles.slots[profiles.active];
persist();
refreshTop();
};

/* ‚Äì‚Äì‚Äì‚Äì‚Äì Profiles open/close ‚Äì‚Äì‚Äì‚Äì‚Äì */
$(‚ÄúprofilesBtn‚Äù).onclick=()=>{
renderProfiles();
openModal(‚ÄúprofilesModal‚Äù);
};

/* init */
persist();
refreshTop();
renderDojoTraining();
renderDojoNinja();
</body>
</html>
```
