<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Ninja Town RPG</title>
<style>
  html,body{margin:0;width:100%;height:100%;overflow:hidden;background:#0f0f12;
    font-family:system-ui,-apple-system,Segoe UI,Roboto;touch-action:none;-webkit-user-select:none;user-select:none}
  :root{
    --pad-top: env(safe-area-inset-top);
    --pad-right: env(safe-area-inset-right);
    --pad-bottom: env(safe-area-inset-bottom);
    --pad-left: env(safe-area-inset-left);
    --wood:#7a4b2a;
    --wood2:#5d351c;
    --paper:#f1e2c6;
    --ink:#2a1a10;
    --accent:#ff7a18;
  }
  *{-webkit-tap-highlight-color:transparent}

  /* Backdrop */
  #bg{
    position:absolute;inset:0;
    background:
      radial-gradient(1200px 700px at 70% 10%, rgba(255,255,255,.22), transparent 55%),
      radial-gradient(900px 600px at 30% 20%, rgba(255,255,255,.16), transparent 55%),
      linear-gradient(#bfe5ff, #b7d8ff 30%, #d7f2ff 55%, #f4d4a4 90%, #e3b07c);
  }

  /* UI root */
  #ui{position:absolute;inset:0;padding:calc(10px + var(--pad-top)) calc(10px + var(--pad-right))
    calc(10px + var(--pad-bottom)) calc(10px + var(--pad-left)); color:#111}

  .hidden{display:none !important;}

  /* Top resource bar (like screenshot) */
  #topbar{
    display:flex;gap:10px;align-items:center;justify-content:space-between;
    background:linear-gradient(#a56a3c,#7a4b2a);
    border:2px solid rgba(0,0,0,.20);
    border-radius:14px;padding:10px 12px;
    box-shadow:0 10px 24px rgba(0,0,0,.25);
    color:#1b110a;
  }
  .barLeft,.barRight{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .chip{
    background:rgba(255,255,255,.25);
    border:1px solid rgba(0,0,0,.15);
    border-radius:999px;padding:6px 10px;
    font-weight:900;font-size:12px;
    display:flex;gap:8px;align-items:center;
  }
  .chip b{font-family:ui-monospace,Menlo,monospace}
  .btn{
    border:0;border-radius:12px;padding:10px 12px;font-weight:950;
    background:#eee;color:#111;
    box-shadow:0 6px 14px rgba(0,0,0,.18);
  }
  .btn.primary{background:var(--accent);}
  .btn.ghost{background:rgba(255,255,255,.25); border:1px solid rgba(0,0,0,.15);}
  .btn.small{padding:8px 10px;font-size:12px;border-radius:11px}

  /* Town map area */
  #town{
    position:absolute;left:0;right:0;
    top:calc(64px + var(--pad-top)); bottom:0;
    display:flex;justify-content:center;align-items:center;
  }

  /* Floating island */
  .islandWrap{
    position:relative;width:min(980px,100%);height:min(640px,100%);
  }
  .island{
    position:absolute;left:50%;top:55%;
    transform:translate(-50%,-50%);
    width:min(880px,96%);height:min(520px,80%);
    border-radius:28px;
    background:
      radial-gradient(120px 80px at 20% 18%, rgba(255,255,255,.9), rgba(255,255,255,.0) 70%),
      radial-gradient(140px 90px at 70% 20%, rgba(255,255,255,.9), rgba(255,255,255,.0) 70%),
      radial-gradient(140px 120px at 30% 55%, #ffffff, #f6fbff 55%, #e9f5ff 75%, #d0ecff 95%),
      linear-gradient(#ffffff,#f0fbff);
    border:2px solid rgba(0,0,0,.10);
    box-shadow:0 24px 50px rgba(0,0,0,.20);
    overflow:hidden;
  }
  .island:after{
    content:""; position:absolute; left:50%; bottom:-110px; transform:translateX(-50%);
    width:68%; height:170px;
    background:radial-gradient(closest-side, #b18b62, #7b5a3c 70%, rgba(0,0,0,0) 72%);
    filter:blur(0px);
    opacity:.95;
  }

  /* Cloud puffs */
  .cloud{
    position:absolute; width:120px;height:70px; border-radius:999px;
    background:rgba(255,255,255,.85);
    filter:drop-shadow(0 10px 16px rgba(0,0,0,.12));
  }
  .cloud:before,.cloud:after{
    content:""; position:absolute; background:rgba(255,255,255,.85); border-radius:999px;
  }
  .cloud:before{width:70px;height:70px;left:10px;top:-18px}
  .cloud:after{width:80px;height:80px;right:14px;top:-26px}
  .c1{left:6%;top:12%}
  .c2{right:8%;top:10%;transform:scale(1.05)}
  .c3{left:12%;bottom:18%;transform:scale(.85);opacity:.9}
  .c4{right:10%;bottom:20%;transform:scale(.9);opacity:.9}

  /* Building buttons */
  .bldg{
    position:absolute; width:150px; height:120px;
    border-radius:18px;
    background:linear-gradient(#f4f1ea,#eae0cf);
    border:2px solid rgba(0,0,0,.10);
    box-shadow:0 14px 22px rgba(0,0,0,.16);
    display:flex;flex-direction:column;align-items:center;justify-content:flex-end;
    padding:10px;
    cursor:pointer;
  }
  .roof{
    position:absolute; top:-18px; left:50%; transform:translateX(-50%);
    width:120px; height:50px;
    background:linear-gradient(#7c2d2d,#561b1b);
    border-radius:16px 16px 10px 10px;
    border:2px solid rgba(0,0,0,.12);
  }
  .roof.blue{background:linear-gradient(#2d5d9a,#1c3f6d)}
  .roof.black{background:linear-gradient(#3a3a3a,#111)}
  .roof.gold{background:linear-gradient(#d0a23a,#9a6f18)}
  .sign{
    position:absolute; top:-46px; left:50%; transform:translateX(-50%);
    background:rgba(255,255,255,.65);
    border:1px solid rgba(0,0,0,.12);
    border-radius:999px;
    padding:6px 10px;
    font-weight:1000;
    font-family: "Georgia", "Times New Roman", serif;
    color:#2a1a10;
    white-space:nowrap;
  }
  .bldg span{font-weight:1000;font-size:12px;color:#2a1a10;margin-bottom:2px}
  .bldg small{font-size:11px;opacity:.75;margin-bottom:6px}

  /* placements similar to screenshot */
  #bDaimyo{left:6%;top:12%}
  #bHospital{left:33%;top:22%}
  #bRelic{left:56%;top:18%}
  #bWeapon{right:8%;top:26%}
  #bRecruit{left:18%;top:55%}
  #bDojo{left:52%;top:60%}
  #bFight{right:10%;bottom:10%;width:170px;height:130px;background:linear-gradient(#fff,#ffe7c7)}
  #bFight .roof{background:linear-gradient(#ff7a18,#c95b08)}
  #bFight .sign{background:rgba(255,255,255,.85)}
  #bFight span{font-size:14px}

  /* Modal panels */
  .modal{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.30);
  }
  .card{
    width:min(560px,92%); background:linear-gradient(#f7edd6,#f0e0bf);
    border:2px solid rgba(0,0,0,.18);
    border-radius:18px; padding:14px;
    box-shadow:0 20px 50px rgba(0,0,0,.28);
  }
  .card h3{margin:0 0 6px; font-size:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .sp{justify-content:space-between}
  .stat{
    flex:1 1 150px;
    background:rgba(255,255,255,.35);
    border:1px solid rgba(0,0,0,.12);
    border-radius:14px;
    padding:10px 12px;
    font-size:12px;
  }
  .stat b{font-family:ui-monospace,Menlo,monospace}
  .muted{opacity:.75;font-size:12px}

  /* Battle view */
  #battleView{
    position:absolute; inset:0;
    background:
      radial-gradient(900px 600px at 20% 10%, rgba(255,255,255,.20), transparent 50%),
      linear-gradient(#bfe5ff, #cfefff 45%, #8bc38a 46%, #7ab375 100%);
  }
  #battleTop{
    position:absolute; left:10px; right:10px; top:calc(10px + var(--pad-top));
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .hpBox{
    flex:1 1 0;
    background:linear-gradient(#a56a3c,#7a4b2a);
    border:2px solid rgba(0,0,0,.18);
    border-radius:14px;
    padding:10px 12px;
    box-shadow:0 10px 24px rgba(0,0,0,.22);
    color:#1b110a;
    min-width:0;
  }
  .hpName{font-weight:1000;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .hpBar{
    height:12px;border-radius:999px;background:rgba(0,0,0,.18);overflow:hidden;margin-top:6px;
    border:1px solid rgba(0,0,0,.12);
  }
  .hpFill{height:100%; width:100%; background:linear-gradient(#ffb845,#ff7a18);}
  .vs{
    font-weight:1000;font-size:22px;color:#fff; text-shadow:0 4px 10px rgba(0,0,0,.35);
    padding:0 10px;
  }
  #skipBtn{
    position:absolute; top:calc(72px + var(--pad-top)); left:50%; transform:translateX(-50%);
    background:rgba(255,255,255,.75); border:2px solid rgba(0,0,0,.18);
    border-radius:12px; padding:10px 14px; font-weight:1000;
  }

  #battleCanvas{position:absolute; left:0; right:0; top:0; bottom:0; width:100%; height:100%}

</style>
</head>
<body>
<div id="bg"></div>

<div id="ui">

  <div id="topbar">
    <div class="barLeft">
      <div class="chip">HP <b id="uiHP">—</b></div>
      <div class="chip">Belt <b id="uiBelt">White</b></div>
      <div class="chip">TP <b id="uiTP">0</b></div>
      <div class="chip">XP <b id="uiXP">0</b></div>
    </div>
    <div class="barRight">
      <button class="btn ghost small" id="saveBtn">Save</button>
      <button class="btn ghost small" id="resetBtn">Reset</button>
    </div>
  </div>

  <!-- TOWN -->
  <div id="town">
    <div class="islandWrap">
      <div class="island">
        <div class="cloud c1"></div><div class="cloud c2"></div><div class="cloud c3"></div><div class="cloud c4"></div>

        <div class="bldg" id="bDaimyo">
          <div class="roof gold"></div>
          <div class="sign">Daimyo</div>
          <span>Prestige</span><small class="muted">Belts & Rank</small>
        </div>

        <div class="bldg" id="bHospital">
          <div class="roof"></div>
          <div class="sign">Hospital</div>
          <span>Heal</span><small class="muted">Restore HP</small>
        </div>

        <div class="bldg" id="bRelic">
          <div class="roof gold"></div>
          <div class="sign">Relic Shop</div>
          <span>Items</span><small class="muted">(later)</small>
        </div>

        <div class="bldg" id="bWeapon">
          <div class="roof black"></div>
          <div class="sign">Weapon Shop</div>
          <span>Gear</span><small class="muted">(later)</small>
        </div>

        <div class="bldg" id="bRecruit">
          <div class="roof"></div>
          <div class="sign">Recruit Ninjas</div>
          <span>Roster</span><small class="muted">(later)</small>
        </div>

        <div class="bldg" id="bDojo">
          <div class="roof blue"></div>
          <div class="sign">Dojo</div>
          <span>Train</span><small class="muted">STR / AGI / END</small>
        </div>

        <div class="bldg" id="bFight">
          <div class="roof"></div>
          <div class="sign">Fight</div>
          <span>Battle</span><small class="muted">Earn XP + TP</small>
        </div>
      </div>
    </div>
  </div>

  <!-- DOJO MODAL -->
  <div class="modal hidden" id="dojoModal">
    <div class="card">
      <div class="row sp">
        <h3>Dojo Training</h3>
        <button class="btn ghost small" id="closeDojo">Close</button>
      </div>
      <div class="muted">Spend Training Points (TP) to improve stats.</div>

      <div class="row" style="margin-top:10px">
        <div class="stat">Strength (Damage)<br><b id="stSTR">1</b></div>
        <div class="stat">Agility (Speed/Dodge)<br><b id="stAGI">1</b></div>
        <div class="stat">Endurance (HP/Defense)<br><b id="stEND">1</b></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="trainSTR">+ STR (1 TP)</button>
        <button class="btn primary" id="trainAGI">+ AGI (1 TP)</button>
        <button class="btn primary" id="trainEND">+ END (1 TP)</button>
      </div>

      <div class="muted" style="margin-top:10px">
        Current TP: <b id="tpHere">0</b> • Belt: <b id="beltHere">White</b>
      </div>
    </div>
  </div>

  <!-- DAIMYO MODAL -->
  <div class="modal hidden" id="daiModal">
    <div class="card">
      <div class="row sp">
        <h3>Daimyo</h3>
        <button class="btn ghost small" id="closeDai">Close</button>
      </div>
      <div class="muted">Belts are earned by XP.</div>
      <div class="row" style="margin-top:10px">
        <div class="stat">Belt<br><b id="dBelt">White</b></div>
        <div class="stat">XP<br><b id="dXP">0</b></div>
        <div class="stat">Next Belt At<br><b id="dNext">50</b></div>
      </div>
    </div>
  </div>

  <!-- BATTLE VIEW -->
  <div id="battleView" class="hidden">
    <canvas id="battleCanvas"></canvas>

    <div id="battleTop">
      <div class="hpBox">
        <div class="hpName" id="pName">You</div>
        <div class="hpBar"><div class="hpFill" id="pHPFill"></div></div>
      </div>
      <div class="vs">VS</div>
      <div class="hpBox">
        <div class="hpName" id="eName">Enemy</div>
        <div class="hpBar"><div class="hpFill" id="eHPFill"></div></div>
      </div>
    </div>

    <button id="skipBtn" class="btn">SKIP</button>
  </div>

</div>

<script>
/* =========================
   SAVE + RPG CORE
========================= */
const SAVE_KEY="ninja_rpg_v1";

const BELTS=["White","Yellow","Orange","Green","Blue","Brown","Black"];
const BELT_XP=[0,50,150,350,700,1200,2000];

function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function rand(a,b){ return a + Math.random()*(b-a); }
function rint(a,b){ return Math.floor(rand(a,b+1)); }

function beltFromXP(xp){
  let idx=0;
  for(let i=0;i<BELT_XP.length;i++) if(xp>=BELT_XP[i]) idx=i;
  return BELTS[Math.min(idx,BELTS.length-1)];
}
function nextBeltXP(xp){
  for(let i=1;i<BELT_XP.length;i++) if(xp < BELT_XP[i]) return BELT_XP[i];
  return BELT_XP[BELT_XP.length-1];
}

function defaultSave(){
  return {
    ninja:{
      name:"Andy Holloway", // placeholder like screenshot vibe
      level:1,
      xp:0,
      tp:0,
      str:1, agi:1, end:1,
      hp: 60,
      maxHP: 60
    },
    stats:{ wins:0, losses:0 }
  };
}
let save = load();

function load(){
  try{
    const raw=localStorage.getItem(SAVE_KEY);
    if(!raw) return defaultSave();
    const s=JSON.parse(raw);
    if(!s?.ninja) return defaultSave();
    s.ninja.tp ??= 0;
    s.ninja.str ??= 1; s.ninja.agi ??= 1; s.ninja.end ??= 1;
    recalcPlayer(s);
    return s;
  }catch{ return defaultSave(); }
}
function persist(){ localStorage.setItem(SAVE_KEY, JSON.stringify(save)); }

function recalcPlayer(s=save){
  const n=s.ninja;
  n.level = 1 + Math.floor(n.xp / 100);
  n.maxHP = 55 + n.end*12 + n.level*6;
  // keep hp within max
  n.hp = clamp(n.hp ?? n.maxHP, 0, n.maxHP);
}

function playerAtk(){
  // STR + level, small randomness
  return Math.max(2, Math.floor(6 + save.ninja.str*3 + save.ninja.level*1.6 + rand(-1,2)));
}
function playerSpeed(){
  return 1.0 + save.ninja.agi*0.12;
}
function playerDodge(){
  return clamp(0.03 + save.ninja.agi*0.015, 0.03, 0.28);
}
function playerDef(){
  return Math.floor(save.ninja.end*0.9 + save.ninja.level*0.6);
}

/* =========================
   TOWN UI
========================= */
const $=id=>document.getElementById(id);

function refreshTop(){
  recalcPlayer();
  const belt=beltFromXP(save.ninja.xp);
  $("uiBelt").textContent=belt;
  $("uiTP").textContent=save.ninja.tp;
  $("uiXP").textContent=save.ninja.xp;
  $("uiHP").textContent=`${save.ninja.hp}/${save.ninja.maxHP}`;
}

function openModal(el){ el.classList.remove("hidden"); }
function closeModal(el){ el.classList.add("hidden"); }

$("saveBtn").onclick=()=>{ persist(); refreshTop(); };
$("resetBtn").onclick=()=>{
  localStorage.removeItem(SAVE_KEY);
  save=defaultSave();
  persist(); refreshTop();
};

$("bDojo").onclick=()=>{
  refreshDojo();
  openModal($("dojoModal"));
};
$("closeDojo").onclick=()=>closeModal($("dojoModal"));

$("bDaimyo").onclick=()=>{
  const belt=beltFromXP(save.ninja.xp);
  $("dBelt").textContent=belt;
  $("dXP").textContent=save.ninja.xp;
  $("dNext").textContent=nextBeltXP(save.ninja.xp);
  openModal($("daiModal"));
};
$("closeDai").onclick=()=>closeModal($("daiModal"));

$("bHospital").onclick=()=>{
  save.ninja.hp = save.ninja.maxHP;
  persist(); refreshTop();
};

function refreshDojo(){
  $("stSTR").textContent=save.ninja.str;
  $("stAGI").textContent=save.ninja.agi;
  $("stEND").textContent=save.ninja.end;
  $("tpHere").textContent=save.ninja.tp;
  $("beltHere").textContent=beltFromXP(save.ninja.xp);

  const can = save.ninja.tp>0;
  $("trainSTR").disabled=!can;
  $("trainAGI").disabled=!can;
  $("trainEND").disabled=!can;
}

function spendTP(which){
  if(save.ninja.tp<=0) return;
  save.ninja.tp -= 1;
  save.ninja[which] += 1;
  recalcPlayer();
  persist();
  refreshTop();
  refreshDojo();
}
$("trainSTR").onclick=()=>spendTP("str");
$("trainAGI").onclick=()=>spendTP("agi");
$("trainEND").onclick=()=>spendTP("end");

/* =========================
   BATTLE (2D CANVAS)
   Style goal: like your screenshot.
========================= */
let battling=false, skip=false;

function showBattle(v){
  $("battleView").classList.toggle("hidden", !v);
  $("town").classList.toggle("hidden", v);
}

function makeEnemy(){
  const belt=beltFromXP(save.ninja.xp);
  const tier = BELTS.indexOf(belt)+1;
  const lvl = Math.max(1, save.ninja.level + rint(-1, 2));
  const name = ["Okolo Unit","Rogue Ninja","Bandit Clan","Mist Trainee","Iron Ronin","Crimson Scout"][rint(0,5)];
  const maxHP = Math.floor((45 + lvl*9) * (1 + tier*0.08));
  return {
    name, level:lvl,
    maxHP, hp:maxHP,
    atk: Math.floor((6 + lvl*2.2) * (1 + tier*0.06)),
    def: Math.floor((1 + lvl*0.9) * (1 + tier*0.06)),
    spd: 1.0 + lvl*0.06
  };
}

const canvas=$("battleCanvas");
const ctx=canvas.getContext("2d");

function resize(){
  canvas.width = Math.floor(window.innerWidth * devicePixelRatio);
  canvas.height= Math.floor(window.innerHeight * devicePixelRatio);
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(devicePixelRatio, devicePixelRatio);
}
window.addEventListener("resize", resize);
resize();

function hpFill(el, cur, max){
  el.style.width = `${clamp(cur/max,0,1)*100}%`;
}

function drawNinja(x,y,flip=false,weapon="katana"){
  // Simple “chibi ninja” silhouette
  ctx.save();
  ctx.translate(x,y);
  if(flip) ctx.scale(-1,1);

  // body
  ctx.fillStyle="#111";
  roundRect(-14,-36,28,34,10,true);
  // head
  ctx.beginPath(); ctx.arc(0,-50,14,0,Math.PI*2); ctx.fill();
  // face slit
  ctx.fillStyle="#f3d6b6";
  roundRect(-10,-52,20,8,4,true);
  // eye line
  ctx.fillStyle="#111";
  ctx.fillRect(-8,-50,16,2);

  // legs
  ctx.fillStyle="#111";
  roundRect(-14,-6,12,10,6,true);
  roundRect(2,-6,12,10,6,true);

  // weapon
  ctx.strokeStyle = weapon==="staff" ? "#6b3c1d" : "#c7c7c7";
  ctx.lineWidth=3;
  ctx.beginPath();
  if(weapon==="staff"){
    ctx.moveTo(10,-48); ctx.lineTo(26,-22);
  }else{
    ctx.moveTo(12,-40); ctx.lineTo(30,-26);
  }
  ctx.stroke();

  ctx.restore();
}

function roundRect(x,y,w,h,r,fill){
  const rr=Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y, x+w,y+h, rr);
  ctx.arcTo(x+w,y+h, x,y+h, rr);
  ctx.arcTo(x,y+h, x,y, rr);
  ctx.arcTo(x,y, x+w,y, rr);
  if(fill) ctx.fill();
}

const floatTexts=[];
function addFloatText(text,x,y,color="#ff3a3a"){
  floatTexts.push({text,x,y,vy:-0.6,t:0,color});
}
function drawFloatTexts(){
  for(const ft of floatTexts){
    ft.t += 1;
    ft.y += ft.vy;
    ctx.globalAlpha = clamp(1 - ft.t/55, 0, 1);
    ctx.fillStyle = ft.color;
    ctx.font="900 16px system-ui";
    ctx.fillText(ft.text, ft.x, ft.y);
    ctx.globalAlpha=1;
  }
  // trim
  for(let i=floatTexts.length-1;i>=0;i--) if(floatTexts[i].t>55) floatTexts.splice(i,1);
}

let dust=null;
function spawnDust(x,y){
  dust={x,y,t:0};
}
function drawDust(){
  if(!dust) return;
  dust.t += 1;
  const a = clamp(1 - dust.t/35, 0, 1);
  ctx.globalAlpha = a;
  ctx.fillStyle="rgba(240,220,190,.95)";
  for(let i=0;i<10;i++){
    const ox = Math.sin((dust.t+i)*0.6)*16 + (i-5)*6;
    const oy = Math.cos((dust.t+i)*0.5)*8;
    ctx.beginPath();
    ctx.arc(dust.x+ox, dust.y+oy, 18 - dust.t*0.35, 0, Math.PI*2);
    ctx.fill();
  }
  ctx.globalAlpha=1;
  if(dust.t>35) dust=null;
}

async function startBattle(){
  if(battling) return;
  battling=true; skip=false;

  // setup
  recalcPlayer();
  const enemy=makeEnemy();
  $("pName").textContent = `${save.ninja.name} - Lvl ${save.ninja.level}`;
  $("eName").textContent = `${enemy.name} - Lvl ${enemy.level}`;

  // show
  showBattle(true);
  hpFill($("pHPFill"), save.ninja.hp, save.ninja.maxHP);
  hpFill($("eHPFill"), enemy.hp, enemy.maxHP);

  // positions
  let px=window.innerWidth*0.22;
  let ex=window.innerWidth*0.78;
  const y=window.innerHeight*0.63;

  const meet = window.innerWidth*0.5;
  const pWeapon = ["katana","staff"][rint(0,1)];
  const eWeapon = ["katana","staff"][rint(0,1)];

  // run-in
  while(px < meet-50 && !skip){
    px += 3.5*playerSpeed();
    ex -= 3.1*enemy.spd;
    renderFrame(px,ex,y,pWeapon,eWeapon,enemy);
    await sleep(16);
  }

  // fight loop (auto)
  let pNext=0, eNext=0;
  const pRate = 520 / playerSpeed();          // faster with AGI
  const eRate = 560 / enemy.spd;

  let t=0;
  while(save.ninja.hp>0 && enemy.hp>0){
    if(skip){ break; }

    t+=16;
    if(t>=pNext){
      // player attack with dodge check
      if(Math.random() > 0.06){ // player hit anim always; dodge handled on enemy side? keep simple
        const dodged = Math.random() < 0.05; // enemy minor dodge baseline
        if(!dodged){
          const dmg = Math.max(2, playerAtk() - enemy.def);
          enemy.hp = Math.max(0, enemy.hp - dmg);
          spawnDust(meet, y-20);
          addFloatText(`-${dmg}`, meet+40, y-50, "#ff3a3a");
          hpFill($("eHPFill"), enemy.hp, enemy.maxHP);
        } else {
          addFloatText(`DODGE`, meet+36, y-50, "#3aa8ff");
        }
      }
      pNext = t + pRate;
    }

    if(t>=eNext){
      // enemy attacks; player can dodge based on AGI
      const dodged = Math.random() < playerDodge();
      if(!dodged){
        const dmg = Math.max(2, Math.floor(enemy.atk - playerDef() + rand(-1,2)));
        save.ninja.hp = Math.max(0, save.ninja.hp - dmg);
        spawnDust(meet, y-20);
        addFloatText(`-${dmg}`, meet-90, y-50, "#ff3a3a");
        hpFill($("pHPFill"), save.ninja.hp, save.ninja.maxHP);
      } else {
        addFloatText(`DODGE`, meet-98, y-50, "#3aa8ff");
      }
      eNext = t + eRate;
    }

    renderFrame(px,ex,y,pWeapon,eWeapon,enemy);
    await sleep(16);
  }

  // resolve instantly if skipped
  if(skip){
    // fast sim
    const result = fastSim(enemy);
    await finishBattle(enemy, result.win);
  } else {
    await finishBattle(enemy, enemy.hp<=0);
  }

  battling=false;
  showBattle(false);
  refreshTop();
  persist();
}

function fastSim(enemy){
  // quick deterministic-ish sim for skip
  let php=save.ninja.hp, ehp=enemy.hp;
  const pDps = (playerAtk() - enemy.def) * (1000/(520/playerSpeed()));
  const eDps = (enemy.atk - playerDef()) * (1000/(560/enemy.spd));
  // apply dodge on player
  const eDpsAdj = eDps * (1 - playerDodge());
  // time to kill
  const tE = ehp / Math.max(1,pDps);
  const tP = php / Math.max(1,eDpsAdj);
  const win = tE < tP;
  // update hp approx
  if(win){
    save.ninja.hp = Math.max(1, Math.floor(php - eDpsAdj*tE));
    enemy.hp=0;
  } else {
    enemy.hp = Math.max(1, Math.floor(ehp - pDps*tP));
    save.ninja.hp=0;
  }
  return {win};
}

async function finishBattle(enemy, win){
  if(win){
    save.stats.wins++;
    const xpGain = 18 + enemy.level*6;
    const tpGain = 1;
    save.ninja.xp += xpGain;
    save.ninja.tp += tpGain;
    recalcPlayer();
    // small heal on win
    save.ninja.hp = clamp(save.ninja.hp + Math.floor(save.ninja.maxHP*0.12), 1, save.ninja.maxHP);
  } else {
    save.stats.losses++;
    // lose: go to 1 HP (like “hospital needed”)
    save.ninja.hp = 1;
  }
  // tiny pause
  await sleep(220);
}

function renderFrame(px,ex,y,pW,eW,enemy){
  ctx.clearRect(0,0,window.innerWidth,window.innerHeight);

  // ground shadow band
  ctx.fillStyle="rgba(0,0,0,.08)";
  ctx.fillRect(0, y+10, window.innerWidth, 100);

  // little “party” look: draw 3 allied silhouettes in back (like screenshot) as flavor
  drawNinja(window.innerWidth*0.12, y-30, false, "katana");
  drawNinja(window.innerWidth*0.16, y-2, false, "staff");
  drawNinja(window.innerWidth*0.10, y+26, false, "katana");

  // main fighters
  drawNinja(px, y, false, pW);
  drawNinja(ex, y, true, eW);

  drawDust();
  drawFloatTexts();

  // faint UI dots like screenshot left icons (decor)
  ctx.globalAlpha=.35;
  ctx.fillStyle="#111";
  ctx.beginPath(); ctx.arc(34, 120, 12, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle="#ffd34a";
  ctx.beginPath(); ctx.arc(70, 120, 10, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle="#64d76a";
  ctx.beginPath(); ctx.arc(106, 120, 10, 0, Math.PI*2); ctx.fill();
  ctx.globalAlpha=1;
}

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* =========================
   Button wiring
========================= */
$("bFight").onclick=()=>startBattle();
$("skipBtn").onclick=()=>{ skip=true; };

/* Init */
recalcPlayer();
persist();
refreshTop();
</script>
</body>
</html>
