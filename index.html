<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Oz Ninja Town </title>
<style>
  html,body{
    margin:0;width:100%;height:100%;overflow:hidden;background:#0f0f12;
    font-family:system-ui,-apple-system,Segoe UI,Roboto;
    touch-action:manipulation;-webkit-user-select:none;user-select:none
  }
  :root{
    --pad-top: env(safe-area-inset-top);
    --pad-right: env(safe-area-inset-right);
    --pad-bottom: env(safe-area-inset-bottom);
    --pad-left: env(safe-area-inset-left);
    --wood1:#a56a3c; --wood2:#7a4b2a; --ink:#22140b; --accent:#ff7a18;
  }
  *{-webkit-tap-highlight-color:transparent}
  .hidden{display:none!important}

  /* ===== Top bar (condensed) ===== */
  #topbar{
    position:absolute; z-index:50;
    left:calc(10px + var(--pad-left));
    right:calc(10px + var(--pad-right));
    top:calc(10px + var(--pad-top));
    display:flex;gap:8px;align-items:center;justify-content:space-between;
    background:linear-gradient(var(--wood1),var(--wood2));
    border:2px solid rgba(0,0,0,.18);
    border-radius:14px;
    padding:8px 10px;
    box-shadow:0 10px 24px rgba(0,0,0,.25);
    color:var(--ink);
  }
  .barL,.barR{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip{
    display:flex;gap:6px;align-items:center;
    background:rgba(255,255,255,.22);
    border:1px solid rgba(0,0,0,.14);
    border-radius:999px;
    padding:5px 8px;
    font-weight:950;
    font-size:11px;
    line-height:1;
  }
  .chip b{font-family:ui-monospace,Menlo,monospace}
  .btn{
    border:0;border-radius:12px;padding:9px 10px;font-weight:950;
    background:#eee;color:#111; box-shadow:0 6px 14px rgba(0,0,0,.18);
    font-size:12px;
  }
  .btn.primary{background:var(--accent)}
  .btn.ghost{background:rgba(255,255,255,.25); border:1px solid rgba(0,0,0,.14);}
  .btn.small{padding:7px 9px;font-size:11px;border-radius:11px}
  .btn:disabled{opacity:.55}

  /* ===== Town screen ===== */
  #town{
    position:absolute; inset:0;
    padding-top:calc(56px + var(--pad-top));
  }

  /* Lower the entire island more */
  #townLayer{
    position:absolute; inset:0;
    transform: translateY(95px);  /* lowered from 60px -> 95px */
  }

  #townBg{
    position:absolute; inset:0;
    background-image:url("town.jpg");
    background-size:cover;
    background-position:center top;
    background-repeat:no-repeat;
  }

  .hotspot{
    position:absolute;
    background:transparent;
    border:0;
    border-radius:18px;
    padding:0;
    z-index:10;
    touch-action:manipulation;
  }

  .label{
    position:absolute;
    left:50%;
    bottom:10%;
    transform:translateX(-50%);
    padding:8px 12px;
    border-radius:999px;
    background:rgba(255,255,255,.75);
    border:1px solid rgba(0,0,0,.15);
    font-weight:1000;
    font-size:14px;
    color:#111;
    box-shadow:0 8px 20px rgba(0,0,0,.18);
    pointer-events:none;
    white-space:nowrap;
  }

  /* ===== Hit zone positions (UPDATED per your request) ===== */

  /* Top-left yellow building = Hospital (moved here) */
  #hsHospital { left:  6%; top: 36%; width: 30%; height: 22%; }

  /* Top-right red roof building = Dojo (moved here) */
  #hsDojo     { left: 30%; top: 26%; width: 38%; height: 24%; }

  /* Blue roof right building = Weapon Shop */
  #hsWeapon   { left: 64%; top: 32%; width: 30%; height: 22%; }

  /* Left-mid building = Recruit */
  #hsRecruit  { left:  6%; top: 46%; width: 30%; height: 22%; }

  /* Relic shop stays accessible on grass (until we add a relic building) */
  #hsRelic    { left: 58%; top: 46%; width: 24%; height: 16%; }

  /* Circle pit bottom-right = Battle */
  #hsFight    { left: 48%; top: 54%; width: 48%; height: 30%; }

  /* ===== Modals ===== */
  .modal{
    position:absolute; inset:0; z-index:80;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.35);
    padding:14px;
  }
  .card{
    width:min(680px,96%);
    background:linear-gradient(#f7edd6,#f0e0bf);
    border:2px solid rgba(0,0,0,.18);
    border-radius:18px;
    padding:14px;
    box-shadow:0 20px 50px rgba(0,0,0,.28);
    color:#23140b;
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .sp{justify-content:space-between}
  .title{margin:0;font-size:16px;font-weight:1000}
  .muted{opacity:.78;font-size:12px;line-height:1.25}
  .statGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .stat{
    background:rgba(255,255,255,.35);
    border:1px solid rgba(0,0,0,.12);
    border-radius:14px;
    padding:10px 12px;
    font-size:12px;
  }
  .stat b{font-family:ui-monospace,Menlo,monospace;font-size:13px}
  .list{
    margin-top:10px;
    max-height:320px; overflow:auto;
    border-radius:14px;
    border:1px solid rgba(0,0,0,.14);
    background:rgba(255,255,255,.22);
  }
  .item{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.10);
    font-size:12px;
  }
  .item:last-child{border-bottom:0}
  .pill{
    display:inline-block;
    padding:4px 8px;border-radius:999px;
    background:rgba(255,255,255,.55);
    border:1px solid rgba(0,0,0,.10);
    font-size:11px;font-weight:950;
  }
  .rar{font-weight:1000}
  .rar.Common{color:#555}
  .rar.Uncommon{color:#0d7a1c}
  .rar.Rare{color:#1a63c8}
  .rar.Epic{color:#7a2ac9}
  .rar.Legendary{color:#b06b00}

  /* ===== Battle ===== */
  #battle{ position:absolute; inset:0; z-index:60; }
  #battleBg{
    position:absolute; inset:0;
    background-image:url("battle.jpg"); /* pulls battle.jpg from repo */
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
    transform:scale(1.02);
  }
  #battleCanvas{position:absolute; inset:0; width:100%; height:100%}
  #battleTop{
    position:absolute; z-index:70;
    left:calc(10px + var(--pad-left));
    right:calc(10px + var(--pad-right));
    top:calc(10px + var(--pad-top));
    display:flex;gap:10px;align-items:center;justify-content:space-between;
  }
  .hpBox{
    flex:1 1 0;
    background:linear-gradient(var(--wood1),var(--wood2));
    border:2px solid rgba(0,0,0,.18);
    border-radius:14px;
    padding:10px 12px;
    box-shadow:0 10px 24px rgba(0,0,0,.22);
    color:var(--ink);
    min-width:0;
  }
  .hpName{font-weight:1000;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .hpBar{height:12px;border-radius:999px;background:rgba(0,0,0,.18);overflow:hidden;margin-top:6px;border:1px solid rgba(0,0,0,.12);}
  .hpFill{height:100%; width:100%; background:linear-gradient(#ffb845,#ff7a18);}
  .vs{font-weight:1000;font-size:22px;color:#fff;text-shadow:0 4px 10px rgba(0,0,0,.35);padding:0 10px}
  #skipBtn{
    position:absolute; z-index:70;
    top:calc(78px + var(--pad-top));
    left:50%; transform:translateX(-50%);
    background:rgba(255,255,255,.75);
    border:2px solid rgba(0,0,0,.18);
    border-radius:12px; padding:10px 14px; font-weight:1000;
  }
</style>
</head>

<body>
  <div id="topbar">
    <div class="barL">
      <div class="chip">Build <b>v6-HOSP+DOJO</b></div>
      <div class="chip">Active <b id="uiName">â€”</b></div>
      <div class="chip">HP <b id="uiHP">â€”</b></div>
      <div class="chip">â˜¯ <b id="uiKarma">0</b></div>
      <div class="chip">ðŸª™ <b id="uiGold">0</b></div>
      <div class="chip">Belt <b id="uiBelt">White</b></div>
      <div class="chip">Tier <b id="uiTier">1</b></div>
    </div>
    <div class="barR">
      <button class="btn ghost small" id="saveBtn">Save</button>
      <button class="btn ghost small" id="resetBtn">Reset</button>
    </div>
  </div>

  <!-- Town -->
  <div id="town">
    <div id="townLayer">
      <div id="townBg"></div>

      <!-- Hospital -->
      <button class="hotspot" id="hsHospital" aria-label="Hospital">
        <div class="label">Hospital</div>
      </button>

      <!-- Dojo -->
      <button class="hotspot" id="hsDojo" aria-label="Dojo">
        <div class="label">Dojo</div>
      </button>

      <!-- Weapon Shop -->
      <button class="hotspot" id="hsWeapon" aria-label="Weapon Shop">
        <div class="label">Weapon Shop</div>
      </button>

      <!-- Recruit -->
      <button class="hotspot" id="hsRecruit" aria-label="Recruit">
        <div class="label">Recruit</div>
      </button>

      <!-- Relic -->
      <button class="hotspot" id="hsRelic" aria-label="Relic Shop">
        <div class="label">Relic Shop</div>
      </button>

      <!-- Battle -->
      <button class="hotspot" id="hsFight" aria-label="Battle">
        <div class="label">Battle</div>
      </button>
    </div>
  </div>

  <!-- Battle -->
  <div id="battle" class="hidden">
    <div id="battleBg"></div>
    <canvas id="battleCanvas"></canvas>

    <div id="battleTop">
      <div class="hpBox">
        <div class="hpName" id="pName">You</div>
        <div class="hpBar"><div class="hpFill" id="pHPFill"></div></div>
      </div>
      <div class="vs">VS</div>
      <div class="hpBox">
        <div class="hpName" id="eName">Enemy</div>
        <div class="hpBar"><div class="hpFill" id="eHPFill"></div></div>
      </div>
    </div>

    <button id="skipBtn" class="btn">SKIP</button>
  </div>

  <!-- Dojo Modal -->
  <div class="modal hidden" id="dojoModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Dojo Training</h3>
        <button class="btn ghost small" id="closeDojo">Close</button>
      </div>
      <div class="muted">Train STR / AGI / END with Training Points (TP).</div>

      <div class="statGrid">
        <div class="stat">Strength<br><b id="stSTR">1</b></div>
        <div class="stat">Agility<br><b id="stAGI">1</b></div>
        <div class="stat">Endurance<br><b id="stEND">1</b></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="trainSTR">+ STR (1 TP)</button>
        <button class="btn primary" id="trainAGI">+ AGI (1 TP)</button>
        <button class="btn primary" id="trainEND">+ END (1 TP)</button>
      </div>

      <div class="muted" style="margin-top:10px">
        TP: <b id="tpHere">0</b> â€¢ Active: <b id="activeHere">â€”</b>
      </div>
    </div>
  </div>

  <!-- Recruit Modal -->
  <div class="modal hidden" id="recruitModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Recruit Ninjas</h3>
        <button class="btn ghost small" id="closeRecruit">Close</button>
      </div>
      <div class="muted" id="recruitLockText"></div>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="recruitBtn">Recruit (ðŸª™ <span id="recruitCost">120</span>)</button>
        <button class="btn ghost" id="setActiveBtn">Set Selected Active</button>
      </div>

      <div class="list" id="rosterList"></div>
      <div class="muted" style="margin-top:10px">Recruit unlocks at <b>Yellow belt</b>.</div>
    </div>
  </div>

  <!-- Weapon Modal -->
  <div class="modal hidden" id="weaponModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Weapon Shop</h3>
        <button class="btn ghost small" id="closeWeapon">Close</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn ghost" id="buyWeaponBtn">Buy Selected</button>
        <button class="btn primary" id="equipWeaponBtn">Equip Selected</button>
      </div>

      <div class="list" id="weaponList"></div>
    </div>
  </div>

  <!-- Relic Modal -->
  <div class="modal hidden" id="relicModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Relic Shop</h3>
        <button class="btn ghost small" id="closeRelic">Close</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn ghost" id="buyRelicBtn">Buy Selected</button>
        <button class="btn primary" id="equipRelicBtn">Equip Selected</button>
      </div>

      <div class="list" id="relicList"></div>
    </div>
  </div>

<script>
const SAVE_KEY="ninja_town_rpg_v6";

/* Helpers */
const $=(id)=>document.getElementById(id);
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function rand(a,b){return a+Math.random()*(b-a);}
function rint(a,b){return Math.floor(rand(a,b+1));}
function pick(a){return a[Math.floor(Math.random()*a.length)];}
function id(prefix="id"){return prefix+"_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16);}

const BELTS=["White","Yellow","Orange","Green","Blue","Brown","Black"];
const BELT_XP=[0,50,150,350,700,1200,2000];
function beltFromXP(xp){let idx=0;for(let i=0;i<BELT_XP.length;i++) if(xp>=BELT_XP[i]) idx=i; return BELTS[Math.min(idx,BELTS.length-1)];}
function beltIndex(b){return Math.max(0,BELTS.indexOf(b));}

const RARITIES=["Common","Uncommon","Rare","Epic","Legendary"];
const RARITY_MULT={Common:1.0,Uncommon:1.12,Rare:1.28,Epic:1.45,Legendary:1.65};
function rollRarity(tier){
  const r=Math.random(); const boost=Math.min(0.18,tier*0.015);
  if(r<0.03+boost*0.25) return "Legendary";
  if(r<0.08+boost*0.40) return "Epic";
  if(r<0.20+boost*0.60) return "Rare";
  if(r<0.50+boost*0.75) return "Uncommon";
  return "Common";
}
function makeWeapon(rarity){
  const mult=RARITY_MULT[rarity]||1.0;
  const name=pick(["Katana","Tanto","Naginata","War Fan","Iron Staff","Moon Blade","Storm Edge"]);
  const bonus={str:Math.max(0,Math.round(1*mult+rand(0,1.2))),
               agi:Math.max(0,Math.round(0.8*mult+rand(0,1.0))),
               end:Math.max(0,Math.round(0.3*mult+rand(0,0.8)))};
  const cost=Math.round((60+25*RARITIES.indexOf(rarity))*mult);
  return {id:id("w"),rarity,name,bonus,cost};
}
function makeRelic(rarity){
  const mult=RARITY_MULT[rarity]||1.0;
  const name=pick(["Karma Bead","Smoke Ring","Focus Charm","Phoenix Feather","Shadow Seal","Lotus Medallion"]);
  const bonus={str:Math.max(0,Math.round(0.4*mult+rand(0,0.8))),
               agi:Math.max(0,Math.round(1.0*mult+rand(0,1.1))),
               end:Math.max(0,Math.round(1.2*mult+rand(0,1.2)))};
  const cost=Math.round((35+20*RARITIES.indexOf(rarity))*mult);
  return {id:id("r"),rarity,name,bonus,cost};
}
function makeNinja(name=null){
  const first=["Ryu","Hana","Jin","Kira","Sora","Mako","Taro","Yumi","Akio","Ren","Aya","Kai","Noa","Rin"];
  const last=["Shadow","Steel","Blaze","Mist","Fang","Lotus","Night","Storm","Viper","Drift"];
  const nm=name||`${pick(first)} ${pick(last)}`;
  return {id:id("n"),name:nm,xp:0,level:1,tp:0,
    base:{str:1,agi:1,end:1},
    equip:{weaponId:null,relicId:null},
    hp:70,maxHP:70
  };
}

/* ===== DEFAULT SAVE (Starting ninja gets 10 TP) ===== */
function defaultSave(){
  const starter=makeNinja("Andy Holloway");
  starter.tp = 10; /* <-- STARTING TP */
  return {
    currency:{karma:0,gold:120},
    ladder:{tier:1,wins:0,losses:0,winsThisTier:0},
    ninjas:[starter],
    activeNinjaId:starter.id,
    inventory:{weapons:[],relics:[]},
    shop:{weapons:[],relics:[]}
  };
}

let save=load();
function load(){
  try{
    const raw=localStorage.getItem(SAVE_KEY);
    if(!raw) return defaultSave();
    const s=JSON.parse(raw);
    if(!s?.ninjas?.length) return defaultSave();
    return s;
  }catch{ return defaultSave(); }
}
function persist(){ localStorage.setItem(SAVE_KEY, JSON.stringify(save)); }
function activeNinja(){ return save.ninjas.find(n=>n.id===save.activeNinjaId) || save.ninjas[0]; }
function belt(){ return beltFromXP(activeNinja().xp); }

function refreshTop(){
  const a=activeNinja();
  $("uiName").textContent=a.name;
  $("uiHP").textContent=`${a.hp}/${a.maxHP}`;
  $("uiKarma").textContent=save.currency.karma;
  $("uiGold").textContent=save.currency.gold;
  $("uiBelt").textContent=belt();
  $("uiTier").textContent=save.ladder.tier;
}

/* Modals */
function openModal(id){ $(id).classList.remove("hidden"); }
function closeModal(id){ $(id).classList.add("hidden"); }
$("saveBtn").onclick=()=>{ persist(); refreshTop(); };
$("resetBtn").onclick=()=>{ localStorage.removeItem(SAVE_KEY); save=defaultSave(); persist(); refreshTop(); };

/* Dojo */
function renderDojo(){
  const a=activeNinja();
  $("activeHere").textContent=a.name;
  $("tpHere").textContent=a.tp;
  $("stSTR").textContent=a.base.str;
  $("stAGI").textContent=a.base.agi;
  $("stEND").textContent=a.base.end;
  $("trainSTR").disabled = a.tp<=0;
  $("trainAGI").disabled = a.tp<=0;
  $("trainEND").disabled = a.tp<=0;
}
function spendTP(stat){
  const a=activeNinja();
  if(a.tp<=0) return;
  a.tp--; a.base[stat]++; persist(); refreshTop(); renderDojo();
}
$("trainSTR").onclick=()=>spendTP("str");
$("trainAGI").onclick=()=>spendTP("agi");
$("trainEND").onclick=()=>spendTP("end");
$("closeDojo").onclick=()=>closeModal("dojoModal");

/* Recruit / Weapon / Relic modals kept minimal */
$("closeRecruit").onclick=()=>closeModal("recruitModal");
$("closeWeapon").onclick=()=>closeModal("weaponModal");
$("closeRelic").onclick=()=>closeModal("relicModal");

/* Hospital = full heal */
function hospitalHeal(){
  const a=activeNinja();
  a.hp = a.maxHP;
  persist(); refreshTop();
}

/* Battle tab exists but you already have the battle engine in your version.
   This stub just switches to battle screen so battle.jpg is visible.
   If your repo has the full battle engine, keep that code below and call startBattle(). */
function showBattle(on){
  document.getElementById("battle").classList.toggle("hidden", !on);
  document.getElementById("town").classList.toggle("hidden", on);
}
$("skipBtn").onclick=()=>showBattle(false);

/* Tie building actions */
$("hsHospital").onclick=()=>hospitalHeal();
$("hsDojo").onclick=()=>{ renderDojo(); openModal("dojoModal"); };
$("hsWeapon").onclick=()=>openModal("weaponModal");
$("hsRecruit").onclick=()=>openModal("recruitModal");
$("hsRelic").onclick=()=>openModal("relicModal");
$("hsFight").onclick=()=>showBattle(true);

/* init */
persist();
refreshTop();
</script>
</body>
</html>
