<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Ninja Clan RPG (Step 2)</title>

<style>
  html,body{
    margin:0;width:100%;height:100%;overflow:hidden;background:#0f0f12;
    font-family:system-ui,-apple-system,Segoe UI,Roboto;
    touch-action:manipulation;-webkit-user-select:none;user-select:none
  }
  :root{
    --pad-top: env(safe-area-inset-top);
    --pad-right: env(safe-area-inset-right);
    --pad-bottom: env(safe-area-inset-bottom);
    --pad-left: env(safe-area-inset-left);
    --wood1:#a56a3c; --wood2:#7a4b2a; --ink:#22140b; --accent:#ff7a18;
  }
  *{-webkit-tap-highlight-color:transparent}
  .hidden{display:none!important}

  /* ===== Top bar ===== */
  #topbar{
    position:absolute; z-index:50;
    left:calc(10px + var(--pad-left));
    right:calc(10px + var(--pad-right));
    top:calc(10px + var(--pad-top));
    display:flex;gap:8px;align-items:center;justify-content:space-between;
    background:linear-gradient(var(--wood1),var(--wood2));
    border:2px solid rgba(0,0,0,.18);
    border-radius:14px;
    padding:8px 10px;
    box-shadow:0 10px 24px rgba(0,0,0,.25);
    color:var(--ink);
  }
  .barL,.barR{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip{
    display:flex;gap:6px;align-items:center;
    background:rgba(255,255,255,.22);
    border:1px solid rgba(0,0,0,.14);
    border-radius:999px;
    padding:5px 8px;
    font-weight:950;
    font-size:11px;
    line-height:1;
  }
  .chip b{font-family:ui-monospace,Menlo,monospace}
  .btn{
    border:0;border-radius:12px;padding:9px 10px;font-weight:950;
    background:#eee;color:#111; box-shadow:0 6px 14px rgba(0,0,0,.18);
    font-size:12px;
  }
  .btn.primary{background:var(--accent)}
  .btn.ghost{background:rgba(255,255,255,.25); border:1px solid rgba(0,0,0,.14);}
  .btn.small{padding:7px 9px;font-size:11px;border-radius:11px}
  .btn:disabled{opacity:.55}

  /* ===== Town ===== */
  #town{ position:absolute; inset:0; padding-top:calc(56px + var(--pad-top)); }
  #townLayer{ position:absolute; inset:0; transform: translateY(95px); }
  #townBg{
    position:absolute; inset:0;
    background-image:url("town.jpg");
    background-size:cover;
    background-position:center top;
    background-repeat:no-repeat;
  }
  .hotspot{ position:absolute; background:transparent; border:0; border-radius:18px; padding:0; z-index:10; }
  .label{
    position:absolute; left:50%; bottom:10%;
    transform:translateX(-50%);
    padding:8px 12px;
    border-radius:999px;
    background:rgba(255,255,255,.78);
    border:1px solid rgba(0,0,0,.15);
    font-weight:1000;
    font-size:14px;
    color:#111;
    box-shadow:0 8px 20px rgba(0,0,0,.18);
    pointer-events:none;
    white-space:nowrap;
  }

  /* Hotspots */
  #hsHospital { left:  2%; top: 11%; width: 38%; height: 22%; }
  #hsDojo     { left: 66%; top: 10%; width: 32%; height: 26%; }
  #hsDaimyo   { left: 33%; top: 26%; width: 36%; height: 22%; }
  #hsRelic    { left:  4%; top: 40%; width: 32%; height: 20%; }
  #hsWeapon   { left: 62%; top: 33%; width: 34%; height: 22%; }
  #hsRecruit  { left:  6%; top: 60%; width: 36%; height: 22%; }
  #hsFight    { left: 49%; top: 51%; width: 47%; height: 22%; }

  /* ===== Modals ===== */
  .modal{
    position:absolute; inset:0; z-index:80;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.35);
    padding:14px;
  }
  .card{
    width:min(720px,96%);
    background:linear-gradient(#f7edd6,#f0e0bf);
    border:2px solid rgba(0,0,0,.18);
    border-radius:18px;
    padding:14px;
    box-shadow:0 20px 50px rgba(0,0,0,.28);
    color:#23140b;
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .sp{justify-content:space-between}
  .title{margin:0;font-size:16px;font-weight:1000}
  .muted{opacity:.78;font-size:12px;line-height:1.25}
  .statGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .stat{
    background:rgba(255,255,255,.35);
    border:1px solid rgba(0,0,0,.12);
    border-radius:14px;
    padding:10px 12px;
    font-size:12px;
  }
  .stat b{font-family:ui-monospace,Menlo,monospace;font-size:13px}
  .list{
    margin-top:10px;
    max-height:340px; overflow:auto;
    border-radius:14px;
    border:1px solid rgba(0,0,0,.14);
    background:rgba(255,255,255,.22);
  }
  .item{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.10);
    font-size:12px;
  }
  .item:last-child{border-bottom:0}
  .pill{
    display:inline-block;
    padding:4px 8px;border-radius:999px;
    background:rgba(255,255,255,.55);
    border:1px solid rgba(0,0,0,.10);
    font-size:11px;font-weight:950;
  }
  .rar{font-weight:1000}
  .rar.Common{color:#555}
  .rar.Uncommon{color:#0d7a1c}
  .rar.Rare{color:#1a63c8}
  .rar.Epic{color:#7a2ac9}
  .rar.Legendary{color:#b06b00}

  /* Tabs */
  .tabs{display:flex;gap:8px;margin-top:8px}
  .tab{
    padding:8px 10px;border-radius:999px;font-weight:1000;font-size:12px;
    border:1px solid rgba(0,0,0,.14);
    background:rgba(255,255,255,.35);
  }
  .tab.active{background:rgba(255,255,255,.65)}
  .tabPane{margin-top:10px}

  /* Dojo preview */
  #dojoPreviewWrap{
    display:flex;gap:12px;align-items:center;flex-wrap:wrap;
    background:rgba(255,255,255,.22);
    border:1px solid rgba(0,0,0,.12);
    border-radius:14px;
    padding:10px 12px;
    margin-top:10px;
  }
  #dojoCanvas{
    width:120px;height:120px;
    border-radius:14px;
    border:1px solid rgba(0,0,0,.12);
    background:rgba(0,0,0,.08);
  }

  /* Battle placeholder */
  #battle{ position:absolute; inset:0; z-index:60; }
  #battleBg{
    position:absolute; inset:0;
    background-image:url("battle.jpg");
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
    transform:scale(1.02);
  }
  #battleOverlay{
    position:absolute; inset:0; display:flex; align-items:flex-end; justify-content:center;
    padding:calc(18px + var(--pad-bottom));
    z-index:70;
  }
  #battleNote{
    width:min(720px,96%);
    background:rgba(255,255,255,.85);
    border:2px solid rgba(0,0,0,.18);
    border-radius:14px;
    padding:12px 12px;
    font-weight:950;
    text-align:center;
  }
</style>
</head>
<body>
  <div id="topbar">
    <div class="barL">
      <div class="chip">Build <b>STEP-2</b></div>
      <div class="chip">Active <b id="uiName">â€”</b></div>
      <div class="chip">Lv <b id="uiLevel">â€”</b></div>
      <div class="chip">HP <b id="uiHP">â€”</b></div>
      <div class="chip">TP <b id="uiTP">â€”</b></div>
      <div class="chip">Belt <b id="uiBelt">â€”</b></div>
      <div class="chip">ðŸª™ <b id="uiGold">0</b></div>
      <div class="chip">â˜¯ <b id="uiKarma">0</b></div>
    </div>
    <div class="barR">
      <button class="btn ghost small" id="dailyBtn">Meditate</button>
      <button class="btn ghost small" id="profilesBtn">Profiles</button>
      <button class="btn ghost small" id="saveBtn">Save</button>
      <button class="btn ghost small" id="resetBtn">Reset Slot</button>
    </div>
  </div>

  <!-- Town -->
  <div id="town">
    <div id="townLayer">
      <div id="townBg"></div>

      <button class="hotspot" id="hsHospital"><div class="label">Hospital</div></button>
      <button class="hotspot" id="hsDojo"><div class="label">Dojo</div></button>
      <button class="hotspot" id="hsDaimyo"><div class="label">Daimyo</div></button>
      <button class="hotspot" id="hsRelic"><div class="label">Relic Shop</div></button>
      <button class="hotspot" id="hsWeapon"><div class="label">Weapon Shop</div></button>
      <button class="hotspot" id="hsRecruit"><div class="label">Recruit</div></button>
      <button class="hotspot" id="hsFight"><div class="label">Battle</div></button>
    </div>
  </div>

  <!-- Battle placeholder -->
  <div id="battle" class="hidden">
    <div id="battleBg"></div>
    <div id="battleOverlay">
      <div id="battleNote">
        Step 2 uses a placeholder battle screen to confirm <b>battle.jpg</b> loads.
        <div style="margin-top:10px">
          <button class="btn" id="battleBackBtn">BACK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dojo Modal -->
  <div class="modal hidden" id="dojoModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Dojo</h3>
        <button class="btn ghost small" id="closeDojo">Close</button>
      </div>

      <div class="tabs">
        <button class="tab active" id="tabTrain">Training</button>
        <button class="tab" id="tabNinja">Ninja</button>
      </div>

      <div class="tabPane" id="paneTrain">
        <div class="muted">Level = TP spent + 1. Training costs increase at higher stats (soft caps).</div>

        <div class="statGrid">
          <div class="stat">Strength<br><b id="stSTR">1</b><div class="muted">Cost: <b id="cSTR">1</b> TP</div></div>
          <div class="stat">Agility<br><b id="stAGI">1</b><div class="muted">Cost: <b id="cAGI">1</b> TP</div></div>
          <div class="stat">Endurance<br><b id="stEND">1</b><div class="muted">Cost: <b id="cEND">1</b> TP</div></div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="trainSTR">+ STR</button>
          <button class="btn primary" id="trainAGI">+ AGI</button>
          <button class="btn primary" id="trainEND">+ END</button>
        </div>

        <div class="muted" style="margin-top:10px">
          TP: <b id="tpHere">0</b> â€¢ Active: <b id="activeHere">â€”</b>
        </div>
      </div>

      <div class="tabPane hidden" id="paneNinja">
        <div class="muted">Stats + equipment. Equip items you own.</div>

        <div id="dojoPreviewWrap">
          <canvas id="dojoCanvas" width="120" height="120"></canvas>
          <div style="min-width:200px;flex:1">
            <div style="font-weight:1000;font-size:14px" id="djName">â€”</div>
            <div class="muted" id="djLine">â€”</div>
            <div class="muted" id="djBelt">â€”</div>
          </div>
        </div>

        <div class="statGrid">
          <div class="stat">Base STR/AGI/END<br><b id="djBase">â€”</b></div>
          <div class="stat">Equip Bonus<br><b id="djBonus">â€”</b></div>
          <div class="stat">Derived ATK/DEF/DODGE<br><b id="djDerived">â€”</b></div>
        </div>

        <div class="row" style="margin-top:10px;align-items:flex-end">
          <div style="flex:1;min-width:220px">
            <div class="muted" style="margin-bottom:6px">Weapon (owned)</div>
            <select id="djWeaponSelect" style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.18)">
              <option value="">None</option>
            </select>
          </div>
          <button class="btn primary" id="djEquipWeapon">Equip</button>
          <button class="btn ghost" id="djUnequipWeapon">Unequip</button>
        </div>

        <div class="row" style="margin-top:10px;align-items:flex-end">
          <div style="flex:1;min-width:220px">
            <div class="muted" style="margin-bottom:6px">Relic (owned)</div>
            <select id="djRelicSelect" style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.18)">
              <option value="">None</option>
            </select>
          </div>
          <button class="btn primary" id="djEquipRelic">Equip</button>
          <button class="btn ghost" id="djUnequipRelic">Unequip</button>
        </div>

        <div class="muted" style="margin-top:10px">
          Equipped: <b id="djEquipped">â€”</b>
        </div>
      </div>
    </div>
  </div>

  <!-- Daimyo Modal -->
  <div class="modal hidden" id="daiModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Daimyo</h3>
        <button class="btn ghost small" id="closeDai">Close</button>
      </div>
      <div class="muted">Belt is tied to TP spent (Level = TP spent + 1).</div>

      <div class="statGrid">
        <div class="stat">Belt<br><b id="dBelt">â€”</b></div>
        <div class="stat">Level<br><b id="dLevel">â€”</b></div>
        <div class="stat">TP Spent<br><b id="dSpent">â€”</b></div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="stat" style="flex:1">Belts: Yellow 5 â€¢ Orange 12 â€¢ Green 20 â€¢ Blue 40 â€¢ Brown 60 â€¢ Black 80</div>
      </div>
    </div>
  </div>

  <!-- Recruit Modal -->
  <div class="modal hidden" id="recruitModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Recruit</h3>
        <button class="btn ghost small" id="closeRecruit">Close</button>
      </div>

      <div class="muted">Recruit ninjas to grow your clan. More ninjas = advantage in Step 3 battles.</div>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="recruitBtn">Recruit (ðŸª™ <span id="recruitCost">200</span>)</button>
        <button class="btn ghost" id="setActiveBtn">Set Selected Active</button>
      </div>

      <div class="list" id="rosterList"></div>
    </div>
  </div>

  <!-- Weapon Shop Modal -->
  <div class="modal hidden" id="weaponModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Weapon Shop</h3>
        <button class="btn ghost small" id="closeWeapon">Close</button>
      </div>

      <div class="muted">Weapons cost ðŸª™ gold. Stronger stat bonuses cost more.</div>

      <div class="row" style="margin-top:10px">
        <button class="btn ghost" id="buyWeaponBtn">Buy Selected</button>
        <button class="btn primary" id="equipWeaponBtn">Equip Selected</button>
        <button class="btn ghost" id="refreshWeaponBtn">Refresh</button>
      </div>

      <div class="list" id="weaponList"></div>
    </div>
  </div>

  <!-- Relic Shop Modal -->
  <div class="modal hidden" id="relicModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Relic Shop</h3>
        <button class="btn ghost small" id="closeRelic">Close</button>
      </div>

      <div class="muted">Relics cost â˜¯ karma. They add smaller but useful bonuses.</div>

      <div class="row" style="margin-top:10px">
        <button class="btn ghost" id="buyRelicBtn">Buy Selected</button>
        <button class="btn primary" id="equipRelicBtn">Equip Selected</button>
        <button class="btn ghost" id="refreshRelicBtn">Refresh</button>
      </div>

      <div class="list" id="relicList"></div>
    </div>
  </div>

  <!-- Battle Select Modal -->
  <div class="modal hidden" id="battleSelectModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Choose Battle</h3>
        <button class="btn ghost small" id="closeBattleSelect">Close</button>
      </div>
      <div class="muted">Pick an enemy clan. Step 3 adds the real battle engine + animations.</div>
      <div class="list" id="battleList"></div>
    </div>
  </div>

  <!-- Profiles Modal -->
  <div class="modal hidden" id="profilesModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Profiles</h3>
        <button class="btn ghost small" id="closeProfiles">Close</button>
      </div>
      <div class="muted">3 save slots. Switch anytime. Each slot saves its own clan.</div>
      <div class="list" id="profilesList"></div>
    </div>
  </div>

  <script>
   /* ======================================================
   STEP 2 â€” FULL TOWN LOOP
====================================================== */

const PROFILE_KEY="ninja_rebuild_profiles_step2_v2";
const $ = (id)=>document.getElementById(id);
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const rand=(a,b)=>a+Math.random()*(b-a);
const rint=(a,b)=>Math.floor(rand(a,b+1));
const pick=a=>a[Math.floor(Math.random()*a.length)];
const uid=p=>p+"_"+Math.random().toString(16).slice(2)+"_"+Date.nowAGI=n.base.agi+eq.agi;
  const END=n.base.end+eq.end;

  const spent=tpSpent(n);
  n.level = 1 + spent;

  n.maxHP = 60 + END*12 + n.level*4;
  n.hp = clamp(n.hp ?? n.maxHP, 1, n.maxHP);

  n.derived = {
    STR,AGI,END,
    atk: Math.floor(6 + STR*3 + n.level*1.2),
    def: Math.floor(END + n.level*0.6),
    dodge: clamp(0.03 + AGI*0.015, 0.03, 0.30)
  };
}

/* ---------- Modal helpers ---------- */
function openModal(id){ $(id).classList.remove("hidden"); }
function closeModal(id){ $(id).classList.add("hidden"); }

/* ---------- Top UI ---------- */
function refreshTop(){
  for(const n of save.ninjas) recalc(n);
  const a=activeNinja();
  const spent=tpSpent(a);
  const belt=beltFromSpent(spent);

  $("uiName").textContent=a.name;
  $("uiLevel").textContent=a.level;
  $("uiHP").textContent=`${a.hp}/${a.maxHP}`;
  $("uiTP").textContent=a.tp;
  $("uiBelt").textContent=belt;
  $("uiGold").textContent=save.currency.gold;
  $("uiKarma").textContent=save.currency.karma;
}

/* ---------- Dojo tabs ---------- */
function setDojoTab(which){
  $("tabTrain").classList.toggle("active", which==="train");
  $("tabNinja").classList.toggle("active", which==="ninja");
  $("paneTrain").classList.toggle("hidden", which!=="train");
  $("paneNinja").classList.toggle("hidden", which!=="ninja");
  if(which==="train") renderDojoTraining();
  if(which==="ninja") renderDojoNinja();
}
$("tabTrain").onclick=()=>setDojoTab("train");
$("tabNinja").onclick=()=>setDojoTab("ninja");
$("closeDojo").onclick=()=>closeModal("dojoModal");

function renderDojoTraining(){
  const a=activeNinja(); recalc(a);
  $("activeHere").textContent=a.name;
  $("tpHere").textContent=a.tp;

  $("stSTR").textContent=a.base.str;
  $("stAGI").textContent=a.base.agi;
  $("stEND").textContent=a.base.end;

  const cS=trainCost(a.base.str);
  const cA=trainCost(a.base.agi);
  const cE=trainCost(a.base.end);
  $("cSTR").textContent=cS;
  $("cAGI").textContent=cA;
  $("cEND").textContent=cE;

  $("trainSTR").disabled=a.tp<cS;
  $("trainAGI").disabled=a.tp<cA;
  $("trainEND").disabled=a.tp<cE;
}
function spendTP(stat){
  const a=activeNinja();
  const cost=trainCost(a.base[stat]);
  if(a.tp<cost) return;
  a.tp-=cost;
  a.base[stat] += 1;
  recalc(a);
  persist(); refreshTop();
  renderDojoTraining();
  renderDojoNinja();
}
$("trainSTR").onclick=()=>spendTP("str");
$("trainAGI").onclick=()=>spendTP("agi");
$("trainEND").onclick=()=>spendTP("end");

/* ---------- Dojo ninja preview (belt + simple arms) ---------- */
function roundRect(ctx,x,y,w,h,r,fill=true){
  const rr=Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y, x+w,y+h, rr);
  ctx.arcTo(x+w,y+h, x,y+h, rr);
  ctx.arcTo(x,y+h, x,y, rr);
  ctx.arcTo(x,y, x+w,y, rr);
  ctx.closePath();
  if(fill) ctx.fill();
}
function drawDojoPreview(){
  const c=$("dojoCanvas");
  const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);

  const a=activeNinja(); recalc(a);
  const belt=beltFromSpent(tpSpent(a));
  const beltCol=BELT_COLOR[belt]||"#f5f5f5";
  const eq=equipBonus(a);

  ctx.save();
  ctx.translate(60,78);

  // head
  ctx.fillStyle="#111";
  ctx.beginPath(); ctx.arc(0,-38,16,0,Math.PI*2); ctx.fill();

  // mask strip
  ctx.fillStyle="#f3d6b6";
  roundRect(ctx,-12,-44,24,10,5,true);
  ctx.fillStyle="#111"; ctx.fillRect(-10,-40,20,3);

  // body
  ctx.fillStyle="#111";
  roundRect(ctx,-18,-26,36,36,12,true);

  // arms (simple)
  ctx.strokeStyle="#111";
  ctx.lineWidth=6;
  ctx.lineCap="round";
  ctx.beginPath(); ctx.moveTo(-16,-18); ctx.lineTo(-30,-4); ctx.stroke();
  ctx.beginPath(); ctx.moveTo( 16,-18); ctx.lineTo( 32,-6); ctx.stroke();

  // belt
  ctx.fillStyle=beltCol;
  roundRect(ctx,-18,-6,36,8,4,true);

  // legs
  ctx.fillStyle="#111";
  roundRect(ctx,-16,10,14,12,6,true);
  roundRect(ctx,  2,10,14,12,6,true);

  // weapon hint
  ctx.strokeStyle = eq.weapon ? "#cfd2d6" : "rgba(255,255,255,.25)";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(26,-10);
  ctx.lineTo(42,-28);
  ctx.stroke();

  ctx.restore();
}
function renderDojoNinja(){
  const a=activeNinja(); recalc(a);
  const eq=equipBonus(a);
  const spent=tpSpent(a);
  const belt=beltFromSpent(spent);

  $("djName").textContent = `${a.name} (Lv ${a.level})`;
  $("djLine").textContent = `HP ${a.hp}/${a.maxHP} â€¢ TP ${a.tp} â€¢ Spent ${spent}`;
  $("djBelt").textContent = `Belt: ${belt}`;

  $("djBase").textContent = `${a.base.str}/${a.base.agi}/${a.base.end}`;
  $("djBonus").textContent = `+${eq.str}/+${eq.agi}/+${eq.end}`;
  $("djDerived").textContent = `${a.derived.atk}/${a.derived.def}/${Math.round(a.derived.dodge*100)}%`;

  const wName = eq.weapon ? `${eq.weapon.name} (${eq.weapon.rarity})` : "None";
  const rName = eq.relic ? `${eq.relic.name} (${eq.relic.rarity})` : "None";
  $("djEquipped").textContent = `Weapon: ${wName} â€¢ Relic: ${rName}`;

  // Owned weapon select
  const wSel=$("djWeaponSelect");
  wSel.innerHTML = `<option value="">None</option>`;
  for(const w of save.inventory.weapons){
    const opt=document.createElement("option");
    opt.value=w.id;
    opt.textContent=`${w.name} [${w.rarity}] (+${w.bonus.str}/+${w.bonus.agi}/+${w.bonus.end})`;
    if(a.equip.weaponId===w.id) opt.selected=true;
    wSel.appendChild(opt);
  }

  // Owned relic select
  const rSel=$("djRelicSelect");
  rSel.innerHTML = `<option value="">None</option>`;
  for(const r of save.inventory.relics){
    const opt=document.createElement("option");
    opt.value=r.id;
    opt.textContent=`${r.name} [${r.rarity}] (+${r.bonus.str}/+${r.bonus.agi}/+${r.bonus.end})`;
    if(a.equip.relicId===r.id) opt.selected=true;
    rSel.appendChild(opt);
  }

  drawDojoPreview();
}

$("djEquipWeapon").onclick=()=>{
  const a=activeNinja();
  a.equip.weaponId = $("djWeaponSelect").value || null;
  recalc(a); persist(); refreshTop(); renderDojoNinja();
};
$("djUnequipWeapon").onclick=()=>{
  const a=activeNinja();
  a.equip.weaponId=null;
  recalc(a); persist(); refreshTop(); renderDojoNinja();
};
$("djEquipRelic").onclick=()=>{
  const a=activeNinja();
  a.equip.relicId = $("djRelicSelect").value || null;
  recalc(a); persist(); refreshTop(); renderDojoNinja();
};
$("djUnequipRelic").onclick=()=>{
  const a=activeNinja();
  a.equip.relicId=null;
  recalc(a); persist(); refreshTop(); renderDojoNinja();
};

/* ---------- Daimyo ---------- */
$("closeDai").onclick=()=>closeModal("daiModal");
function renderDaimyo(){
  const a=activeNinja();
  const spent=tpSpent(a);
  $("dBelt").textContent=beltFromSpent(spent);
  $("dLevel").textContent=a.level;
  $("dSpent").textContent=spent;
}

/* ---------- Recruit ---------- */
$("closeRecruit").onclick=()=>closeModal("recruitModal");
let rosterSelectedId=null;

function recruitCost(){
  return 200 + (save.ninjas.length-1)*150;
}
function renderRoster(){
  const cost=recruitCost();
  $("recruitCost").textContent=cost;
  $("recruitBtn").disabled = save.currency.gold < cost;

  const list=$("rosterList");
  list.innerHTML="";
  for(const n of save.ninjas){
    recalc(n);
    const isActive = n.id===save.activeId;
    const selected = n.id===rosterSelectedId;

    const row=document.createElement("div");
    row.className="item";
    row.style.background = selected ? "rgba(255,255,255,.35)" : "";
    row.innerHTML=`
      <div style="min-width:0">
        <div style="font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
          ${n.name} <span class="pill">Lv${n.level}</span> ${isActive?`<span class="pill">ACTIVE</span>`:""}
        </div>
        <div class="muted">STR ${n.derived.STR} â€¢ AGI ${n.derived.AGI} â€¢ END ${n.derived.END} â€¢ HP ${n.hp}/${n.maxHP}</div>
      </div>
      <button class="btn ghost small" data-sel="${n.id}">${selected?"Selected":"Select"}</button>
    `;
    list.appendChild(row);
  }
  list.querySelectorAll("button[data-sel]").forEach(btn=>{
    btn.onclick=()=>{ rosterSelectedId=btn.getAttribute("data-sel"); renderRoster(); };
  });

  $("setActiveBtn").disabled = !rosterSelectedId;
}

$("recruitBtn").onclick=()=>{
  const cost=recruitCost();
  if(save.currency.gold < cost) return;

  save.currency.gold -= cost;
  const n=makeNinja();
  n.tp = 0; // recruits start with 0 TP (can change later)
  recalc(n);
  save.ninjas.push(n);
  rosterSelectedId=n.id;

  persist(); refreshTop(); renderRoster();
};
$("setActiveBtn").onclick=()=>{
  if(!rosterSelectedId) return;
  save.activeId=rosterSelectedId;
  persist(); refreshTop(); renderRoster();
};/* ---------- Shops ---------- */
let weaponSelectedId=null, relicSelectedId=null;

function ensureWeaponStock(){
  if(!save.shop.weapons?.length){
    save.shop.weapons = Array.from({length:6}, ()=>makeWeapon());
  }
}
function ensureRelicStock(){
  if(!save.shop.relics?.length){
    save.shop.relics = Array.from({length:6}, ()=>makeRelic());
  }
}

function renderWeaponShop(){
  ensureWeaponStock();
  const list=$("weaponList"); list.innerHTML="";

  for(const w of save.shop.weapons){
    const selected = w.id===weaponSelectedId;
    const owned = save.inventory.weapons.some(x=>x.id===w.id);

    const row=document.createElement("div");
    row.className="item";
    row.style.background = selected ? "rgba(255,255,255,.35)" : "";
    row.innerHTML=`
      <div style="min-width:0">
        <div style="font-weight:1000">
          ${w.name} <span class="pill rar ${w.rarity}">${w.rarity}</span>
          <span class="pill">ðŸª™ ${w.cost}</span> ${owned?`<span class="pill">OWNED</span>`:""}
        </div>
        <div class="muted">+STR ${w.bonus.str} â€¢ +AGI ${w.bonus.agi} â€¢ +END ${w.bonus.end}</div>
      </div>
      <button class="btn ghost small" data-wsel="${w.id}">${selected?"Selected":"Select"}</button>
    `;
    list.appendChild(row);
  }

  list.querySelectorAll("button[data-wsel]").forEach(b=>{
    b.onclick=()=>{ weaponSelectedId=b.getAttribute("data-wsel"); renderWeaponShop(); };
  });

  const sel = save.shop.weapons.find(x=>x.id===weaponSelectedId) || null;
  $("buyWeaponBtn").disabled = !sel || save.currency.gold < sel.cost || save.inventory.weapons.some(x=>x.id===sel.id);
  $("equipWeaponBtn").disabled = !sel || (!save.inventory.weapons.some(x=>x.id===sel.id) && save.currency.gold < sel.cost);
}

function renderRelicShop(){
  ensureRelicStock();
  const list=$("relicList"); list.innerHTML="";

  for(const r of save.shop.relics){
    const selected = r.id===relicSelectedId;
    const owned = save.inventory.relics.some(x=>x.id===r.id);

    const row=document.createElement("div");
    row.className="item";
    row.style.background = selected ? "rgba(255,255,255,.35)" : "";
    row.innerHTML=`
      <div style="min-width:0">
        <div style="font-weight:1000">
          ${r.name} <span class="pill rar ${r.rarity}">${r.rarity}</span>
          <span class="pill">â˜¯ ${r.cost}</span> ${owned?`<span class="pill">OWNED</span>`:""}
        </div>
        <div class="muted">+STR ${r.bonus.str} â€¢ +AGI ${r.bonus.agi} â€¢ +END ${r.bonus.end}</div>
      </div>
      <button class="btn ghost small" data-rsel="${r.id}">${selected?"Selected":"Select"}</button>
    `;
    list.appendChild(row);
  }

  list.querySelectorAll("button[data-rsel]").forEach(b=>{
    b.onclick=()=>{ relicSelectedId=b.getAttribute("data-rsel"); renderRelicShop(); };
  });

  const sel = save.shop.relics.find(x=>x.id===relicSelectedId) || null;
  $("buyRelicBtn").disabled = !sel || save.currency.karma < sel.cost || save.inventory.relics.some(x=>x.id===sel.id);
  $("equipRelicBtn").disabled = !sel || (!save.inventory.relics.some(x=>x.id===sel.id) && save.currency.karma < sel.cost);
}

$("buyWeaponBtn").onclick=()=>{
  const sel = save.shop.weapons.find(x=>x.id===weaponSelectedId) || null;
  if(!sel) return;
  if(save.currency.gold < sel.cost) return;
  if(save.inventory.weapons.some(x=>x.id===sel.id)) return;
  save.currency.gold -= sel.cost;
  save.inventory.weapons.push(sel);
  persist(); refreshTop();
  renderWeaponShop();
  renderDojoNinja();
};
$("equipWeaponBtn").onclick=()=>{
  const sel = save.shop.weapons.find(x=>x.id===weaponSelectedId) || null;
  if(!sel) return;

  if(!save.inventory.weapons.some(x=>x.id===sel.id)){
    if(save.currency.gold < sel.cost) return;
    save.currency.gold -= sel.cost;
    save.inventory.weapons.push(sel);
  }
  const a=activeNinja();
  a.equip.weaponId=sel.id;
  recalc(a);
  persist(); refreshTop();
  renderWeaponShop();
  renderDojoNinja();
};
$("refreshWeaponBtn").onclick=()=>{
  save.shop.weapons = Array.from({length:6}, ()=>makeWeapon());
  weaponSelectedId = save.shop.weapons[0]?.id || null;
  persist();
  renderWeaponShop();
};
$("closeWeapon").onclick=()=>closeModal("weaponModal");

$("buyRelicBtn").onclick=()=>{
  const sel = save.shop.relics.find(x=>x.id===relicSelectedId) || null;
  if(!sel) return;
  if(save.currency.karma < sel.cost) return;
  if(save.inventory.relics.some(x=>x.id===sel.id)) return;
  save.currency.karma -= sel.cost;
  save.inventory.relics.push(sel);
  persist(); refreshTop();
  renderRelicShop();
  renderDojoNinja();
};
$("equipRelicBtn").onclick=()=>{
  const sel = save.shop.relics.find(x=>x.id===relicSelectedId) || null;
  if(!sel) return;

  if(!save.inventory.relics.some(x=>x.id===sel.id)){
    if(save.currency.karma < sel.cost) return;
    save.currency.karma -= sel.cost;
    save.inventory.relics.push(sel);
  }
  const a=activeNinja();
  a.equip.relicId=sel.id;
  recalc(a);
  persist(); refreshTop();
  renderRelicShop();
  renderDojoNinja();
};
$("refreshRelicBtn").onclick=()=>{
  save.shop.relics = Array.from({length:6}, ()=>makeRelic());
  relicSelectedId = save.shop.relics[0]?.id || null;
  persist();
  renderRelicShop();
};
$("closeRelic").onclick=()=>closeModal("relicModal");

/* ---------- Profiles ---------- */
$("closeProfiles").onclick=()=>closeModal("profilesModal");

function slotSummary(slot){
  if(!slot) return "Empty slot";
  const a = slot.ninjas?.[0];
  if(!a) return "Empty slot";
  const spent = (a.base?.str-1||0)+(a.base?.agi-1||0)+(a.base?.end-1||0);
  const belt = beltFromSpent(spent);
  return `${slot.ninjas.length} ninjas â€¢ ${belt} â€¢ ðŸª™${slot.currency.gold} â€¢ â˜¯${slot.currency.karma}`;
}
function renderProfiles(){
  const list=$("profilesList");
  list.innerHTML="";

  for(const sname of ["slot1","slot2","slot3"]){
    const slot = profiles.slots[sname];
    const isActive = profiles.active===sname;

    const row=document.createElement("div");
    row.className="item";
    row.innerHTML=`
      <div>
        <div style="font-weight:1000">${sname.toUpperCase()} ${isActive?`<span class="pill">ACTIVE</span>`:""}</div>
        <div class="muted">${slotSummary(slot)}</div>
      </div>
      <div class="row">
        <button class="btn ghost small" data-load="${sname}">Load</button>
        <button class="btn ghost small" data-new="${sname}">${slot?"Reset":"Create"}</button>
      </div>
    `;
    list.appendChild(row);
  }

  list.querySelectorAll("button[data-load]").forEach(b=>{
    b.onclick=()=>{
      const sn=b.getAttribute("data-load");
      if(!profiles.slots[sn]) return;
      profiles.active=sn;
      save=profiles.slots[sn];
      persistProfiles();
      refreshTop();
      closeModal("profilesModal");
    };
  });

  list.querySelectorAll("button[data-new]").forEach(b=>{
    b.onclick=()=>{
      const sn=b.getAttribute("data-new");
      profiles.slots[sn]=defaultSlot();
      profiles.active=sn;
      save=profiles.slots[sn];
      persistProfiles();
      refreshTop();
      closeModal("profilesModal");
    };
  });
}

/* ---------- Daily meditation (30 min TP reward) ---------- */
$("dailyBtn").onclick=()=>{
  const now=Date.now();
  const last=save.daily?.lastClaim||0;
  const cd=30*60*1000;
  if(now-last < cd){
    const mins=Math.ceil((cd-(now-last))/60000);
    alert(`Come back in ${mins} min`);
    return;
  }
  const a=activeNinja();
  a.tp += 3; // reward
  save.daily.lastClaim = now;
  persist(); refreshTop();
  alert("+3 TP!");
};

/* ---------- Battle select (Step 2 placeholder) ---------- */
$("closeBattleSelect").onclick=()=>closeModal("battleSelectModal");
function renderBattleSelect(){
  const list=$("battleList");
  list.innerHTML="";

  const options=[
    {name:"Scout Clan (Easy)",desc:"Small enemy clan."},
    {name:"Rival Clan (Medium)",desc:"Balanced enemy clan."},
    {name:"Elite Clan (Hard)",desc:"Bigger enemy clan."},
    {name:"Boss Clan",desc:"Step 3 adds the real boss fight."},
  ];
  for(const o of options){
    const row=document.createElement("div");
    row.className="item";
    row.innerHTML=`
      <div>
        <div style="font-weight:1000">${o.name}</div>
        <div class="muted">${o.desc}</div>
      </div>
      <button class="btn primary small" data-battle="${o.name}">Select</button>
    `;
    list.appendChild(row);
  }
  list.querySelectorAll("button[data-battle]").forEach(b=>{
    b.onclick=()=>{
      closeModal("battleSelectModal");
      // show placeholder battle screen (to confirm battle.jpg loads)
      $("town").classList.add("hidden");
      $("battle").classList.remove("hidden");
    };
  });
}

/* ---------- Buildings ---------- */
$("hsHospital").onclick=()=>{
  const a=activeNinja(); recalc(a);
  a.hp=a.maxHP;
  persist(); refreshTop();
};

$("hsDojo").onclick=()=>{
  setDojoTab("train");
  renderDojoTraining();
  renderDojoNinja();
  openModal("dojoModal");
};

$("hsDaimyo").onclick=()=>{
  renderDaimyo();
  openModal("daiModal");
};

$("hsRecruit").onclick=()=>{
  rosterSelectedId = save.activeId;
  renderRoster();
  openModal("recruitModal");
};

$("hsWeapon").onclick=()=>{
  ensureWeaponStock();
  weaponSelectedId = save.shop.weapons[0]?.id || null;
  renderWeaponShop();
  openModal("weaponModal");
};

$("hsRelic").onclick=()=>{
  ensureRelicStock();
  relicSelectedId = save.shop.relics[0]?.id || null;
  renderRelicShop();
  openModal("relicModal");
};

$("hsFight").onclick=()=>{
  renderBattleSelect();
  openModal("battleSelectModal");
};

/* battle placeholder back */
$("battleBackBtn").onclick=()=>{
  $("battle").classList.add("hidden");
  $("town").classList.remove("hidden");
};

/* ---------- Top buttons ---------- */
$("profilesBtn").onclick=()=>{
  renderProfiles();
  openModal("profilesModal");
};

$("saveBtn").onclick=()=>{ persist(); refreshTop(); };

$("resetBtn").onclick=()=>{
  profiles.slots[profiles.active]=defaultSlot();
  save=profiles.slots[profiles.active];
  persistProfiles();
  refreshTop();
  alert("Slot reset!");
};

/* ---------- Init ---------- */
persist();
refreshTop();

</script>
</body>
</html>
