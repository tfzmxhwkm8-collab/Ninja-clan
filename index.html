<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Ninja Clan RPG</title>

<style>
html,body{margin:0;height:100%;overflow:hidden;background:#0f0f12;font-family:system-ui}
.hidden{display:none!important}
button{-webkit-tap-highlight-color:transparent}
:root{--wood:#8b5a2b;--paper:#f4e6c8}

/* TOP BAR */
#topbar{
 position:absolute;top:10px;left:10px;right:10px;
 background:var(--wood);color:#111;border-radius:14px;
 padding:8px;display:flex;justify-content:space-between;
 align-items:center;font-size:12px;z-index:50
}
.barL,.barR{display:flex;gap:6px;align-items:center}
.chip{background:rgba(255,255,255,.7);border-radius:999px;padding:4px 8px;font-weight:900}
.btn{border:0;border-radius:10px;padding:6px 10px;font-weight:900;background:#eee}
.btn.primary{background:#ff8a2a}
.btn.ghost{background:rgba(255,255,255,.4)}

/* TOWN */
#town{position:absolute;inset:0;padding-top:70px}
#townBg{position:absolute;inset:0;background:url("town.jpg") center top/cover no-repeat}
.hotspot{position:absolute;background:transparent;border:0}
.label{position:absolute;left:50%;bottom:10%;transform:translateX(-50%);
 background:rgba(255,255,255,.85);padding:6px 10px;border-radius:999px;font-weight:900}

/* BUILDINGS */
#hsHospital{left:2%;top:12%;width:35%;height:22%}
#hsDojo{left:65%;top:10%;width:33%;height:26%}
#hsDaimyo{left:33%;top:28%;width:34%;height:22%}
#hsRelic{left:4%;top:42%;width:30%;height:20%}
#hsWeapon{left:62%;top:34%;width:34%;height:22%}
#hsRecruit{left:6%;top:60%;width:36%;height:22%}
#hsFight{left:50%;top:52%;width:46%;height:22%}

/* MODALS */
.modal{position:absolute;inset:0;background:rgba(0,0,0,.45);
 display:flex;align-items:center;justify-content:center;z-index:100}
.card{background:var(--paper);border-radius:18px;padding:14px;width:94%;max-width:720px}
.row{display:flex;gap:8px;align-items:center}
.sp{justify-content:space-between}
.title{font-weight:900;font-size:16px}
.list{margin-top:10px;border-radius:12px;overflow:auto;background:rgba(255,255,255,.4)}
.item{padding:10px;border-bottom:1px solid rgba(0,0,0,.1)}
.item:last-child{border-bottom:0}

/* BATTLE */
#battle{position:absolute;inset:0;z-index:80}
#battleBg{position:absolute;inset:0;background:url("battle.jpg") center/cover no-repeat}
#battleCanvas{position:absolute;inset:0}

/* BELTS */
.belt{display:inline-block;width:16px;height:6px;border-radius:3px}
</style>
</head>

<body>

<div id="topbar">
  <div class="barL">
    <div class="chip" id="uiName">—</div>
    <div class="chip">Lv <b id="uiLevel">1</b></div>
    <div class="chip">HP <b id="uiHP">—</b></div>
    <div class="chip">TP <b id="uiTP">0</b></div>
    <div class="chip">Belt <b id="uiBelt">White</b></div>
  </div>
  <div class="barR">
    <button class="btn ghost" id="dailyBtn">Meditate</button>
    <button class="btn ghost" id="profileBtn">Profiles</button>
  </div>
</div>

<div id="town">
  <div id="townBg"></div>
  <button class="hotspot" id="hsHospital"><div class="label">Hospital</div></button>
  <button class="hotspot" id="hsDojo"><div class="label">Dojo</div></button>
  <button class="hotspot" id="hsDaimyo"><div class="label">Daimyo</div></button>
  <button class="hotspot" id="hsRelic"><div class="label">Relics</div></button>
  <button class="hotspot" id="hsWeapon"><div class="label">Weapons</div></button>
  <button class="hotspot" id="hsRecruit"><div class="label">Recruit</div></button>
  <button class="hotspot" id="hsFight"><div class="label">Battle</div></button>
</div>

<div id="battle" class="hidden">
  <div id="battleBg"></div>
  <canvas id="battleCanvas"></canvas>
</div>

<script>
<script>
/* ======================================================
   NINJA CLAN RPG — FULL ADVANCED GAME SCRIPT
   Restored battles + shops + dojo
====================================================== */

/* ---------- HELPERS ---------- */
const $ = id => document.getElementById(id);
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const rand = (a,b)=>a+Math.random()*(b-a);
const rint = (a,b)=>Math.floor(rand(a,b+1));
const pick = a=>a[Math.floor(Math.random()*a.length)];
const uid = p=>"id_"+p+"_"+Math.random().toString(16).slice(2);

/* ---------- BELTS ---------- */
const BELT_STEPS = [
  ["White",0,"#f5f5f5"],
  ["Yellow",5,"#ffd54a"],
  ["Orange",12,"#ff8a2a"],
  ["Green",20,"#37c76b"],
  ["Blue",40,"#3a82ff"],
  ["Brown",60,"#7a4b2a"],
  ["Black",80,"#111"]
];
function beltFromTP(tp){
  let b="White";
  for(const s of BELT_STEPS) if(tp>=s[1]) b=s[0];
  return b;
}
function beltColor(b){
  return BELT_STEPS.find(x=>x[0]===b)?.[2]||"#fff";
}

/* ---------- CORE DATA ---------- */
function makeNinja(name="Ninja"){
  return{
    id:uid("n"),name,
    base:{str:1,agi:1,end:1},
    tp:10,
    hp:60,maxHP:60,
    equip:{weapon:null,relic:null},
    derived:{}
  };
}
function defaultSave(){
  const n=makeNinja("Starter Ninja");
  return{
    ninjas:[n],
    activeId:n.id,
    gold:200,
    karma:50,
    inventory:{weapons:[],relics:[]},
    shop:{weapons:[],relics:[]},
    daily:{last:0},
    ladder:{wins:0,losses:0},
    bossDefeated:false
  };
}

/* ---------- PROFILES ---------- */
const PROFILE_KEY="ninja_clan_profiles_v2";
let profiles=JSON.parse(localStorage.getItem(PROFILE_KEY)||
  '{"active":"slot1","slots":{"slot1":null,"slot2":null,"slot3":null}}');
if(!profiles.slots.slot1){
  profiles.slots.slot1=defaultSave();
  profiles.active="slot1";
}
let save=profiles.slots[profiles.active];
function persist(){
  profiles.slots[profiles.active]=save;
  localStorage.setItem(PROFILE_KEY,JSON.stringify(profiles));
}

/* ---------- PROGRESSION ---------- */
function tpSpent(n){
  return (n.base.str-1)+(n.base.agi-1)+(n.base.end-1);
}
function trainingCost(v){
  if(v>=21) return 5;
  if(v>=16) return 4;
  if(v>=11) return 3;
  if(v>=6) return 2;
  return 1;
}
function recalc(n){
  const spent=tpSpent(n);
  n.level=1+spent;
  const STR=n.base.str+(n.equip.weapon?.bonus.str||0)+(n.equip.relic?.bonus.str||0);
  const AGI=n.base.agi+(n.equip.weapon?.bonus.agi||0)+(n.equip.relic?.bonus.agi||0);
  const END=n.base.end+(n.equip.weapon?.bonus.end||0)+(n.equip.relic?.bonus.end||0);
  n.maxHP=60+END*12+n.level*4;
  n.hp=clamp(n.hp,1,n.maxHP);
  n.derived={
    atk:Math.floor(6+STR*3+n.level*1.2),
    def:Math.floor(END+ n.level*0.6),
    spd:1+AGI*0.12,
    dodge:clamp(0.03+AGI*0.015,0,0.3)
  };
}
function active(){
  const n=save.ninjas.find(n=>n.id===save.activeId)||save.ninjas[0];
  recalc(n); return n;
}

/* ---------- DAILY ---------- */
$("dailyBtn").onclick=()=>{
  const now=Date.now();
  if(now-save.daily.last<30*60*1000)
    return alert("Meditation not ready yet");
  const b=beltFromTP(tpSpent(active()));
  const tp=b==="White"?1:b==="Yellow"?2:b==="Orange"?3:b==="Green"?4:5;
  active().tp+=tp;
  save.daily.last=now;
  persist();refreshTop();
  alert(`Meditation complete +${tp} TP`);
};

/* ---------- WEAPONS ---------- */
const WEAPON_TIERS=[
  {tier:"Common",str:2,agi:1,end:0,cost:60},
  {tier:"Uncommon",str:4,agi:3,end:1,cost:140},
  {tier:"Rare",str:7,agi:6,end:2,cost:320},
  {tier:"Epic",str:10,agi:10,end:3,cost:650},
  {tier:"Legendary",str:15,agi:15,end:5,cost:1200}
];
const WEAPON_NAMES=["Katana","Tanto","Naginata","War Fan","Iron Staff","Moon Blade","Storm Edge"];
function makeWeapon(){
  const t=WEAPON_TIERS[rint(0,WEAPON_TIERS.length-1)];
  return{
    id:uid("w"),
    name:pick(WEAPON_NAMES),
    tier:t.tier,
    bonus:{str:t.str,agi:t.agi,end:t.end},
    cost:t.cost
  };
}
function ensureWeaponShop(){
  if(!save.shop.weapons.length)
    save.shop.weapons=Array.from({length:6},makeWeapon);
}

/* ---------- RELICS ---------- */
function makeRelic(){
  return{
    id:uid("r"),
    name:pick(["Focus Charm","Shadow Bead","Lotus Token","Phoenix Feather"]),
    bonus:{str:rint(0,2),agi:rint(1,3),end:rint(1,3)},
    cost:80+rint(40,160)
  };
}
function ensureRelicShop(){
  if(!save.shop.relics.length)
    save.shop.relics=Array.from({length:6},makeRelic);
}

/* ---------- DOJO ---------- */
$("hsDojo").onclick=()=>{
  const n=active();
  const cost=trainingCost(n.base.str);
  if(n.tp<cost) return alert("Not enough TP");
  if(confirm(`Train STR for ${cost} TP?`)){
    n.tp-=cost; n.base.str++;
    recalc(n); persist(); refreshTop();
  }
};

/* ---------- RECRUIT ---------- */
$("hsRecruit").onclick=()=>{
  const cost=200+save.ninjas.length*100;
  if(save.gold<cost) return alert("Not enough gold");
  save.gold-=cost;
  save.ninjas.push(makeNinja("Clan Ninja"));
  persist();refreshTop();
};

/* ---------- SHOPS ---------- */
$("hsWeapon").onclick=()=>{
  ensureWeaponShop();
  const w=save.shop.weapons[0];
  if(confirm(`Buy ${w.name} (${w.tier}) for ${w.cost} gold?`)){
    if(save.gold<w.cost) return;
    save.gold-=w.cost;
    save.inventory.weapons.push(w);
    active().equip.weapon=w;
    save.shop.weapons.shift();
    persist();refreshTop();
  }
};
$("hsRelic").onclick=()=>{
  ensureRelicShop();
  const r=save.shop.relics[0];
  if(confirm(`Buy ${r.name} for ${r.cost} karma?`)){
    if(save.karma<r.cost) return;
    save.karma-=r.cost;
    save.inventory.relics.push(r);
    active().equip.relic=r;
    save.shop.relics.shift();
    persist();refreshTop();
  }
};

/* ---------- BATTLE ENGINE ---------- */
const battle=$("battle"), town=$("town");
const canvas=$("battleCanvas"), ctx=canvas.getContext("2d");
function resize(){
  canvas.width=innerWidth*devicePixelRatio;
  canvas.height=innerHeight*devicePixelRatio;
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
addEventListener("resize",resize);resize();

function generateEnemyClan(boss=false){
  if(boss){
    const b=makeNinja("Grandmaster Kuro");
    b.base={str:27,agi:26,end:26}; b.tp=0; recalc(b);
    return {name:"Black Belt Grandmaster",ninjas:[b],boss:true};
  }
  const size=rint(1,save.ninjas.length+2);
  const clan=[];
  for(let i=0;i<size;i++){
    const n=makeNinja("Enemy Ninja");
    n.base={str:rint(3,8),agi:rint(3,8),end:rint(3,8)};
    recalc(n); clan.push(n);
  }
  return {name:"Enemy Clan",ninjas:clan,boss:false};
}

function startBattle(clan){
  battle.classList.remove("hidden");
  town.classList.add("hidden");
  let pQ=save.ninjas.map(n=>({...n}));
  let eQ=clan.ninjas.map(n=>({...n}));

  function round(){
    if(!pQ.length||!eQ.length){
      endBattle(pQ.length>0,clan); return;
    }
    fight(pQ[0],eQ[0]);
  }

  function fight(p,e){
    recalc(p); recalc(e);
    p.hp=p.maxHP; e.hp=e.maxHP;
    const dmg=()=>Math.max(1,p.derived.atk-e.derived.def);
    const edmg=()=>Math.max(1,e.derived.atk-p.derived.def);
    while(p.hp>0&&e.hp>0){
      p.hp-=edmg(); e.hp-=dmg();
    }
    if(p.hp<=0) pQ.shift();
    if(e.hp<=0) eQ.shift();
    setTimeout(round,300);
  }
  round();
}

function endBattle(win,clan){
  battle.classList.add("hidden");
  town.classList.remove("hidden");
  if(win){
    save.gold+=clan.boss?1500:200;
    save.karma+=clan.boss?500:50;
    active().tp+=clan.boss?10:2;
    if(clan.boss) save.bossDefeated=true;
    alert("Victory!");
  }else{
    save.ladder.losses++;
    alert("Defeat...");
  }
  persist();refreshTop();
}

$("hsFight").onclick=()=>{
  const boss=!save.bossDefeated&&confirm("Fight Black Belt Grandmaster?");
  startBattle(generateEnemyClan(boss));
};

/* ---------- UI ---------- */
function refreshTop(){
  const n=active();
  $("uiName").textContent=n.name;
  $("uiLevel").textContent=n.level;
  $("uiHP").textContent=n.hp+"/"+n.maxHP;
  $("uiTP").textContent=n.tp;
  $("uiBelt").textContent=beltFromTP(tpSpent(n));
}
refreshTop();
persist();
</script>
</script>
</body>
</html>
