<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Ninja Town RPG</title>
<style>
  html,body{margin:0;width:100%;height:100%;overflow:hidden;background:#0f0f12;
    font-family:system-ui,-apple-system,Segoe UI,Roboto;touch-action:none;-webkit-user-select:none;user-select:none}
  :root{
    --pad-top: env(safe-area-inset-top);
    --pad-right: env(safe-area-inset-right);
    --pad-bottom: env(safe-area-inset-bottom);
    --pad-left: env(safe-area-inset-left);
    --wood1:#a56a3c; --wood2:#7a4b2a; --ink:#22140b; --accent:#ff7a18;
  }
  *{-webkit-tap-highlight-color:transparent}
  .hidden{display:none!important}

  /* Top bar */
  #topbar{
    position:absolute; z-index:20;
    left:calc(10px + var(--pad-left));
    right:calc(10px + var(--pad-right));
    top:calc(10px + var(--pad-top));
    display:flex; gap:10px; align-items:center; justify-content:space-between;
    background:linear-gradient(var(--wood1),var(--wood2));
    border:2px solid rgba(0,0,0,.18);
    border-radius:14px;
    padding:10px 12px;
    box-shadow:0 10px 24px rgba(0,0,0,.25);
    color:var(--ink);
  }
  .barL,.barR{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .chip{
    display:flex;gap:8px;align-items:center;
    background:rgba(255,255,255,.25);
    border:1px solid rgba(0,0,0,.14);
    border-radius:999px;
    padding:6px 10px;
    font-weight:950;font-size:12px;
  }
  .chip b{font-family:ui-monospace,Menlo,monospace}
  .btn{
    border:0;border-radius:12px;padding:10px 12px;font-weight:950;
    background:#eee;color:#111; box-shadow:0 6px 14px rgba(0,0,0,.18);
  }
  .btn.primary{background:var(--accent)}
  .btn.ghost{background:rgba(255,255,255,.25); border:1px solid rgba(0,0,0,.14);}
  .btn.small{padding:8px 10px;font-size:12px;border-radius:11px}
  .btn:disabled{opacity:.55}

  /* ====== TOWN SCREEN (uses your screenshot) ====== */
  #town{
    position:absolute; inset:0;
    padding-top:calc(64px + var(--pad-top));
  }
  #townBg{
    position:absolute; inset:0;
    background-image:url("town.jpg"); /* <-- upload your town screenshot to repo as town.jpg */
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
    filter:saturate(1.05);
  }

  /* Hotspots overlay (tap areas). Adjust if you want tighter hitboxes. */
  .hotspot{
    position:absolute; z-index:5;
    border-radius:18px;
    background:rgba(255,255,255,.08);
    border:2px solid rgba(255,255,255,.16);
    box-shadow:0 12px 20px rgba(0,0,0,.18);
    backdrop-filter:blur(2px);
    display:flex; align-items:flex-end; justify-content:center;
    padding:10px;
  }
  .hotspot span{
    background:rgba(255,255,255,.68);
    border:1px solid rgba(0,0,0,.12);
    padding:6px 10px;border-radius:999px;font-size:12px;
    font-weight:1000;color:#1a0f08;
  }
  /* positions tuned for iPhone based on your image */
  #hsDaimyo{left:5%; top:16%; width:24%; height:18%}
  #hsHospital{left:34%; top:24%; width:22%; height:18%}
  #hsRelic{left:52%; top:18%; width:26%; height:20%}
  #hsWeapon{left:70%; top:30%; width:26%; height:20%}
  #hsRecruit{left:14%; top:54%; width:28%; height:20%}
  #hsDojo{left:44%; top:60%; width:22%; height:18%}
  #hsFight{left:70%; top:74%; width:26%; height:20%;
    background:rgba(255,122,24,.16); border-color:rgba(255,122,24,.30)}

  /* ====== MODALS ====== */
  .modal{
    position:absolute; inset:0; z-index:50;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.35);
    padding:14px;
  }
  .card{
    width:min(660px,96%);
    background:linear-gradient(#f7edd6,#f0e0bf);
    border:2px solid rgba(0,0,0,.18);
    border-radius:18px;
    padding:14px;
    box-shadow:0 20px 50px rgba(0,0,0,.28);
    color:#23140b;
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .sp{justify-content:space-between}
  .title{margin:0;font-size:16px;font-weight:1000}
  .muted{opacity:.78;font-size:12px;line-height:1.25}
  .statGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .stat{
    background:rgba(255,255,255,.35);
    border:1px solid rgba(0,0,0,.12);
    border-radius:14px;
    padding:10px 12px;
    font-size:12px;
  }
  .stat b{font-family:ui-monospace,Menlo,monospace;font-size:13px}
  .list{
    margin-top:10px;
    max-height:320px; overflow:auto;
    border-radius:14px;
    border:1px solid rgba(0,0,0,.14);
    background:rgba(255,255,255,.22);
  }
  .item{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.10);
    font-size:12px;
  }
  .item:last-child{border-bottom:0}
  .pill{
    display:inline-block;
    padding:4px 8px;border-radius:999px;
    background:rgba(255,255,255,.55);
    border:1px solid rgba(0,0,0,.10);
    font-size:11px;font-weight:950;
  }
  .rar{font-weight:1000}
  .rar.Common{color:#555}
  .rar.Uncommon{color:#0d7a1c}
  .rar.Rare{color:#1a63c8}
  .rar.Epic{color:#7a2ac9}
  .rar.Legendary{color:#b06b00}

  /* ====== BATTLE SCREEN (uses your screenshot) ====== */
  #battle{
    position:absolute; inset:0; z-index:30;
  }
  #battleBg{
    position:absolute; inset:0;
    background-image:url("battle.jpg"); /* <-- upload your battle screenshot to repo as battle.jpg */
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
    transform:scale(1.02);
  }
  #battleShade{
    position:absolute; inset:0;
    background:linear-gradient(rgba(0,0,0,.00), rgba(0,0,0,.10));
  }
  #battleCanvas{position:absolute; inset:0; width:100%; height:100%}

  /* Top VS bars */
  #battleTop{
    position:absolute; z-index:40;
    left:calc(10px + var(--pad-left));
    right:calc(10px + var(--pad-right));
    top:calc(10px + var(--pad-top));
    display:flex;gap:10px;align-items:center;justify-content:space-between;
  }
  .hpBox{
    flex:1 1 0;
    background:linear-gradient(var(--wood1),var(--wood2));
    border:2px solid rgba(0,0,0,.18);
    border-radius:14px;
    padding:10px 12px;
    box-shadow:0 10px 24px rgba(0,0,0,.22);
    color:var(--ink);
    min-width:0;
  }
  .hpName{font-weight:1000;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .hpBar{
    height:12px;border-radius:999px;background:rgba(0,0,0,.18);
    overflow:hidden;margin-top:6px;border:1px solid rgba(0,0,0,.12);
  }
  .hpFill{height:100%; width:100%; background:linear-gradient(#ffb845,#ff7a18);}
  .vs{font-weight:1000;font-size:22px;color:#fff;text-shadow:0 4px 10px rgba(0,0,0,.35);padding:0 10px}

  #skipBtn{
    position:absolute; z-index:40;
    top:calc(78px + var(--pad-top));
    left:50%; transform:translateX(-50%);
    background:rgba(255,255,255,.75);
    border:2px solid rgba(0,0,0,.18);
    border-radius:12px; padding:10px 14px; font-weight:1000;
  }
</style>
</head>

<body>
  <div id="topbar">
    <div class="barL">
      <div class="chip">Active <b id="uiName">â€”</b></div>
      <div class="chip">HP <b id="uiHP">â€”</b></div>
      <div class="chip">â˜¯ <b id="uiKarma">0</b></div>
      <div class="chip">ðŸª™ <b id="uiGold">0</b></div>
      <div class="chip">Belt <b id="uiBelt">White</b></div>
      <div class="chip">Tier <b id="uiTier">1</b></div>
    </div>
    <div class="barR">
      <button class="btn ghost small" id="saveBtn">Save</button>
      <button class="btn ghost small" id="resetBtn">Reset</button>
    </div>
  </div>

  <!-- Town -->
  <div id="town">
    <div id="townBg"></div>
    <div class="hotspot" id="hsDaimyo"><span>Daimyo</span></div>
    <div class="hotspot" id="hsHospital"><span>Hospital</span></div>
    <div class="hotspot" id="hsRelic"><span>Relic Shop</span></div>
    <div class="hotspot" id="hsWeapon"><span>Weapon Shop</span></div>
    <div class="hotspot" id="hsRecruit"><span>Recruit</span></div>
    <div class="hotspot" id="hsDojo"><span>Dojo</span></div>
    <div class="hotspot" id="hsFight"><span>Fight</span></div>
  </div>

  <!-- Battle -->
  <div id="battle" class="hidden">
    <div id="battleBg"></div>
    <div id="battleShade"></div>
    <canvas id="battleCanvas"></canvas>

    <div id="battleTop">
      <div class="hpBox">
        <div class="hpName" id="pName">You</div>
        <div class="hpBar"><div class="hpFill" id="pHPFill"></div></div>
      </div>
      <div class="vs">VS</div>
      <div class="hpBox">
        <div class="hpName" id="eName">Enemy</div>
        <div class="hpBar"><div class="hpFill" id="eHPFill"></div></div>
      </div>
    </div>

    <button id="skipBtn" class="btn">SKIP</button>
  </div>

  <!-- Modals -->
  <div class="modal hidden" id="dojoModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Dojo Training</h3>
        <button class="btn ghost small" id="closeDojo">Close</button>
      </div>
      <div class="muted">Train your active ninja in 3 stats. No skills/specials. Pure RPG growth.</div>

      <div class="statGrid">
        <div class="stat">Strength<br><b id="stSTR">1</b><div class="muted">Damage</div></div>
        <div class="stat">Agility<br><b id="stAGI">1</b><div class="muted">Speed / Dodge</div></div>
        <div class="stat">Endurance<br><b id="stEND">1</b><div class="muted">HP / Defense</div></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="trainSTR">+ STR (1 TP)</button>
        <button class="btn primary" id="trainAGI">+ AGI (1 TP)</button>
        <button class="btn primary" id="trainEND">+ END (1 TP)</button>
      </div>

      <div class="muted" style="margin-top:10px">
        TP: <b id="tpHere">0</b> â€¢ Active: <b id="activeHere">â€”</b>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="daiModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Daimyo</h3>
        <button class="btn ghost small" id="closeDai">Close</button>
      </div>
      <div class="muted">Belts are earned by XP (from fights). Ladders raise Tier difficulty.</div>
      <div class="statGrid">
        <div class="stat">Belt<br><b id="dBelt">White</b></div>
        <div class="stat">XP<br><b id="dXP">0</b></div>
        <div class="stat">Next Belt XP<br><b id="dNext">50</b></div>
      </div>
      <div class="muted" style="margin-top:10px">
        Tier: <b id="dTier">1</b> â€¢ Tier wins: <b id="dTierWins">0</b> â€¢ Total W/L: <b id="dWL">0/0</b>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="recruitModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Recruit Ninjas</h3>
        <button class="btn ghost small" id="closeRecruit">Close</button>
      </div>
      <div class="muted" id="recruitLockText"></div>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="recruitBtn">Recruit (ðŸª™ <span id="recruitCost">120</span>)</button>
        <button class="btn ghost" id="setActiveBtn">Set Selected Active</button>
      </div>

      <div class="list" id="rosterList"></div>
      <div class="muted" style="margin-top:10px">Recruit unlocks at <b>Yellow belt</b>.</div>
    </div>
  </div>

  <div class="modal hidden" id="weaponModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Weapon Shop</h3>
        <button class="btn ghost small" id="closeWeapon">Close</button>
      </div>
      <div class="muted">Buy weapons with ðŸª™ Gold. Equip 1 weapon on the active ninja.</div>

      <div class="row" style="margin-top:10px">
        <button class="btn ghost" id="buyWeaponBtn">Buy Selected</button>
        <button class="btn ghost" id="equipWeaponBtn">Equip Selected</button>
      </div>

      <div class="list" id="weaponList"></div>
    </div>
  </div>

  <div class="modal hidden" id="relicModal">
    <div class="card">
      <div class="row sp">
        <h3 class="title">Relic Shop</h3>
        <button class="btn ghost small" id="closeRelic">Close</button>
      </div>
      <div class="muted">Buy relics with â˜¯ Karma. Equip 1 relic on the active ninja.</div>

      <div class="row" style="margin-top:10px">
        <button class="btn ghost" id="buyRelicBtn">Buy Selected</button>
        <button class="btn ghost" id="equipRelicBtn">Equip Selected</button>
      </div>

      <div class="list" id="relicList"></div>
    </div>
  </div>

<script>
/* =========================
   SAVE + RPG CORE
========================= */
const SAVE_KEY="ninja_town_rpg_v2";

const BELTS=["White","Yellow","Orange","Green","Blue","Brown","Black"];
const BELT_XP=[0,50,150,350,700,1200,2000]; // adjust anytime

const RARITIES=["Common","Uncommon","Rare","Epic","Legendary"];
const RARITY_COL={
  Common:"Common", Uncommon:"Uncommon", Rare:"Rare", Epic:"Epic", Legendary:"Legendary"
};

function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function rint(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }
function pick(a){ return a[Math.floor(Math.random()*a.length)]; }
function id(prefix="id"){ return prefix+"_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16); }

function beltFromXP(xp){
  let idx=0;
  for(let i=0;i<BELT_XP.length;i++) if(xp>=BELT_XP[i]) idx=i;
  return BELTS[Math.min(idx,BELTS.length-1)];
}
function nextBeltXP(xp){
  for(let i=1;i<BELT_XP.length;i++) if(xp < BELT_XP[i]) return BELT_XP[i];
  return BELT_XP[BELT_XP.length-1];
}

function defaultSave(){
  const starter = makeNinja("Starter Ninja");
  return {
    gold: 80,
    karma: 0,
    tier: 1,
    tierWins: 0,
    wins: 0,
    losses: 0,
    roster: [starter],
    activeId: starter.id,
    inventory: [], // items you own
  };
}
let save = loadSave();
function loadSave(){
  try{
    const raw=localStorage.getItem(SAVE_KEY);
    if(!raw) return defaultSave();
    const s=JSON.parse(raw);
    if(!s?.roster?.length) return defaultSave();
    s.gold ??= 0; s.karma ??= 0;
    s.tier ??= 1; s.tierWins ??= 0;
    s.wins ??= 0; s.losses ??= 0;
    s.inventory ??= [];
    if(!s.activeId) s.activeId = s.roster[0].id;
    // ensure shape
    for(const n of s.roster){
      n.str ??= 1; n.agi ??= 1; n.end ??= 1;
      n.xp ??= 0; n.level ??= 1;
      n.weaponId ??= null; n.relicId ??= null;
      recalcNinja(n, s.inventory);
    }
    return s;
  }catch{ return defaultSave(); }
}
function persist(){ localStorage.setItem(SAVE_KEY, JSON.stringify(save)); }

function makeNinja(name){
  return {
    id: id("n"),
    name,
    xp: 0,
    level: 1,
    tp: 0,
    str: 1,
    agi: 1,
    end: 1,
    hp: 60,
    maxHP: 60,
    weaponId: null,
    relicId: null,
  };
}

function recalcNinja(n, inventory){
  n.level = 1 + Math.floor(n.xp / 100);
  const gear = getEquippedBonuses(n, inventory);
  const endEff = n.end + gear.end;
  n.maxHP = 55 + endEff*12 + n.level*6;
  n.hp = clamp(n.hp ?? n.maxHP, 0, n.maxHP);
}

function getActive(){
  return save.roster.find(x=>x.id===save.activeId) || save.roster[0];
}

function itemBonus(it){
  // items: {slot:"weapon"/"relic", rarity, bonus:{str,agi,end}}
  return it?.bonus || {str:0,agi:0,end:0};
}
function getEquippedBonuses(n, inventory){
  const w = inventory.find(it=>it.id===n.weaponId) || null;
  const r = inventory.find(it=>it.id===n.relicId) || null;
  const wb = itemBonus(w);
  const rb = itemBonus(r);
  return { str:(wb.str+rb.str), agi:(wb.agi+rb.agi), end:(wb.end+rb.end) };
}

/* =========================
   UI HELPERS
========================= */
const $ = (id)=>document.getElementById(id);
function openModal(id){ $(id).classList.remove("hidden"); }
function closeModal(id){ $(id).classList.add("hidden"); }
function fmtWL(){ return `${save.wins}/${save.losses}`; }

function refreshTop(){
  const a=getActive();
  recalcNinja(a, save.inventory);
  const belt=beltFromXP(a.xp);

  $("uiName").textContent = a.name;
  $("uiHP").textContent = `${a.hp}/${a.maxHP}`;
  $("uiGold").textContent = save.gold;
  $("uiKarma").textContent = save.karma;
  $("uiBelt").textContent = belt;
  $("uiTier").textContent = save.tier;
}

$("saveBtn").onclick=()=>{ persist(); refreshTop(); };
$("resetBtn").onclick=()=>{
  localStorage.removeItem(SAVE_KEY);
  save = defaultSave();
  persist(); refreshTop();
};

/* =========================
   HOTSPOTS
========================= */
$("hsDojo").onclick=()=>{
  refreshDojo();
  openModal("dojoModal");
};
$("closeDojo").onclick=()=>closeModal("dojoModal");

$("hsDaimyo").onclick=()=>{
  const a=getActive();
  $("dBelt").textContent = beltFromXP(a.xp);
  $("dXP").textContent = a.xp;
  $("dNext").textContent = nextBeltXP(a.xp);
  $("dTier").textContent = save.tier;
  $("dTierWins").textContent = save.tierWins;
  $("dWL").textContent = fmtWL();
  openModal("daiModal");
};
$("closeDai").onclick=()=>closeModal("daiModal");

$("hsHospital").onclick=()=>{
  const a=getActive();
  a.hp = a.maxHP;
  persist(); refreshTop();
};

$("hsRecruit").onclick=()=>{
  refreshRecruit();
  openModal("recruitModal");
};
$("closeRecruit").onclick=()=>closeModal("recruitModal");

$("hsWeapon").onclick=()=>{
  refreshWeaponShop();
  openModal("weaponModal");
};
$("closeWeapon").onclick=()=>closeModal("weaponModal");

$("hsRelic").onclick=()=>{
  refreshRelicShop();
  openModal("relicModal");
};
$("closeRelic").onclick=()=>closeModal("relicModal");

$("hsFight").onclick=()=>startBattle();

/* =========================
   DOJO (3 stats only)
========================= */
function refreshDojo(){
  const a=getActive();
  const inv=save.inventory;
  recalcNinja(a, inv);

  const gear=getEquippedBonuses(a, inv);
  $("stSTR").textContent = `${a.str} (+${gear.str})`;
  $("stAGI").textContent = `${a.agi} (+${gear.agi})`;
  $("stEND").textContent = `${a.end} (+${gear.end})`;
  $("tpHere").textContent = a.tp;
  $("activeHere").textContent = a.name;

  const can = a.tp>0;
  $("trainSTR").disabled=!can;
  $("trainAGI").disabled=!can;
  $("trainEND").disabled=!can;
}
function train(stat){
  const a=getActive();
  if(a.tp<=0) return;
  a.tp -= 1;
  a[stat] += 1;
  recalcNinja(a, save.inventory);
  persist(); refreshTop(); refreshDojo();
}
$("trainSTR").onclick=()=>train("str");
$("trainAGI").onclick=()=>train("agi");
$("trainEND").onclick=()=>train("end");

/* =========================
   RECRUIT (unlocks at Yellow belt)
========================= */
let recruitSelectedId=null;
function recruitCost(){
  // scales a bit by roster size + tier
  return 120 + (save.roster.length-1)*60 + (save.tier-1)*25;
}
function refreshRecruit(){
  const a=getActive();
  const belt=beltFromXP(a.xp);
  const unlocked = (BELTS.indexOf(belt) >= BELTS.indexOf("Yellow"));

  $("recruitCost").textContent = recruitCost();
  $("recruitBtn").disabled = !unlocked;
  $("setActiveBtn").disabled = !unlocked;

  $("recruitLockText").innerHTML = unlocked
    ? `Recruit is unlocked. Tap a ninja to select, then set active.`
    : `Locked until <b>Yellow belt</b>. Win fights to earn XP.`;

  const list=$("rosterList");
  list.innerHTML="";
  for(const n of save.roster){
    const isActive = (n.id===save.activeId);
    const isSel = (n.id===recruitSelectedId);

    const d=document.createElement("div");
    d.className="item";
    d.innerHTML = `
      <div style="min-width:0">
        <div style="font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
          ${n.name} ${isActive?`<span class="pill">ACTIVE</span>`:""} ${isSel?`<span class="pill">SELECTED</span>`:""}
        </div>
        <div class="muted">Lvl ${n.level} â€¢ XP ${n.xp} â€¢ TP ${n.tp}</div>
      </div>
      <button class="btn small ghost">Select</button>
    `;
    d.onclick=()=>{ recruitSelectedId=n.id; refreshRecruit(); };
    list.appendChild(d);
  }
}
$("recruitBtn").onclick=()=>{
  const a=getActive();
  const belt=beltFromXP(a.xp);
  const unlocked = (BELTS.indexOf(belt) >= BELTS.indexOf("Yellow"));
  if(!unlocked) return;

  const cost = recruitCost();
  if(save.gold < cost) return;

  save
